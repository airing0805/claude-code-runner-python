# Claude Code Runner å¼€å‘æ–‡æ¡£

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

1. å®‰è£… Python 3.10+
2. å®‰è£… uv åŒ…ç®¡ç†å™¨
3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
ANTHROPIC_API_KEY=your-api-key
WORKING_DIR=/path/to/your/project
HOST=127.0.0.1
PORT=8000
```

### å®‰è£…ä¾èµ–

```bash
uv sync
```

### å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼ 1: ç›´æ¥è¿è¡Œ
uv run python -m app.main

# æ–¹å¼ 2: ä½¿ç”¨ uvicornï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
uv run uvicorn app.main:app --reload
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run pytest tests/ -v

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡
uv run pytest tests/ -v --cov=app
```

---

## é¡¹ç›®ç»“æ„

```
claude-code-runner/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ claude_runner/       # Claude Code SDK å°è£…
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ client.py
â”‚   â”œâ”€â”€ routers/             # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ task.py
â”‚   â”‚   â”œâ”€â”€ session.py
â”‚   â”‚   â””â”€â”€ status.py
â”‚   â”œâ”€â”€ templates/           # Web ç•Œé¢æ¨¡æ¿ï¼ˆå·²è¿ç§»åˆ° web ç›®å½•ï¼‰
â”‚   â””â”€â”€ static/              # é™æ€æ–‡ä»¶ï¼ˆå·²è¿ç§»åˆ° web ç›®å½•ï¼‰
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â””â”€â”€ index.html       # Web ç•Œé¢æ¨¡æ¿
â”‚   â””â”€â”€ static/
â”‚       â”œâ”€â”€ style.css        # æ ·å¼æ–‡ä»¶
â”‚       â””â”€â”€ app.js           # å‰ç«¯äº¤äº’é€»è¾‘
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_runner.py       # å•å…ƒæµ‹è¯•
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ éœ€æ±‚æ–‡æ¡£.md      # éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ APIæ¥å£.md               # API æ–‡æ¡£
â”‚   â””â”€â”€ å¼€å‘æŒ‡å—.md       # å¼€å‘æ–‡æ¡£
â”œâ”€â”€ .env.example             # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ pyproject.toml           # é¡¹ç›®é…ç½®
â””â”€â”€ CLAUDE.md                # Claude Code é¡¹ç›®æŒ‡å¯¼
```

---

## æ ¸å¿ƒç»„ä»¶

### ClaudeCodeClient (`app/claude_runner/client.py`)

å°è£… Claude Code SDKï¼Œæä¾›ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼š

```python
from app.claude_runner import ClaudeCodeClient

# åˆ›å»ºå®¢æˆ·ç«¯
client = ClaudeCodeClient(
    working_dir="/path/to/project",
    allowed_tools=["Read", "Write", "Edit", "Bash"],
    permission_mode="acceptEdits",
    continue_conversation=False,
    resume=None
)

# åŒæ­¥æ‰§è¡Œ
result = await client.run("åˆ—å‡ºæ‰€æœ‰ Python æ–‡ä»¶")
print(result.message)

# æµå¼æ‰§è¡Œ
async for msg in client.run_stream("åˆ†æé¡¹ç›®ç»“æ„"):
    print(f"[{msg.type.value}] {msg.content}")
```

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `run(prompt)` | åŒæ­¥æ‰§è¡Œï¼Œè¿”å› TaskResult |
| `run_stream(prompt)` | æµå¼æ‰§è¡Œï¼Œå¼‚æ­¥è¿­ä»£å™¨ |

#### æ•°æ®ç»“æ„

```python
# æµå¼æ¶ˆæ¯
@dataclass
class StreamMessage:
    type: MessageType      # æ¶ˆæ¯ç±»å‹
    content: str           # å†…å®¹
    timestamp: str         # æ—¶é—´æˆ³
    tool_name: str         # å·¥å…·åç§°ï¼ˆå¯é€‰ï¼‰
    tool_input: dict       # å·¥å…·è¾“å…¥ï¼ˆå¯é€‰ï¼‰
    metadata: dict         # å…ƒæ•°æ®

# ä»»åŠ¡ç»“æœ
@dataclass
class TaskResult:
    success: bool
    message: str
    session_id: str
    cost_usd: float
    duration_ms: int
    files_changed: list[str]
    tools_used: list[str]
```

### FastAPI åº”ç”¨ (`app/main.py`)

æä¾› REST API å’Œ Web ç•Œé¢ï¼š

```python
# å…³é”®è·¯ç”±
@app.post("/api/task")              # åŒæ­¥ä»»åŠ¡
@app.post("/api/task/stream")       # æµå¼ä»»åŠ¡
@app.get("/api/projects")           # é¡¹ç›®åˆ—è¡¨
@app.get("/api/projects/{name}/sessions")  # ä¼šè¯åˆ—è¡¨
@app.get("/api/sessions/{id}/messages")    # ä¼šè¯æ¶ˆæ¯
```

---

## æ·»åŠ æ–°åŠŸèƒ½

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. åœ¨ `app/main.py` ä¸­å®šä¹‰è·¯ç”±ï¼š

```python
@app.get("/api/custom")
async def custom_endpoint():
    return {"result": "success"}
```

2. å¦‚æœéœ€è¦æ–°çš„è¯·æ±‚æ¨¡å‹ï¼Œæ·»åŠ  Pydantic æ¨¡å‹ï¼š

```python
class CustomRequest(BaseModel):
    param1: str
    param2: Optional[int] = None
```

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

1. åœ¨ `app/claude_runner/client.py` ä¸­æ‰©å±• `MessageType` æšä¸¾ï¼š

```python
class MessageType(Enum):
    TEXT = "text"
    TOOL_USE = "tool_use"
    # æ·»åŠ æ–°ç±»å‹
    CUSTOM = "custom"
```

2. åœ¨ `run_stream` æ–¹æ³•ä¸­å¤„ç†æ–°ç±»å‹ï¼š

```python
if custom_condition:
    stream_msg = StreamMessage(
        type=MessageType.CUSTOM,
        content="è‡ªå®šä¹‰å†…å®¹"
    )
```

3. åœ¨å‰ç«¯ `app/static/app.js` ä¸­å¤„ç†ï¼š

```javascript
handleStreamMessage(data) {
    switch (data.type) {
        case 'custom':
            this.addMessage('custom', data.content);
            break;
    }
}
```

### æ·»åŠ æ–°çš„èœå•é¡¹

1. åœ¨ `app/templates/index.html` ä¸­æ·»åŠ èœå•ï¼š

```html
<div class="nav-item" data-view="new-view">
    <span class="nav-icon">ğŸ†•</span>
    <span class="nav-text">æ–°åŠŸèƒ½</span>
</div>
```

2. æ·»åŠ å¯¹åº”è§†å›¾é¢æ¿ï¼š

```html
<div class="view-panel" id="view-new-view">
    <!-- è§†å›¾å†…å®¹ -->
</div>
```

3. åœ¨ `app/static/app.js` ä¸­å¤„ç†åˆ‡æ¢é€»è¾‘ã€‚

---

## ä¼šè¯å­˜å‚¨æœºåˆ¶

### å­˜å‚¨ä½ç½®

ä¼šè¯è®°å½•å­˜å‚¨åœ¨ Claude Code çš„é¡¹ç›®ç›®å½•ï¼š

```
~/.claude/projects/<encoded-path>/*.jsonl
```

### è·¯å¾„ç¼–ç è§„åˆ™

- Windows: `E:\workspaces\project` â†’ `E--workspaces-project`
- Unix: `/home/user/project` â†’ `-home-user-project`

### ä¼šè¯æ–‡ä»¶æ ¼å¼

æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼š

```json
{"type": "user", "message": {...}, "timestamp": "...", "sessionId": "..."}
{"type": "assistant", "message": {...}, "timestamp": "..."}
```

---

## æ ·å¼å¼€å‘

### CSS å˜é‡

```css
:root {
    --primary-color: #7c3aed;
    --primary-hover: #6d28d9;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --bg-color: #0f172a;
    --card-bg: #1e293b;
    --text-color: #e2e8f0;
    --text-muted: #94a3b8;
    --border-color: #334155;
}
```

### å“åº”å¼æ–­ç‚¹

```css
@media (max-width: 768px) {
    /* ç§»åŠ¨ç«¯æ ·å¼ */
}
```

---

## è°ƒè¯•æŠ€å·§

### åç«¯è°ƒè¯•

```python
# åœ¨ main.py ä¸­æ·»åŠ æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)
```

### å‰ç«¯è°ƒè¯•

```javascript
// åœ¨ app.js ä¸­ä½¿ç”¨ console
console.log('Debug info:', data);
```

### æŸ¥çœ‹ SSE æµ

```bash
curl -N http://127.0.0.1:8000/api/task/stream \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test"}'
```

---

## å¸¸è§é—®é¢˜

### Q: ä»»åŠ¡æ‰§è¡Œæ—¶çœ‹ä¸åˆ°è¾“å‡ºï¼Ÿ

æ£€æŸ¥ SSE è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç¡®ä¿ä½¿ç”¨äº† `-N` å‚æ•°ï¼ˆcurlï¼‰æˆ–æ­£ç¡®å¤„ç†æµå¼å“åº”ã€‚

### Q: ä¼šè¯ ID æ— æ³•æ¢å¤ï¼Ÿ

ç¡®è®¤ä¼šè¯ ID æ­£ç¡®ï¼Œæ£€æŸ¥ `~/.claude/projects/` ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä¼šè¯æ–‡ä»¶ã€‚

### Q: å·¥å…·è¢«æ‹’ç»ï¼Ÿ

æ£€æŸ¥ `allowed_tools` å‚æ•°ï¼Œç¡®ä¿åŒ…å«éœ€è¦çš„å·¥å…·ã€‚ä¹Ÿå¯ä»¥è®¾ç½® `permission_mode="bypassPermissions"`ã€‚

---

## å‘å¸ƒæ¸…å•

- [ ] æ›´æ–°ç‰ˆæœ¬å·
- [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿é€šè¿‡
- [ ] æ›´æ–°æ–‡æ¡£
- [ ] æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
- [ ] åˆ›å»º Git æ ‡ç­¾
