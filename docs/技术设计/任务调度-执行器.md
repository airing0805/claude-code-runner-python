# 任务调度 - 任务执行器设计

> 本文档定义任务执行器的设计，包括执行流程、超时控制、状态机、重试机制和错误处理。

## 1. 执行器职责

任务执行器 (`TaskExecutor`) 负责执行单个任务，核心职责包括：

- 调用 ClaudeCodeClient 执行任务
- 超时控制机制
- 任务状态跟踪
- 失败重试机制
- 错误信息收集

## 2. 执行流程设计

### 2.1 主执行流程

```
                    ┌───────────────────┐
                    │   验证任务有效性    │
                    └──────────┬────────┘
                               │
                    ┌──────────┴──────────┐
                    │                     │
              验证失败                 验证成功
                    │                     │
                    ▼                     ▼
          返回失败结果          ┌───────────────────┐
                               │  设置执行状态      │
                               └──────────┬────────┘
                                          │
                                          ▼
                               ┌───────────────────┐
                               │  更新状态为        │
                               │  RUNNING          │
                               └──────────┬────────┘
                                          │
                                          ▼
                               ┌───────────────────┐
                               │  带超时执行任务    │
                               └──────────┬────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    ▼                     ▼                     ▼
             ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
             │  执行成功    │       │  执行失败    │       │  执行超时    │
             └──────┬──────┘       └──────┬──────┘       └──────┬──────┘
                    │                     │                     │
                    ▼                     ▼                     ▼
             ┌─────────────┐       ┌─────────────────────────────────┐
             │ COMPLETED   │       │         _handle_retry()          │
             └─────────────┘       └──────────────┬──────────────────┘
                                                    │
                                        ┌──────────┴──────────┐
                                        │                     │
                                  可重试               不可重试
                                        │                     │
                                        ▼                     ▼
                                 ┌─────────────┐     ┌─────────────┐
                                 │ PENDING     │     │ FAILED      │
                                 │ (重新入队)   │     │ (保存历史)   │
                                 └─────────────┘     └─────────────┘
```

### 2.2 任务验证

验证项：
- prompt 不能为空
- 超时时间范围 (1秒 - 1小时)

### 2.3 执行状态管理

| 状态 | 类型 | 说明 |
|------|------|------|
| `_is_executing` | bool | 是否正在执行任务 |
| `_current_task` | Task \| None | 当前执行中的任务 |

## 3. 超时控制机制

### 3.1 超时实现

使用 `asyncio.wait_for` 实现超时控制

### 3.2 超时配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| DEFAULT_TIMEOUT | 600000 | 默认超时（10分钟） |
| 最小超时 | 1000 | 最小超时（1秒） |
| 最大超时 | 3600000 | 最大超时（1小时） |

## 4. 状态机转换设计

### 4.1 状态转换规则

| 当前状态 | 可转换到 |
|----------|----------|
| PENDING | RUNNING, CANCELLED |
| RUNNING | COMPLETED, FAILED, PENDING(重试), CANCELLED |
| FAILED | PENDING(手动重试), CANCELLED |
| COMPLETED | (终态) |
| CANCELLED | (终态) |

## 5. 重试策略设计

### 5.1 重试条件

| 错误类型 | 可重试 |
|----------|--------|
| TRANSIENT (临时性) | 是 |
| TIMEOUT (超时) | 是 |
| RESOURCE (资源) | 是 |
| PERMANENT (永久性) | 否 |
| USER_CANCEL (用户取消) | 否 |
| VALIDATION (验证) | 否 |

### 5.2 重试限制

| 配置项 | 值 |
|--------|-----|
| MAX_RETRIES | 2 |
| BASE_DELAY | 5.0秒 |
| MAX_DELAY | 60.0秒 |
| JITTER | ±10% |

### 5.3 指数退避算法

```
delay = base_delay * 2^retry_count
delay = min(delay, max_delay)
delay = delay ± (delay * jitter * random)
```

| 重试次数 | 基础延迟 |
|----------|----------|
| 1 | ~10s |
| 2 | ~20s |
| 3 | ~40s |

## 6. 错误收集和分类

### 6.1 错误类型

- TRANSIENT: 临时性错误
- PERMANENT: 永久性错误
- TIMEOUT: 超时错误
- USER_CANCEL: 用户取消
- VALIDATION: 验证错误
- RESOURCE: 资源错误

### 6.2 错误严重级别

- LOW: 轻微
- MEDIUM: 中等
- HIGH: 严重
- CRITICAL: 致命

### 6.3 错误收集器

```python
@dataclass
class ExecutionError:
    type: str
    message: str
    severity: ErrorSeverity
    retryable: bool
    timestamp: str
    stack_trace: str | None
    context: dict
```

## 7. 执行结果

| 执行结果 | 状态变更 | 存储位置 |
|----------|----------|----------|
| 成功 | RUNNING → COMPLETED | completed.json |
| 失败(不可重试) | RUNNING → FAILED | failed.json |
| 失败(可重试) | RUNNING → PENDING | queue.json |

## 8. 并发控制

执行器同一时间只执行一个任务

## 9. 日志记录

| 事件 | 级别 |
|------|------|
| 任务开始 | INFO |
| 任务完成 | INFO |
| 任务失败 | ERROR |
| 任务重试 | INFO |

## 10. 配置参考

| 配置项 | 默认值 |
|--------|--------|
| DEFAULT_TIMEOUT | 600000 |
| MAX_RETRIES | 2 |
| BASE_DELAY | 5.0 |
| MAX_DELAY | 60.0 |
| JITTER | 0.1 |

## 11. 相关文档

- 任务调度-核心设计.md
- 任务调度-数据模型.md
- 任务调度-存储层.md
- 任务调度-调度器.md
