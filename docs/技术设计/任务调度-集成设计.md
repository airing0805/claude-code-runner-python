# 任务调度 - ClaudeCodeClient 集成设计

> 本文档定义任务调度系统与 ClaudeCodeClient 的集成设计，包括客户端适配接口、结果解析方案和错误处理映射。

## 1. 集成概述

任务调度系统通过 TaskExecutor 调用 ClaudeCodeClient 执行任务。集成层负责：

- 将 Task 数据模型转换为 ClaudeCodeClient 调用参数
- 解析 ClaudeCodeClient 执行结果并更新 Task 状态
- 映射错误类型以支持重试决策

## 2. 客户端适配接口设计

### 2.1 ClaudeCodeClient 接口

ClaudeCodeClient 提供两种执行模式：

| 方法 | 返回类型 | 适用场景 |
|------|----------|----------|
| run(prompt) | TaskResult | 同步执行，返回完整结果 |
| run_stream(prompt) | AsyncIterator[StreamMessage] | 流式执行，实时返回消息 |

### 2.2 客户端初始化参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| working_dir | str | . | 工作目录 |
| allowed_tools | list[str] | None | 允许使用的工具列表 |
| permission_mode | PermissionMode | acceptEdits | 权限模式 |
| continue_conversation | bool | False | 继续会话 |
| resume | str | None | 恢复会话 ID |

### 2.3 Task 到 ClaudeCodeClient 参数映射

| Task 字段 | ClaudeCodeClient 参数 | 转换规则 |
|-----------|----------------------|----------|
| workspace | working_dir | 直接映射 |
| allowed_tools | allowed_tools | 直接映射 |
| auto_approve | permission_mode | True -> acceptEdits, False -> default |

### 2.4 权限模式说明

| 模式 | 说明 | 使用场景 |
|------|------|----------|
| default | 默认模式，需要用户确认 | 普通任务 |
| acceptEdits | 自动批准编辑操作 | auto_approve=True 的任务 |
| plan | 计划模式 | 预览任务（暂未使用） |
| bypassPermissions | 绕过权限检查 | 系统任务（谨慎使用） |

### 2.5 工具默认列表

当 allowed_tools 为 None 时，使用默认工具列表：

DEFAULT_TOOLS = [Read, Write, Edit, Bash, Glob, Grep]

## 3. 结果解析方案

### 3.1 TaskResult 结构

ClaudeCodeClient.run() 返回 TaskResult：

- success: bool - 执行是否成功
- message: str - 结果消息
- session_id: str | None - 会话 ID
- cost_usd: float | None - 消耗费用（美元）
- duration_ms: int | None - 执行耗时（毫秒）
- files_changed: list[str] - 变更的文件列表
- tools_used: list[str] - 使用的工具列表

### 3.2 TaskResult 到 Task 映射

| TaskResult 字段 | Task 字段 | 说明 |
|-----------------|-----------|------|
| success | status | True -> COMPLETED, False -> 进入重试流程 |
| message | result.message | 结果消息 |
| cost_usd | cost_usd | 费用记录 |
| duration_ms | duration_ms | 耗时记录 |
| files_changed | files_changed | 文件变更列表 |
| tools_used | tools_used | 工具使用列表 |

### 3.3 流式消息类型

run_stream() 返回的 StreamMessage 类型：

| MessageType | 说明 | 调度器处理 |
|-------------|------|------------|
| TEXT | 文本内容 | 收集用于最终消息 |
| TOOL_USE | 工具调用 | 记录工具使用 |
| TOOL_RESULT | 工具结果 | 记录文件变更 |
| THINKING | 思考过程 | 暂不处理 |
| ERROR | 错误 | 标记执行失败 |
| COMPLETE | 完成 | 提取元数据 |
| ASK_USER_QUESTION | 用户问答 | 调度器场景不使用 |

### 3.4 执行结果构建

ExecutionResult 结构：
- success: bool
- message: str
- cost_usd: float | None
- duration_ms: int | None
- files_changed: list[str]
- tools_used: list[str]
- error: str | None

### 3.5 结果状态判定逻辑

TaskResult.success:
- True -> _handle_success() -> status = COMPLETED -> 保存到 completed.json
- False -> _handle_failure() -> 进入重试流程

## 4. 错误处理映射

### 4.1 错误类型枚举

- TRANSIENT: 临时性错误（可重试）
- PERMANENT: 永久性错误（不可重试）
- TIMEOUT: 超时错误（可重试）
- USER_CANCEL: 用户取消（不可重试）
- VALIDATION: 验证错误（不可重试）
- RESOURCE: 资源错误（可重试）

### 4.2 错误分类规则

通过 classify_error() 函数根据异常信息分类：

1. 超时错误：asyncio.TimeoutError 或 timeout 关键词
2. 资源错误：rate limit, connection, network, unavailable
3. 验证错误：invalid, validation, not found, permission
4. 默认：临时性错误

### 4.3 错误关键词映射表

| 关键词 | 错误类型 | 可重试 |
|--------|----------|--------|
| timeout, TimeoutError | TIMEOUT | 是 |
| rate limit, 429 | RESOURCE | 是 |
| connection, network | RESOURCE | 是 |
| unavailable, 503 | RESOURCE | 是 |
| invalid, validation | VALIDATION | 否 |
| not found, 404 | VALIDATION | 否 |
| permission, 403 | VALIDATION | 否 |
| 其他 | TRANSIENT | 是 |

### 4.4 重试判断逻辑

should_retry(task, error_type):
1. 检查重试次数：task.retries >= MAX_RETRIES (2) -> 不可重试
2. 检查错误类型：error_type in RETRYABLE_ERRORS -> 可重试

RETRYABLE_ERRORS = {TRANSIENT, TIMEOUT, RESOURCE}

### 4.5 错误严重级别

- LOW: 轻微错误，可继续
- MEDIUM: 中等错误，需要重试
- HIGH: 严重错误，需要人工介入
- CRITICAL: 致命错误，系统问题

### 4.6 错误信息收集

ExecutionError 结构：
- type: str - 错误类型名称
- message: str - 错误消息
- severity: ErrorSeverity - 严重级别
- retryable: bool - 是否可重试
- timestamp: str - 时间戳
- stack_trace: str | None - 堆栈信息
- context: dict - 上下文信息（task_id 等）

## 5. 集成流程

### 5.1 完整执行流程

TaskExecutor.execute(task):
1. _validate_task(task) - 验证 prompt、timeout
2. 更新状态为 RUNNING
3. _execute_with_client(task):
   - 创建 ClaudeCodeClient（使用 task 配置初始化）
   - client.run(task.prompt) - 带超时控制
   - 构建 ExecutionResult
4. 结果处理:
   - success -> _handle_success() -> status = COMPLETED
   - failure -> _handle_failure() -> _handle_retry()
     - 可重试 -> status = PENDING（重新入队）
     - 不可重试 -> status = FAILED
   - timeout -> _handle_timeout() -> _handle_retry()

### 5.2 异常处理流程

Exception 发生:
1. ErrorCollector.add() - 收集错误信息
2. classify_error() - 确定错误类型
3. should_retry():
   - True -> 重新入队（PENDING）-> 计算 retry_delay
   - False -> 标记失败（FAILED）-> 保存到 failed.json

## 6. 超时控制

### 6.1 超时实现

使用 asyncio.wait_for 包装客户端调用，timeout=task.timeout / 1000.0（毫秒转秒）

### 6.2 超时配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Task.timeout 默认值 | 600000 | 10 分钟 |
| 最小超时 | 1000 | 1 秒 |
| 最大超时 | 3600000 | 1 小时 |

### 6.3 超时处理

超时触发 asyncio.TimeoutError：
1. 创建 TimeoutError 异常
2. ErrorCollector 收集错误信息
3. classify_error 返回 ErrorType.TIMEOUT
4. should_retry 返回 True（可重试）
5. 重新入队等待重试

## 7. 工具使用跟踪

### 7.1 自动跟踪机制

ClaudeCodeClient 内部自动跟踪工具使用：
- 记录工具使用：tool_name 添加到 _tools_used
- 跟踪文件变更：Write/Edit 操作的 file_path 添加到 _files_changed

### 7.2 跟踪的工具

| 工具 | 记录内容 |
|------|----------|
| Read | tools_used |
| Write | tools_used, files_changed |
| Edit | tools_used, files_changed |
| Bash | tools_used |
| Glob | tools_used |
| Grep | tools_used |

## 8. 配置常量

| 常量 | 值 | 说明 |
|------|-----|------|
| DEFAULT_TIMEOUT | 600000 | 默认超时（毫秒） |
| MAX_RETRIES | 2 | 最大重试次数 |
| BASE_DELAY | 5.0 | 重试基础延迟（秒） |
| MAX_DELAY | 60.0 | 重试最大延迟（秒） |
| JITTER | 0.1 | 重试延迟抖动因子 |

## 9. 相关文档

- 任务调度-核心设计.md
- 任务调度-执行器.md
- 任务调度-数据模型.md
- CLAUDE.md（项目说明）
