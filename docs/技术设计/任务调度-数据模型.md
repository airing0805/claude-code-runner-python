# 任务调度 - 数据模型设计

> 本文档定义任务调度系统的数据模型设计。

## 1. Task 数据结构

### 1.1 字段定义

```python
from dataclasses import dataclass, field
from typing import Optional
from datetime import datetime

@dataclass
class Task:
    """任务数据结构"""
    id: str                                    # 任务唯一标识 (UUID)
    prompt: str                                # 任务描述/提示词
    workspace: str = "."                       # 工作目录
    timeout: int = 600000                      # 超时时间（毫秒）
    auto_approve: bool = False                 # 是否自动批准工具操作
    allowed_tools: Optional[list[str]] = None  # 允许使用的工具列表
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())  # 创建时间
    started_at: Optional[str] = None           # 开始执行时间
    finished_at: Optional[str] = None         # 结束时间
    retries: int = 0                           # 当前重试次数
    status: "TaskStatus" = field(default_factory=lambda: TaskStatus.PENDING)  # 任务状态
    scheduled: bool = False                    # 是否来自定时任务
    scheduled_id: Optional[str] = None         # 定时任务ID（如果来自定时任务）
    result: Optional[dict] = None              # 执行结果
    error: Optional[str] = None                # 错误信息（失败时）
    files_changed: list[str] = field(default_factory=list)   # 变更的文件列表
    tools_used: list[str] = field(default_factory=list)      # 使用过的工具列表
    cost_usd: Optional[float] = None            # 消耗费用（美元）
    duration_ms: Optional[int] = None          # 执行耗时（毫秒）
```

### 1.2 字段说明

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | str | 是 | - | UUID 格式的任务唯一标识 |
| prompt | str | 是 | - | 任务描述文本 |
| workspace | str | 否 | "." | 执行任务的工作目录 |
| timeout | int | 否 | 600000 | 超时时间（毫秒），默认 10 分钟 |
| auto_approve | bool | 否 | False | 是否自动批准工具操作 |
| allowed_tools | list[str] \| None | 否 | None | 允许使用的工具列表，None 表示无限制 |
| created_at | str | 是 | ISO 时间 | 任务创建时间 |
| started_at | str \| None | 否 | None | 任务开始执行时间 |
| finished_at | str \| None | 否 | None | 任务结束时间 |
| retries | int | 否 | 0 | 当前重试次数 |
| status | TaskStatus | 否 | PENDING | 任务状态 |
| scheduled | bool | 否 | False | 是否来自定时任务 |
| scheduled_id | str \| None | 否 | None | 关联的定时任务 ID |
| result | dict \| None | 否 | None | 执行结果详情 |
| error | str \| None | 否 | None | 错误信息 |
| files_changed | list[str] | 否 | [] | 变更的文件路径列表 |
| tools_used | list[str] | 否 | [] | 使用过的工具名称列表 |
| cost_usd | float \| None | 否 | None | 消耗费用（美元） |
| duration_ms | int \| None | 否 | None | 执行耗时（毫秒） |

---

## 2. ScheduledTask 数据结构

### 2.1 字段定义

```python
from dataclasses import dataclass, field
from typing import Optional

@dataclass
class ScheduledTask:
    """定时任务数据结构"""
    id: str                                    # 任务唯一标识 (UUID)
    name: str                                  # 任务名称
    prompt: str                                # 任务描述/提示词
    workspace: str = "."                       # 工作目录
    cron: str                                  # Cron 表达式
    timeout: int = 600000                      # 超时时间（毫秒）
    auto_approve: bool = False                 # 是否自动批准工具操作
    allowed_tools: Optional[list[str]] = None  # 允许使用的工具列表
    enabled: bool = True                       # 是否启用
    last_run: Optional[str] = None             # 上次执行时间
    next_run: Optional[str] = None             # 下次执行时间
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())  # 创建时间
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())  # 更新时间
    run_count: int = 0                         # 已执行次数
```

### 2.2 字段说明

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | str | 是 | - | UUID 格式的定时任务唯一标识 |
| name | str | 是 | - | 定时任务名称 |
| prompt | str | 是 | - | 任务描述文本 |
| workspace | str | 否 | "." | 执行任务的工作目录 |
| cron | str | 是 | - | Cron 表达式 |
| timeout | int | 否 | 600000 | 超时时间（毫秒） |
| auto_approve | bool | 否 | False | 是否自动批准工具操作 |
| allowed_tools | list[str] \| None | 否 | None | 允许使用的工具列表 |
| enabled | bool | 否 | True | 是否启用 |
| last_run | str \| None | 否 | None | 上次执行时间 |
| next_run | str \| None | 否 | None | 下次执行时间 |
| created_at | str | 是 | ISO 时间 | 创建时间 |
| updated_at | str | 是 | ISO 时间 | 最后更新时间 |
| run_count | int | 否 | 0 | 已成功执行次数 |

---

## 3. TaskStatus 枚举

### 3.1 枚举定义

```python
from enum import Enum

class TaskStatus(Enum):
    """任务状态枚举"""
    PENDING = "pending"        # 待执行
    RUNNING = "running"        # 运行中
    COMPLETED = "completed"    # 已完成
    FAILED = "failed"          # 失败
    CANCELLED = "cancelled"    # 已取消
```

### 3.2 状态说明

| 状态 | 值 | 说明 | 可转换到 |
|------|-----|------|----------|
| PENDING | pending | 任务在队列中等待执行 | RUNNING, CANCELLED |
| RUNNING | running | 任务正在执行中 | PENDING (重试), COMPLETED, FAILED, CANCELLED |
| COMPLETED | completed | 任务成功完成 | - |
| FAILED | failed | 任务执行失败 | PENDING (重试), CANCELLED |
| CANCELLED | cancelled | 任务被用户取消 | - |

---

## 4. JSON 存储格式

### 4.1 数据文件列表

| 文件 | 用途 | 数据类型 |
|------|------|----------|
| data/queue.json | 待执行任务队列 | Task[] |
| data/scheduled.json | 定时任务配置 | ScheduledTask[] |
| data/running.json | 当前运行任务 | Task[] |
| data/completed.json | 已完成任务历史 | Task[] |
| data/failed.json | 失败任务记录 | Task[] |

### 4.2 queue.json 格式

```json
{
  "tasks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "prompt": "分析项目结构",
      "workspace": "/path/to/workspace",
      "timeout": 600000,
      "auto_approve": false,
      "allowed_tools": ["Read", "Glob", "Grep"],
      "created_at": "2024-01-15T10:00:00Z",
      "started_at": null,
      "finished_at": null,
      "retries": 0,
      "status": "pending",
      "scheduled": false,
      "scheduled_id": null,
      "result": null,
      "error": null,
      "files_changed": [],
      "tools_used": [],
      "cost_usd": null,
      "duration_ms": null
    }
  ]
}
```

### 4.3 scheduled.json 格式

```json
{
  "tasks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "name": "每日代码检查",
      "prompt": "运行代码检查并报告问题",
      "workspace": "/path/to/workspace",
      "cron": "0 9 * * *",
      "timeout": 600000,
      "auto_approve": false,
      "allowed_tools": null,
      "enabled": true,
      "last_run": "2024-01-14T09:00:00Z",
      "next_run": "2024-01-15T09:00:00Z",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-14T09:00:00Z",
      "run_count": 14
    }
  ]
}
```

### 4.4 completed.json / failed.json 格式

```json
{
  "tasks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "prompt": "分析项目结构",
      "workspace": "/path/to/workspace",
      "timeout": 600000,
      "auto_approve": false,
      "allowed_tools": ["Read", "Glob"],
      "created_at": "2024-01-15T10:00:00Z",
      "started_at": "2024-01-15T10:00:05Z",
      "finished_at": "2024-01-15T10:05:00Z",
      "retries": 0,
      "status": "completed",
      "scheduled": true,
      "scheduled_id": "550e8400-e29b-41d4-a716-446655440001",
      "result": {
        "success": true,
        "message": "任务执行完成"
      },
      "error": null,
      "files_changed": ["src/main.py", "src/utils.py"],
      "tools_used": ["Read", "Glob", "Grep", "Edit"],
      "cost_usd": 0.025,
      "duration_ms": 295000
    }
  ]
}
```

---

## 5. 分页数据结构

### 5.1 分页请求参数

```python
from typing import Optional

class PaginationParams:
    """分页请求参数"""
    page: int = 1                    # 页码（从 1 开始）
    limit: int = 20                  # 每页数量（默认 20，最大 100）
```

### 5.2 分页响应结构

```python
from typing import Generic, TypeVar, Generic, Optional
from dataclasses import dataclass

T = TypeVar("T")

@dataclass
class PaginatedResponse(Generic[T]):
    """分页响应结构"""
    items: list[T]           # 当前页数据
    total: int               # 总记录数
    page: int                # 当前页码
    limit: int               # 每页数量
    pages: int               # 总页数
```

### 5.3 分页响应示例

```json
{
  "items": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "prompt": "任务描述",
      "status": "completed",
      "created_at": "2024-01-15T10:00:00Z",
      "finished_at": "2024-01-15T10:05:00Z",
      "duration_ms": 300000,
      "cost_usd": 0.015
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20,
  "pages": 8
}
```

### 5.4 分页计算公式

```python
# 计算偏移量
offset = (page - 1) * limit

# 计算总页数
pages = (total + limit - 1) // limit

# 分页查询示例
def get_completed_tasks(page: int = 1, limit: int = 20):
    offset = (page - 1) * limit
    tasks = load_completed_tasks()
    total = len(tasks)
    items = tasks[offset:offset + limit]
    return PaginatedResponse(
        items=items,
        total=total,
        page=page,
        limit=limit,
        pages=(total + limit - 1) // limit
    )
```

---

## 6. API 请求/响应模型

### 6.1 创建任务请求

```python
class CreateTaskRequest(BaseModel):
    """创建任务请求"""
    prompt: str = Field(..., min_length=1, max_length=10000, description="任务描述")
    workspace: Optional[str] = Field(".", description="工作目录")
    timeout: Optional[int] = Field(600000, ge=1000, le=3600000, description="超时时间（毫秒）")
    auto_approve: Optional[bool] = Field(False, description="是否自动批准工具操作")
    allowed_tools: Optional[list[str]] = Field(None, description="允许使用的工具列表")
```

### 6.2 创建定时任务请求

```python
class CreateScheduledTaskRequest(BaseModel):
    """创建定时任务请求"""
    name: str = Field(..., min_length=1, max_length=100, description="任务名称")
    prompt: str = Field(..., min_length=1, max_length=10000, description="任务描述")
    workspace: Optional[str] = Field(".", description="工作目录")
    cron: str = Field(..., description="Cron 表达式")
    timeout: Optional[int] = Field(600000, ge=1000, le=3600000, description="超时时间（毫秒）")
    auto_approve: Optional[bool] = Field(False, description="是否自动批准工具操作")
    allowed_tools: Optional[list[str]] = Field(None, description="允许使用的工具列表")
    enabled: Optional[bool] = Field(True, description="是否启用")
```

### 6.3 任务响应模型

```python
class TaskResponse(BaseModel):
    """任务响应模型"""
    id: str
    prompt: str
    workspace: str
    timeout: int
    auto_approve: bool
    allowed_tools: Optional[list[str]]
    created_at: str
    started_at: Optional[str]
    finished_at: Optional[str]
    retries: int
    status: str
    scheduled: bool
    scheduled_id: Optional[str]
    files_changed: list[str]
    tools_used: list[str]
    cost_usd: Optional[float]
    duration_ms: Optional[int]
    error: Optional[str]
```

---

## 7. 调度器状态模型

### 7.1 调度器状态枚举

```python
class SchedulerStatus(Enum):
    """调度器状态"""
    STOPPED = "stopped"    # 已停止
    RUNNING = "running"    # 运行中
    STARTING = "starting"  # 启动中
    STOPPING = "stopping"  # 停止中
```

### 7.2 调度器状态响应

```python
class SchedulerStatusResponse(BaseModel):
    """调度器状态响应"""
    status: str                         # 调度器状态
    queue_count: int                    # 队列中任务数
    running_count: int                  # 运行中任务数
    scheduled_count: int                # 定时任务数
    enabled_scheduled_count: int        # 已启用的定时任务数
    started_at: Optional[str]           # 启动时间
    last_poll: Optional[str]           # 最后轮询时间
```

### 7.3 调度器状态响应示例

```json
{
  "status": "running",
  "queue_count": 3,
  "running_count": 1,
  "scheduled_count": 5,
  "enabled_scheduled_count": 4,
  "started_at": "2024-01-15T10:00:00Z",
  "last_poll": "2024-01-15T10:05:00Z"
}
```

---

## 8. 数据模型关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          数据模型关系                                  │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────┐         ┌─────────────────┐
│  ScheduledTask  │         │      Task       │
├─────────────────┤         ├─────────────────┤
│ id              │         │ id              │
│ name            │         │ prompt          │
│ cron            │         │ status          │
│ enabled         │         │ scheduled_id    │──┐
│ next_run        │         │ ...             │  │
│ last_run        │         └─────────────────┘  │
│ ...             │                              │
└────────┬────────┘                              │
         │                                       │
         │ 定时任务到期                           │ 创建
         │ 生成任务                               │
         ▼                                       ▼
┌─────────────────────────────────────────────────────────────┐
│                        任务状态流转                              │
└─────────────────────────────────────────────────────────────┘

   PENDING ──► RUNNING ──► COMPLETED
     │          │
     │          ├──► FAILED ──► PENDING (重试)
     │          │
     │          └──► CANCELLED
     │
     └──► CANCELLED
```

---

## 9. 字段命名规范

| 命名风格 | 使用场景 |
|----------|----------|
| snake_case | JSON 文件中的键名、数据库字段 |
| PascalCase | Python 类名、枚举值 |
| camelCase | API 请求/响应中的字段（由 Pydantic 自动转换） |

### 9.1 Pydantic 模型配置

```python
from pydantic import BaseModel, ConfigDict

class TaskModel(BaseModel):
    """Task API 模型 - 使用 camelCase"""
    model_config = ConfigDict(
        populate_by_name=False,  # 使用 alias
    )

    id: str
    prompt: str
    workspace: str = "."
    timeout: int = 600000
    auto_approve: bool = False
    allowed_tools: Optional[list[str]] = None
    created_at: str
    # ... 其他字段
```

---

## 10. 验证规则

### 10.1 Task 验证

| 字段 | 验证规则 |
|------|----------|
| id | UUID v4 格式 |
| prompt | 非空，最大 10000 字符 |
| workspace | 有效目录路径 |
| timeout | 1000-3600000 毫秒 |
| status | 必须是 TaskStatus 枚举值 |
| retries | >= 0 |

### 10.2 ScheduledTask 验证

| 字段 | 验证规则 |
|------|----------|
| id | UUID v4 格式 |
| name | 非空，最大 100 字符 |
| prompt | 非空，最大 10000 字符 |
| cron | 有效的 Cron 表达式 |
| workspace | 有效目录路径 |
| timeout | 1000-3600000 毫秒 |
| enabled | 布尔值 |

### 10.3 分页验证

| 参数 | 验证规则 |
|------|----------|
| page | >= 1，默认 1 |
| limit | 1-100，默认 20 |
