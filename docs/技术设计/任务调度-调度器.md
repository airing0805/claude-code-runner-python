# 任务调度 - 主调度器设计

> 本文档定义主调度器的设计，包括轮询循环、任务获取、并发控制、启动/停止机制和状态管理。

## 1. 调度器职责

主调度器 (`Scheduler`) 是任务调度系统的核心控制器，负责：

- 定时轮询循环（默认 10 秒）
- 检查定时任务到期
- 从队列获取任务执行
- 管理任务状态迁移
- 启动/停止调度器
- 调度器状态管理

## 2. 轮询循环设计

### 2.1 主循环流程

调度器启动后进入主循环，执行以下步骤：

1. 检查定时任务是否到期
2. 处理任务队列中的任务
3. 等待轮询间隔

### 2.2 轮询间隔配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| POLL_INTERVAL | 10 | 轮询间隔（秒） |

### 2.3 循环内部处理顺序

每次轮询执行两个核心操作：

1. `_check_scheduled_tasks()` - 检查定时任务到期
2. `_process_queue()` - 处理任务队列

## 3. 任务获取策略

### 3.1 定时任务到期检查

遍历所有启用的定时任务，检查 `next_run` 是否已过期。

### 3.2 定时任务触发流程

1. 创建 Task 对象（继承定时任务的配置）
2. 加入任务队列
3. 更新定时任务的执行信息和下次执行时间

### 3.3 队列任务获取

- FIFO（先进先出）策略
- 单任务执行模式
- 非阻塞获取

## 4. 并发控制策略

### 4.1 单任务执行模式

调度器采用单任务执行模式，确保：

- 资源可控（API 调用、内存使用）
- 状态一致性（避免竞争条件）
- 错误隔离（任务失败不影响其他任务）

### 4.2 并发控制实现

执行器状态检查：`is_executing()` 返回 False 时才获取新任务。

## 5. 启动/停止机制设计

### 5.1 调度器状态

| 状态 | 说明 |
|------|------|
| STOPPED | 已停止 |
| RUNNING | 运行中 |
| STARTING | 启动中 |
| STOPPING | 停止中 |

### 5.2 启动流程

1. 检查当前状态（非 RUNNING 才可启动）
2. 设置 STARTING 状态
3. 创建 asyncio.Task 执行循环
4. 设置 RUNNING 状态

### 5.3 停止流程

1. 设置 STOPPING 状态
2. 发送停止信号（Event.set()）
3. 等待调度任务结束（最多 5 秒）
4. 超时则强制取消任务
5. 设置 STOPPED 状态

### 5.4 优雅停止

| 场景 | 处理方式 |
|------|----------|
| 空闲状态 | 立即停止 |
| 正在执行任务 | 等待当前任务完成 |
| 等待超时（5秒） | 强制取消调度任务 |

## 6. 状态管理方案

### 6.1 调度器状态信息

| 字段 | 类型 | 说明 |
|------|------|------|
| status | string | 调度器状态 |
| poll_interval | int | 轮询间隔（秒） |
| queue_count | int | 队列任务数量 |
| scheduled_count | int | 定时任务总数 |
| enabled_scheduled_count | int | 启用的定时任务数量 |
| running_count | int | 运行中任务数量 |
| is_executing | bool | 执行器是否正在执行 |
| current_task_id | string | 当前执行的任务 ID |
| updated_at | string | 状态更新时间 |

### 6.2 全局单例模式

使用全局单例确保调度器实例唯一：

- `get_scheduler()` - 获取单例
- `start_scheduler()` - 启动
- `stop_scheduler()` - 停止
- `get_scheduler_status()` - 获取状态

## 7. 错误处理

### 7.1 循环异常处理

捕获循环中的异常，记录日志后继续下一次循环。

### 7.2 任务执行异常处理

确保异常情况下任务状态被正确处理：
- 状态设为 FAILED
- 从运行列表移除
- 保存到失败历史

## 8. 日志记录

| 事件 | 级别 |
|------|------|
| 调度器启动/停止 | INFO |
| 定时任务到期 | INFO |
| 任务加入队列 | INFO |
| 任务执行成功/失败 | INFO/WARNING |
| 循环异常 | ERROR |

## 9. 配置参考

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| POLL_INTERVAL | 10 | 轮询间隔（秒） |
| 停止等待超时 | 5 | 停止时等待任务结束的超时（秒） |

## 10. 相关文档

- 任务调度-核心设计.md
- 任务调度-执行器.md
- 任务调度-存储层.md
- 任务调度-Cron解析.md
