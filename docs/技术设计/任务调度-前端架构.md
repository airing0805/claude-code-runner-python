# 任务调度 - 前端架构设计

> 本文档定义任务调度系统的前端架构，包括模块划分、状态管理、路由设计和组件层次结构。

## 1. 架构概述

### 1.1 设计原则

任务调度前端架构遵循以下原则：

1. **模块化**：按功能拆分为独立模块，降低耦合
2. **单例模式**：使用对象字面量定义模块，全局唯一实例
3. **状态集中管理**：所有状态存储在模块的 `state` 对象中
4. **事件委托**：使用事件委托减少事件绑定数量
5. **声明式渲染**：数据驱动 UI 更新

### 1.2 技术栈

- **无框架**：使用原生 JavaScript（ES6+）
- **无构建**：直接在浏览器中运行
- **样式**：原生 CSS + CSS 变量
- **模板**：Jinja2（服务端渲染）+ JavaScript 字符串模板

### 1.3 系统架构图

\`\`\`
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ClaudeCodeRunner                                  │
│                            (web/static/app.js)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐            │
│  │  Navigation    │    │     Task       │    │    History     │            │
│  │  (路由导航)     │    │   (任务执行)    │    │   (历史记录)    │            │
│  └────────────────┘    └────────────────┘    └────────────────┘            │
│                                                                              │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐            │
│  │ ClaudeStatus   │    │  MCPManager    │    │   Scheduler    │            │
│  │  (状态监控)     │    │   (MCP管理)    │    │  (任务调度)     │◄── 本模块   │
│  └────────────────┘    └────────────────┘    └────────────────┘            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             Scheduler Module                                 │
│                         (web/static/modules/scheduler.js)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   State Layer   │  │   View Layer    │  │   API Layer     │             │
│  │   (状态管理)     │  │   (视图渲染)     │  │   (API调用)     │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
\`\`\`

## 2. 模块划分设计

### 2.1 模块结构

\`\`\`
web/static/
├── app.js                    # 应用入口，初始化所有模块
├── utils.js                  # 通用工具函数
├── constants.js              # 常量定义（视图枚举等）
├── css/
│   └── components.css        # 组件样式
└── modules/
    ├── navigation.js         # 路由导航模块
    ├── task.js               # 任务执行模块
    ├── history.js            # 历史记录模块
    ├── scheduler.js          # 任务调度模块 ◄── 核心模块
    └── toolsMultiselect.js   # 工具多选组件
\`\`\`

### 2.2 模块职责

| 模块 | 职责 | 依赖 |
|------|------|------|
| \`app.js\` | 应用入口，初始化所有模块 | 所有模块 |
| \`navigation.js\` | 视图切换、路由处理 | \`constants.js\` |
| \`scheduler.js\` | 任务调度核心逻辑 | \`utils.js\`, \`constants.js\` |
| \`toolsMultiselect.js\` | 工具多选组件 | 无 |

### 2.3 Scheduler 模块内部结构

\`\`\`javascript
const Scheduler = {
    // ============ 状态层 ============
    state: { ... },

    // ============ 配置 ============
    REFRESH_INTERVAL_MS: 5000,
    DURATION_UPDATE_MS: 1000,

    // ============ 生命周期 ============
    init() { ... },
    onShow() { ... },
    onHide() { ... },

    // ============ 事件绑定 ============
    bindEvents() { ... },

    // ============ 数据加载 ============
    loadSchedulerStatus() { ... },
    loadQueue() { ... },
    // ...

    // ============ 渲染方法 ============
    renderSchedulerStatus() { ... },
    renderQueue() { ... },
    // ...

    // ============ 操作方法 ============
    startScheduler() { ... },
    stopScheduler() { ... },
    // ...
};
\`\`\`

## 3. 状态管理方案

### 3.1 状态结构

\`\`\`javascript
state: {
    // 调度器状态
    scheduler: {
        isRunning: false,       // 是否运行中
        lastCheckTime: null,    // 上次检查时间
    },

    // 统计信息
    stats: {
        queueCount: 0,          // 队列任务数
        scheduledCount: 0,      // 定时任务数
        runningCount: 0,        // 运行中任务数
    },

    // UI 状态
    activeTab: 'queue',         // 当前标签页
    loading: false,             // 加载状态

    // 数据列表
    queue: [],                  // 任务队列
    scheduled: [],              // 定时任务列表
    running: [],                // 运行中任务列表
    completed: { items: [], page: 1, total: 0, limit: 20 },
    failed: { items: [], page: 1, total: 0, limit: 20 },
}
\`\`\`

### 3.2 状态更新流程

用户操作/API 响应 → 更新 state 对象 → 调用渲染方法 → 更新 DOM 元素

## 4. 路由设计

### 4.1 视图常量定义

\`\`\`javascript
// web/static/constants.js
const Views = {
    CURRENT_SESSION: 'current-session',
    HISTORY: 'history',
    // ...
    SCHEDULER: 'scheduler',  // v0.6.4 新增
};
\`\`\`

### 4.2 路由处理流程

导航点击事件 → Navigation.switchView() → 更新菜单高亮 → 切换视图面板 → 调用 Scheduler.onShow()

### 4.3 视图生命周期

\`\`\`javascript
const Scheduler = {
    onShow() {
        this.loadAll();           // 加载数据
        this.startAutoRefresh();  // 开始自动刷新
    },
    onHide() {
        this.stopAutoRefresh();   // 停止自动刷新
    },
};
\`\`\`

## 5. 组件层次结构

### 5.1 组件树

\`\`\`
view-scheduler (视图容器)
├── page-header (页面标题)
├── scheduler-status-bar (状态栏组件)
│   ├── scheduler-status-left (状态指示)
│   ├── scheduler-stats (统计信息)
│   └── scheduler-actions (操作按钮)
├── scheduler-tabs (标签页导航)
│   ├── scheduler-tab[data-tab="queue"]
│   ├── scheduler-tab[data-tab="scheduled"]
│   ├── scheduler-tab[data-tab="running"]
│   ├── scheduler-tab[data-tab="completed"]
│   └── scheduler-tab[data-tab="failed"]
├── scheduler-content (内容区域)
│   ├── scheduler-tab-pane#scheduler-tab-queue
│   ├── scheduler-tab-pane#scheduler-tab-scheduled
│   ├── scheduler-tab-pane#scheduler-tab-running
│   ├── scheduler-tab-pane#scheduler-tab-completed
│   └── scheduler-tab-pane#scheduler-tab-failed
└── scheduler-dialogs (对话框容器)
\`\`\`

## 6. API 封装设计

\`\`\`javascript
const SchedulerAPI = {
    getStatus: () => fetch('/api/scheduler/status').then(r => r.json()),
    start: () => fetch('/api/scheduler/start', { method: 'POST' }).then(r => r.json()),
    stop: () => fetch('/api/scheduler/stop', { method: 'POST' }).then(r => r.json()),
    getQueue: () => fetch('/api/tasks').then(r => r.json()),
    // ...
};
\`\`\`

## 7. 事件处理设计

- 使用事件委托减少事件绑定数量
- 标签页切换、列表操作均使用事件委托模式

## 8. 响应式设计

| 断点 | 宽度 | 布局 |
|------|------|------|
| 桌面 | > 1024px | 完整表格布局 |
| 平板 | 768px - 1024px | 紧凑表格 |
| 移动 | < 768px | 卡片式列表 |

## 9. 性能优化

- 离开视图时停止轮询
- 使用 DocumentFragment 批量插入 DOM
- Cron 验证使用 300ms 防抖

## 10. 状态展示 UI 设计

> 本节描述运行中、已完成、失败任务列表及任务详情对话框的 UI 设计。

### 10.1 运行中列表

| 列名 | 内容 | 说明 |
|------|------|------|
| 状态 | 🔄 图标 | 蓝色 #2196F3 |
| 描述 | task.prompt | 最大 50 字符截断 |
| 运行时长 | 动态更新 | 每秒刷新 |
| 操作 | 详情按钮 | 查看任务详情 |

**实时更新机制**：
- 通过 `data-started-at` 属性存储开始时间
- 每秒计算 `Date.now() - startTime` 更新显示

### 10.2 已完成列表

| 列名 | 内容 | 说明 |
|------|------|------|
| 状态 | ✅ 图标 | 绿色 #4CAF50 |
| 描述 | task.prompt | 最大 50 字符截断 |
| 完成时间 | ended_at | 格式化为本地时间 |
| 耗时 | duration_ms | 格式化显示 |
| 操作 | 详情按钮 | 查看任务详情 |

**分页功能**：每页 20 条，支持上一页/下一页导航。

### 10.3 失败列表

| 列名 | 内容 | 说明 |
|------|------|------|
| 状态 | ❌ 图标 | 红色 #F44336 |
| 描述 | task.prompt | 最大 50 字符截断 |
| 错误信息 | error | 最大 30 字符截断 |
| 操作 | 详情、重试 | 查看详情或重新执行 |

**重试机制**：重新创建任务并添加到队列。

### 10.4 任务详情对话框

**结构**：
- 基本信息：描述、状态、开始/结束时间、耗时、工作目录
- 工具使用：标签形式展示
- 文件变更：列表形式展示
- 错误信息：仅失败任务显示
- 输出日志：可展开/折叠，支持复制

**日志展开/折叠**：
- 点击 ▼/▶ 图标切换
- 默认展开，折叠时 max-height: 50px

### 10.5 状态颜色方案

| 状态 | 颜色 | 图标 | CSS 类 |
|------|------|------|--------|
| 运行中 | #2196F3 | 🔄 | `.status-icon.running` |
| 已完成 | #4CAF50 | ✅ | `.status-icon.completed` |
| 失败 | #F44336 | ❌ | `.status-icon.failed` |
| 待执行 | #FF9800 | ⏳ | `.status-icon.pending` |
| 已取消 | #9E9E9E | ⏸ | `.status-icon.cancelled` |

### 10.6 响应式适配

| 断点 | 布局 |
|------|------|
| > 1024px | 完整表格，prompt 列最大 400px |
| 768-1024px | 紧凑表格，prompt 列最大 250px |
| < 768px | 卡片式列表，隐藏表头，使用 data-label |

## 11. 相关文档

- 任务调度-调度器状态组件.md
- 任务调度-核心设计.md
- 开发指南.md
