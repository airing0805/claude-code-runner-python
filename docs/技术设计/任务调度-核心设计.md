# 任务调度 - 核心架构设计

> 本文档定义任务调度系统的核心架构设计。

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         FastAPI 应用层                                │
│                    app/routers/scheduler.py                          │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐    ┌─────────────────────┐    ┌───────────────┐
│   任务队列     │    │     定时任务         │    │   调度器      │
│   管理 API     │    │     管理 API        │    │   控制 API    │
└───────┬───────┘    └──────────┬──────────┘    └───────┬───────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐    ┌─────────────────────┐    ┌───────────────┐
│   storage.py  │◄──►│     scheduler.py    │◄──►│  executor.py  │
│   (存储层)     │    │     (主调度器)       │    │  (执行器)     │
└───────┬───────┘    └──────────┬──────────┘    └───────┬───────┘
        │                       │                       │
        │                       │                       │
        ▼                       │                       ▼
┌───────────────┐               │               ┌───────────────┐
│  JSON 文件    │               │               │ClaudeCodeClient│
│  data/        │               │               │  (任务执行)    │
└───────────────┘               │               └───────────────┘
                                │
                                ▼
                    ┌─────────────────────┐
                    │     cron.py         │
                    │  (Cron 解析器)        │
                    └─────────────────────┘
```

## 2. 模块职责划分

### 2.1 核心模块

| 模块 | 路径 | 职责 |
|------|------|------|
| models.py | app/scheduler/models.py | 定义 Task、ScheduledTask、TaskStatus 数据模型 |
| storage.py | app/scheduler/storage.py | JSON 文件存储层，提供 CRUD 操作 |
| cron.py | app/scheduler/cron.py | Cron 表达式解析和下次执行时间计算 |
| executor.py | app/scheduler/executor.py | 任务执行器，调用 ClaudeCodeClient |
| scheduler.py | app/scheduler/scheduler.py | 主调度器，管理轮询和任务状态 |
| config.py | app/scheduler/config.py | 配置常量定义 |

### 2.2 模块依赖关系

```
models.py          # 无依赖，基础数据模型
     │
     ▼
storage.py         # 依赖 models，存储操作
     │
     ├──────────────────┐
     │                  │
     ▼                  ▼
cron.py          executor.py
(Cron 解析)       (任务执行)
     │                  │
     └────────┬─────────┘
              │
              ▼
       scheduler.py      # 依赖所有模块
              │
              ▼
       routers/scheduler.py  # 依赖 scheduler
```

## 3. 数据流设计

### 3.1 任务执行流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户操作流程                                  │
└─────────────────────────────────────────────────────────────────────┘

1. 添加任务到队列
   POST /api/tasks
        │
        ▼
   models.Task 创建
        │
        ▼
   storage.add_to_queue()
        │
        ▼
   queue.json 写入
        │
        ▼
   返回任务 ID

2. 创建定时任务
   POST /api/scheduled-tasks
        │
        ▼
   models.ScheduledTask 创建
        │
        ▼
   cron.calculate_next_run()  # 计算下次执行时间
        │
        ▼
   storage.save_scheduled_task()
        │
        ▼
   scheduled.json 写入
        │
        ▼
   返回定时任务 ID

3. 调度器轮询
   scheduler.run() [定时循环]
        │
        ├──────────────────────────────────────────────┐
        │                                              │
        ▼                                              ▼
   检查定时任务到期                           从队列获取任务
   cron.is_due()                               storage.get_next_task()
        │                                              │
        │                                              ▼
        ▼                                       executor.execute()
   创建 Task 对象                                    │
   加入队列                                         ▼
   storage.add_to_queue()                   ClaudeCodeClient.run()
        │                                              │
        │                                              ▼
        │                                       状态更新: RUNNING
        │                                              │
        │                                              ▼
        │                                       结果处理
        │                                       ├─ 成功: COMPLETED
        │                                       └─ 失败: FAILED (重试)
        │                                              │
        └──────────────────────┬──────────────────────┘
                               │
                               ▼
                        storage.save_result()
                               │
                               ▼
                        completed.json / failed.json
```

### 3.2 数据文件流

```
                    ┌─────────────────┐
                    │   queue.json    │
                    │   (待执行队列)   │
                    └────────┬────────┘
                             │
                             │ 取出任务
                             ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ scheduled.json  │───►│  running.json   │───►│ completed.json  │
│ (定时任务配置)   │到期 │  (运行中任务)   │完成 │ (已完成历史)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                             │                      ▲
                             │ 失败                  │
                             ▼                      │
                    ┌─────────────────┐             │
                    │  failed.json    │─────────────┘
                    │  (失败任务记录)   │  重试后成功
                    └─────────────────┘
```

## 4. 状态机设计

### 4.1 任务状态转换

```
                    ┌──────────┐
                    │  PENDING │  (待执行)
                    └────┬─────┘
                         │ 调度器取出执行
                         ▼
                    ┌──────────┐
              ┌─────│ RUNNING  │─────┐
              │     └──────────┘     │
              │                       │
        超时/主动停止            执行完成
              │                       │
              ▼                       ▼
    ┌─────────────────┐     ┌──────────────┐
    │  重试 < 2 次    │     │   COMPLETED  │
    │    ──────►      │     │   (已完成)    │
    │   PENDING       │     └──────────────┘
    └─────────────────┘
              │
        重试次数 >= 2
              │
              ▼
    ┌─────────────────┐
    │     FAILED      │
    │    (失败)        │
    └─────────────────┘

    ┌─────────────────┐
    │    CANCELLED    │
    │   (已取消)       │
    └─────────────────┘
```

### 4.2 状态定义

| 状态 | 英文 | 说明 | 可转换到 |
|------|------|------|----------|
| PENDING | 待执行 | 任务在队列中等待执行 | RUNNING, CANCELLED |
| RUNNING | 运行中 | 任务正在执行 | PENDING (重试), COMPLETED, FAILED, CANCELLED |
| COMPLETED | 已完成 | 任务成功完成 | - |
| FAILED | 失败 | 任务执行失败 | PENDING (重试), CANCELLED |
| CANCELLED | 已取消 | 任务被用户取消 | - |

### 4.3 定时任务状态

| 状态 | 说明 |
|------|------|
| enabled | 定时任务启用，到期时会自动加入队列 |
| disabled | 定时任务禁用，不会自动执行 |

## 5. 关键设计决策

### 5.1 存储方案

- **JSON 文件存储**: 简单易实现，无需额外数据库依赖
- **文件锁**: 使用文件锁机制保证并发安全
- **分页支持**: 已完成和失败任务支持分页查询，避免文件过大

### 5.2 调度策略

- **轮询间隔**: 默认 10 秒，可配置
- **单任务执行**: 同一时间只执行一个任务，避免资源竞争
- **定时任务优先**: 优先处理到期的定时任务

### 5.3 重试机制

- **最大重试次数**: 2 次
- **重试延迟**: 指数退避 (5s, 10s)
- **失败记录**: 失败任务保存到 failed.json，可查看和重试

### 5.4 超时控制

- **默认超时**: 600 秒 (10 分钟)
- **可配置**: 每个任务可单独设置超时时间
- **超时处理**: 超时视为失败，触发重试机制

## 6. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| POLL_INTERVAL | 10 | 轮询间隔（秒） |
| MAX_RETRIES | 2 | 最大重试次数 |
| DEFAULT_TIMEOUT | 600000 | 默认超时时间（毫秒） |
| MAX_HISTORY | 1000 | 历史任务记录最大数量 |
| DATA_DIR | data/ | 数据文件目录 |

## 7. 错误处理

### 7.1 错误分类

| 错误类型 | 处理方式 |
|----------|----------|
| 任务执行失败 | 记录错误信息，保存到 failed.json |
| 超时 | 标记为失败，触发重试 |
| 存储失败 | 抛出异常，记录日志 |
| Cron 表达式无效 | 返回 400 错误 |

### 7.2 日志记录

- 任务状态转换记录
- 执行耗时记录
- 错误信息记录
- 定时任务触发记录
