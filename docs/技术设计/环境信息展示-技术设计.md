# v0.3.1 - 环境信息展示技术设计

## 1. API 接口设计

### 1.1 获取 Claude 版本

```
GET /api/claude/version
```

**响应示例**：
```json
{
  "cli_version": "1.0.12",
  "sdk_version": "0.0.25",
  "runtime": {
    "os": "Windows",
    "os_version": "11",
    "python_version": "3.12.0"
  }
}
```

### 1.2 获取环境变量

```
GET /api/claude/env
```

**响应示例**：
```json
{
  "variables": {
    "ANTHROPIC_API_KEY": "sk-***",
    "WORKING_DIR": "E:\\workspaces_2026_python\\claude-code-runner",
    "CLAUDECODE": "true",
    "PORT": "8000"
  }
}
```

**说明**：
- 敏感变量（API_KEY、TOKEN、PASSWORD 等）显示为 `***`
- 仅返回与 Claude Code 相关的变量

### 1.3 获取配置信息

```
GET /api/claude/config
```

**响应示例**：
```json
{
  "working_dir": "E:\\workspaces_2026_python\\claude-code-runner",
  "default_permission_mode": "default",
  "allowed_tools": [
    "Read",
    "Write",
    "Edit",
    "Bash",
    "Glob",
    "Grep",
    "WebSearch",
    "WebFetch",
    "Task"
  ]
}
```

## 2. 数据结构设计

### 2.1 VersionInfo

```python
from pydantic import BaseModel

class RuntimeInfo(BaseModel):
    os: str
    os_version: str
    python_version: str

class VersionInfo(BaseModel):
    cli_version: str
    sdk_version: str
    runtime: RuntimeInfo
```

### 2.2 EnvInfo

```python
from pydantic import BaseModel

class EnvInfo(BaseModel):
    variables: dict[str, str]
```

### 2.3 ConfigInfo

```python
from pydantic import BaseModel

class ConfigInfo(BaseModel):
    working_dir: str
    default_permission_mode: str
    allowed_tools: list[str]
```

## 3. 后端实现

### 3.1 路由文件

新建 `app/routers/claude.py`：

```python
from fastapi import APIRouter, HTTPException
from app.claude.schemas import VersionInfo, EnvInfo, ConfigInfo

router = APIRouter(prefix="/api/claude", tags=["claude"])

@router.get("/version", response_model=VersionInfo)
async def get_version():
    """获取 Claude 版本信息"""
    ...

@router.get("/env", response_model=EnvInfo)
async def get_env():
    """获取环境变量（敏感信息隐藏）"""
    ...

@router.get("/config", response_model=ConfigInfo)
async def get_config():
    """获取 Claude 配置信息"""
    ...
```

### 3.2 敏感信息处理

```python
SENSITIVE_KEYS = {
    "ANTHROPIC_API_KEY",
    "API_KEY",
    "TOKEN",
    "PASSWORD",
    "SECRET",
    "PRIVATE_KEY",
}

def mask_sensitive_value(key: str, value: str) -> str:
    """隐藏敏感信息"""
    key_upper = key.upper()
    for sensitive in SENSITIVE_KEYS:
        if sensitive in key_upper:
            return "***"
    return value
```

## 4. 前端设计

### 4.1 页面结构

```
┌─────────────────────────────────────────────────────────────┐
│  Claude 状态                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐        │
│  │  版本信息            │  │  环境变量            │        │
│  │  ─────────          │  │  ─────────          │        │
│  │  CLI: 1.0.12        │  │  WORKING_DIR: ***   │        │
│  │  SDK: 0.0.25        │  │  PORT: 8000         │        │
│  │  OS: Windows 11     │  │  ...                │        │
│  └─────────────────────┘  └─────────────────────┘        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  配置信息                                            │   │
│  │  ─────────                                          │   │
│  │  工作目录: E:\workspaces_2026_python\...            │   │
│  │  权限模式: default                                   │   │
│  │  可用工具: Read, Write, Edit, Bash, Glob, Grep...  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 API 调用

```javascript
// 获取版本信息
async function loadVersionInfo() {
  const response = await fetch('/api/claude/version');
  return await response.json();
}

// 获取环境变量
async function loadEnvInfo() {
  const response = await fetch('/api/claude/env');
  return await response.json();
}

// 获取配置
async function loadConfigInfo() {
  const response = await fetch('/api/claude/config');
  return await response.json();
}
```

## 5. 路由注册

在 `app/main.py` 中注册新路由：

```python
from app.routers import claude

app.include_router(claude.router)
```

## 6. 测试策略

### 6.1 单元测试

- 测试 `mask_sensitive_value` 函数
- 测试各个 endpoint 返回正确的数据格式

### 6.2 API 测试

- 测试 `/api/claude/version` 返回 200
- 测试 `/api/claude/env` 不包含明文 API Key
- 测试 `/api/claude/config` 返回正确配置

## 7. 关键文件

| 文件 | 操作 |
|------|------|
| `app/routers/claude.py` | 新建 |
| `app/claude/schemas.py` | 新建 |
| `app/claude/__init__.py` | 新建 |
| `app/main.py` | 修改 - 注册路由 |
| `web/templates/index.html` | 修改 - 添加导航 |
| `web/static/app.js` | 修改 - 添加视图 |
| `web/static/modules/claudeStatus.js` | 新建 |
