# v0.3 版本开发计划

## v0.3.1

### 背景

当前 web 目录存在以下问题：
1. 使用全局对象模式（IIFE），无 ES Modules
2. `ClaudeCodeRunner` 类耦合大量逻辑
3. 单一 huge CSS 文件（1532行）
4. 缺乏类型检查和 IDE 支持
5. 全局变量污染

用户选择：**现代化重构 + 原子化 CSS + Vite**

---

### 重构目标

1. 使用 ES Modules 模块化
2. 引入 Vite 作为开发/构建工具
3. 使用 TypeScript 添加类型支持
4. 组件化架构
5. 原子化 CSS（使用 CSS 变量 + 工具类）
6. 保持现有功能 100% 兼容

---

### 目录结构设计

```
web/
├── index.html              # 入口 HTML（调整引用路径）
├── package.json            # Vite + TypeScript 配置
├── tsconfig.json           # TypeScript 配置
├── vite.config.ts          # Vite 配置
├── src/
│   ├── main.ts             # 应用入口
│   ├── app/
│   │   ├── App.ts          # 根组件
│   │   └── state.ts        # 全局状态管理
│   ├── components/         # UI 组件
│   │   ├── NavMenu/
│   │   │   ├── NavMenu.ts
│   │   │   └── NavMenu.css
│   │   ├── ToolsMultiselect/
│   │   │   ├── ToolsMultiselect.ts
│   │   │   └── ToolsMultiselect.css
│   │   ├── Tabs/
│   │   │   ├── Tabs.ts
│   │   │   └── Tabs.css
│   │   ├── SessionOutput/
│   │   │   ├── SessionOutput.ts
│   │   │   └── SessionOutput.css
│   │   └── ...
│   ├── modules/            # 业务逻辑模块
│   │   ├── api/
│   │   │   └── client.ts      # API 客户端（SSE 处理）
│   │   ├── navigation/
│   │   │   └── Navigation.ts
│   │   ├── session/
│   │   │   └── SessionManager.ts
│   │   ├── history/
│   │   │   └── HistoryManager.ts
│   │   ├── task/
│   │   │   └── TaskRunner.ts
│   │   └── workingDir/
│   │       └── WorkingDirManager.ts
│   ├── types/
│   │   └── index.ts       # TypeScript 类型定义
│   ├── utils/
│   │   └── index.ts       # 工具函数
│   └── styles/
│       ├── variables.css   # CSS 变量定义
│       ├── reset.css      # CSS 重置
│       ├── utilities.css  # 原子化工具类
│       └── components/    # 组件样式
│           ├── nav.css
│           ├── tabs.css
│           ├── output.css
│           └── ...
└── public/                 # 静态资源
    └── (空，CSS 内联)
```

---

### 实施步骤

#### Phase 1: 搭建基础设施

1. **创建 package.json**
   - 添加 vite, typescript, @types/node 依赖
   - 配置 scripts: dev, build, preview

2. **创建 Vite 配置** (`vite.config.ts`)
   - 配置入口: src/main.ts
   - 输出目录: dist
   - 开发服务器端口

3. **创建 TypeScript 配置** (`tsconfig.json`)
   - 配置 ESNext, DOM, 模块解析
   - 严格模式

4. **创建 CSS 变量文件** (`src/styles/variables.css`)
   - 迁移现有 CSS 变量
   - 定义颜色、间距、字体等

5. **创建工具类 CSS** (`src/styles/utilities.css`)
   - 常用工具类：flex, grid, padding, margin 等

#### Phase 2: 类型和工具

6. **创建 TypeScript 类型定义** (`src/types/index.ts`)
   ```typescript
   interface TaskRequest {
     prompt: string;
     working_dir?: string;
     tools?: string[];
     continue_conversation?: boolean;
     resume?: string | null;
   }

   interface StreamMessage {
     type: 'text' | 'tool_use' | 'tool_result' | 'error' | 'complete';
     content?: string;
     timestamp?: string;
     tool_name?: string;
     tool_input?: Record<string, unknown>;
     metadata?: TaskMetadata;
   }

   interface Project {
     encoded_name: string;
     path: string;
     session_count: number;
     tools: string[];
   }

   interface Session {
     id: string;
     title: string;
     timestamp?: string;
     message_count?: number;
   }
   ```

7. **重构 utils.js** -> `src/utils/index.ts`
   - 保留现有工具函数
   - 添加类型注解

#### Phase 3: API 模块

8. **创建 API 客户端** (`src/modules/api/client.ts`)
   - 封装 SSE 流式请求
   - 类型安全的 fetch 封装

#### Phase 4: 业务逻辑模块

9. **重构 Navigation** -> `src/modules/navigation/Navigation.ts`
   - 视图切换逻辑
   - 类型注解

10. **重构 SessionManager** -> `src/modules/session/SessionManager.ts`
    - 会话状态管理
    - 标签页逻辑

11. **重构 TaskRunner** -> `src/modules/task/TaskRunner.ts`
    - 任务执行逻辑
    - SSE 消息处理

12. **重构 HistoryManager** -> `src/modules/history/HistoryManager.ts`
    - 项目列表加载
    - 会话列表管理

13. **重构 WorkingDirManager** -> `src/modules/workingDir/WorkingDirManager.ts`
    - 工作目录管理

#### Phase 5: UI 组件

14. **创建 NavMenu 组件**
    - 模板 + 样式 + 逻辑

15. **创建 ToolsMultiselect 组件**

16. **创建 Tabs 组件**

17. **创建 SessionOutput 组件**

#### Phase 6: 应用入口和样式

18. **创建主入口** (`src/main.ts`)
    - 初始化应用
    - 事件绑定

19. **拆分 CSS**
    - 将原 style.css 内容拆分到各组件
    - 使用 variables.css 和 utilities.css

20. **调整 index.html**
    - 更新 script 引用到 /src/main.ts
    - 更新 link 引用

#### Phase 7: 测试和优化

21. **开发模式测试**
    - 运行 `npm run dev`
    - 验证功能正常

22. **构建测试**
    - 运行 `npm run build`
    - 验证构建产物

---

### 关键文件修改清单

#### 新建文件
- `web/package.json`
- `web/tsconfig.json`
- `web/vite.config.ts`
- `web/src/main.ts`
- `web/src/app/App.ts`
- `web/src/app/state.ts`
- `web/src/types/index.ts`
- `web/src/utils/index.ts`
- `web/src/styles/variables.css`
- `web/src/styles/utilities.css`
- `web/src/styles/reset.css`
- `web/src/modules/api/client.ts`
- `web/src/modules/navigation/Navigation.ts`
- `web/src/modules/session/SessionManager.ts`
- `web/src/modules/task/TaskRunner.ts`
- `web/src/modules/history/HistoryManager.ts`
- `web/src/modules/workingDir/WorkingDirManager.ts`
- `web/src/components/*/index.ts`
- `web/src/components/*/*.css`

#### 删除文件（重构完成后）
- `web/static/app.js`
- `web/static/constants.js`
- `web/static/utils.js`
- `web/static/components/*.js`
- `web/static/modules/*.js`
- `web/static/style.css`
- `web/templates/index.html`（替换为根目录 index.html）

#### 修改文件
- `web/index.html`（新建，作为 Vite 入口）

---

### 验证方式

1. **开发模式验证**
   ```bash
   cd web
   npm run dev
   # 访问 http://localhost:5173
   # 测试所有功能：执行任务、查看历史、切换标签页等
   ```

2. **构建验证**
   ```bash
   npm run build
   # 检查 dist/ 目录产物
   ```

3. **功能测试清单**
   - [ ] 执行新任务
   - [ ] SSE 流式输出
   - [ ] 停止任务
   - [ ] 清空输出
   - [ ] 切换视图（当前会话/历史记录/示例任务）
   - [ ] 历史记录 - 项目列表
   - [ ] 历史记录 - 会话列表
   - [ ] 继续历史会话
   - [ ] 新建标签页
   - [ ] 切换标签页
   - [ ] 关闭标签页
   - [ ] 工具多选
   - [ ] 工作目录选择
   - [ ] 菜单收起/展开
   - [ ] 响应式布局

---

### 风险控制

1. **渐进式重构**：保留旧文件，逐步迁移
2. **功能兼容**：每迁移一个模块，验证对应功能
3. **样式一致**：使用相同的 CSS 变量确保视觉一致
4. **类型安全**：TypeScript 严格模式减少运行时错误

---

### 静态文件服务配置

当前 FastAPI 配置（`app/main.py`）：
- 静态文件：`/static` -> `web/static`
- 模板：`web/templates`

#### Vite 构建输出配置

在 `vite.config.ts` 中配置：
```typescript
export default defineConfig({
  build: {
    outDir: 'dist',        // 输出到 web/dist
    emptyOutDir: true,
  },
  root: '.',               // Vite 根目录
})
```

#### 服务方案选择

**方案 A：让 FastAPI 服务构建产物（推荐）**
- 修改 `app/main.py`，添加 `/dist` 静态文件挂载
- Vite 构建后文件由 FastAPI 服务
- 适合生产部署

**方案 B：使用 Vite 开发服务器**
- 开发时运行 `npm run dev`（端口 5173）
- FastAPI 运行在端口 8000
- 通过代理或分开访问

计划采用**方案 A**，修改 `app/main.py` 来服务 Vite 构建产物。

#### 需要修改的文件

在 Phase 1 中添加：
- 修改 `app/main.py`，添加条件性挂载 `web/dist` 静态文件

```python
# 构建产物目录
DIST_DIR = BASE_DIR / "web" / "dist"

# 仅在生产构建存在时挂载
if DIST_DIR.exists():
    app.mount("/dist", StaticFiles(directory=DIST_DIR), name="dist")
```
