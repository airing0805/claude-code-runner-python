## v0.2.1

```
- [x] 整体布局和样式调整：历史记录和示例任务的右边功能页面宽度不够，需适应窗口大小变化。根据布局设计调整。
- [x] 所有右边的功能页面的布局保持一致。根据布局设计调整。
- [x] 会话界面：工具权限使用权限列表，下拉列表多项选择。
- [x] 会话界面：右边的滚动条在任务执行区，自动滚动到最底端。
- [x] 会话界面：从历史会话过来的界面，会话信息中的工作目录等回填错误。
- [x] 会话界面：有历史会话时切到新任务，新任务的数据还是显示为会话历史。
- [x] 会话界面：清空按钮不可用。
- [x] 历史会话列表：项目列表和历史记录的信息不对，重新进入时要更新数据。
- [x] 历史会话列表：项目列表中显示工具权限。
- [x] 按功能拆分 E:\workspaces_2026_python\claude-code-runner\app\main.py 将 API 接口拆分到多个文件。
```

### 变更详情

#### 布局调整
- 修改 CSS：将 `.container` 改为自适应布局，添加 `.page-container` 类统一页面结构
- 统一历史记录和示例任务视图的头部样式，与当前会话视图保持一致

#### 工具权限多选
- 将工具输入框改为多选下拉框组件
- 支持全选/取消选择工具
- 显示已选工具数量

#### 会话界面修复
- 修复从历史会话继续时工作目录回填错误
- 修复切换新任务标签时显示历史会话数据的问题
- 增强清空按钮功能：清空输出、隐藏统计、重置状态

#### 历史会话列表
- 切换到历史视图时强制刷新数据
- 项目列表中显示已使用的工具信息
- API 返回每个项目的工具汇总

#### API 拆分
- `app/routers/task.py` - 任务执行相关 API
- `app/routers/session.py` - 会话历史相关 API
- `app/routers/status.py` - 状态和工具相关 API
- `app/main.py` - 简化为应用入口

## v0.2.2
```
- [x] 会话界面：如果是新的会话，工作目录 改为单选下拉选项。会话ID放在工作目录的右边。
- [x] 会话界面：从历史会话过来的界面，会话信息中的工作目录，会话ID不能修改。
- [x] 会话界面：工作目录，会话ID的内容 鼠标 停顿时，显示的完整内容。
- [x] 会话界面：信息显示区，最右边添加"新会话"的按钮。点击新会话，创建新的 tab ,内容全部重新填写。
- [x] 会话界面：新的会话点击执行后，显示会话ID。tab 标题改为会话标签 。
- [x] 将 E:\workspaces_2026_python\claude-code-runner\app下的前端页面迁移出app目录。
```

### 变更详情

#### 前端页面迁移
- 将 `app/templates` 和 `app/static` 目录迁移到项目根目录的 `web/` 目录
- 更新 `app/main.py` 中的路径配置指向新的 `web/` 目录

#### 工作目录下拉选择
- 将工作目录输入框改为下拉选择框 `<select>`
- 从项目列表 API 加载可用的工作目录选项
- 支持鼠标悬停显示完整路径

#### 会话字段锁定
- 新会话：工作目录和会话ID可编辑
- 历史会话：工作目录和会话ID自动锁定（禁用编辑）
- 任务执行完成后自动锁定会话字段

#### 新会话按钮
- 信息栏右侧添加"新会话"按钮
- 点击创建新的标签页，重置所有输入

#### 会话状态更新
- 执行完成后自动显示会话ID
- 新任务标签自动转换为会话标签（图标和标题更新）
- 标签标题根据任务描述自动生成

## v0.2.3
```
- [x] 项目列表每个列表后面添加一个"新会话"按钮，创建一个新会话。
- [x] E:\workspaces_2026_python\claude-code-runner\src\claude_runner 迁移到 app 目录下
```

### 变更详情

#### 项目列表新会话按钮
- 在项目列表每一行添加"新会话"按钮
- 点击按钮直接创建新会话并设置工作目录为对应项目路径
- 自动切换到当前会话视图并聚焦任务输入框
- 点击项目信息区域仍然进入会话列表

#### claude_runner 模块迁移
- 将 `src/claude_runner/` 目录迁移到 `app/claude_runner/`
- 更新所有导入路径：`from src.claude_runner` → `from app.claude_runner`
- 更新测试文件和文档中的导入路径
- 删除 `src` 目录

## v0.2.4
```
- [x] 项目列表显示的项目的路径和实际的路径不一致。
- [x] 执行错误: Failed to start Claude Code: [WinError 267] 目录名称无效。
```

### 变更详情

#### 路径解析修复
- **问题根因**：`decode_project_name` 函数假设所有 `-` 替换为 `\`，但路径中本身包含 `-`（如 `workspaces-2026`），导致解码错误
- **解决方案**：从会话文件的 `cwd` 字段读取真实的项目路径，而不是尝试解码目录名
- **修改文件**：`app/routers/session.py`
  - `parse_session_metadata()` - 新增提取 `cwd` 字段
  - `list_projects()` - 使用会话文件中的 `cwd` 作为项目路径
  - `list_project_sessions()` - 使用会话文件中的 `cwd` 作为项目路径
  - `get_session_messages()` - 使用会话文件中的 `cwd` 作为项目路径

## v0.2.5
```
- [x] 将版本历史从需求文档中独立出来
- [x] 会话界面：新会话中的工作目录可以手动输入任意路径。
- [x] 会话界面：工具权限下拉选项中，一行显示2个权限选项。

```

### 变更详情

#### 版本历史独立
- 创建 `docs/更新日志.md` 文件，独立管理版本更新历史
- 从 `docs/需求文档.md` 中移除版本历史部分
- 保持需求文档的清晰性，便于维护

#### 工作目录手动输入
- 将工作目录从纯下拉选择 (`<select>`) 改为可编辑的 combo box (`<input>` + `<datalist>`)
- 新会话时用户可以手动输入任意路径作为工作目录
- 仍保留从项目列表加载的下拉选项供快速选择
- 历史会话的工作目录保持锁定状态（禁用编辑）
- 修改文件：
  - `web/templates/index.html` - 将 select 改为 input + datalist
  - `web/static/app.js` - 更新相关 JavaScript 逻辑
  - `web/static/style.css` - 添加工作目录输入框样式

#### 工具权限布局优化
- 工具下拉框改为两列网格布局
- 使用 CSS Grid 实现一行显示 2 个工具选项
- 减少滚动，提升操作效率
- 保持原有的全选/单选功能
- 修改文件：
  - `web/static/style.css` - 添加 `.tools-grid` 网格布局
  - `web/static/app.js` - 更新 `renderToolOptions()` 方法


## v0.2.6
```
- [x] 会话界面： 支持多轮对话，页面的滚动条放在对话结构显示区。
- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。

```

### 变更详情

#### 多轮对话支持
- 重新设计对话显示结构，每轮对话包含用户输入和 AI 响应
- 新增 `conversation-round` 容器组件，清晰区分各轮对话
- 每轮对话显示轮次编号，便于追踪对话历史
- 执行完成后会话 ID 自动填充，支持在当前会话中继续对话
- 清空按钮仅清空当前标签的对话，不影响其他标签页
- 修改文件：
  - `web/static/app.js` - 新增多轮对话管理方法
  - `web/static/style.css` - 新增多轮对话样式

#### 对话显示优化
- 用户消息和 AI 响应分区显示，视觉更清晰
- 用户消息使用紫色主题，AI 响应使用蓝色/绿色主题
- 工具调用、错误消息、完成消息使用不同颜色边框区分
- 滚动条保持在对话输出区，自动滚动到最新消息
- 历史消息按轮次分组显示，恢复历史会话时保持对话结构

#### 测试验证
- 运行全部 23 个测试用例，全部通过
- 验证前端 JavaScript 代码无语法错误
- 验证后端 API 加载正常

## v0.2.7
```
- [x] 会话界面： 点击切换默认新任务时，界面显示的是其他会话的内容。
- [x] 会话界面： 界面上输入的任务，没有在会话内容区显示。是否是接口没有记录。
- [x] 会话界面：历史会话的记录中，对话的内容没有完整的渲染出来，有很多的内容为空，没有显示问题。用户的内容为空时，如果是一条，应该是历史会话没有记录下来。用户的内容为空时，如果是持续多条，是模型在持续的输出。
- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。

```

### 变更详情

#### 标签切换修复
- **问题根因**：`switchToTab` 函数在切换标签时先更新了 `activeTabId`，然后调用 `clearOutput()`，但 `clearOutput()` 内部又根据 `activeTabId` 判断是否清空输入，导致逻辑混乱
- **解决方案**：重构 `switchToTab` 函数，在切换时立即清空输出区，然后再根据标签类型填充内容
- 修改文件：`web/static/app.js` - `switchToTab()` 方法

#### 用户输入显示修复
- **问题根因**：用户输入在 `startNewRound` 中被正确添加到 DOM，但可能在后续操作中被清空或覆盖
- **解决方案**：确保用户消息在添加到 DOM 后不会被意外清空，优化清空输入框的时机
- 修改文件：`web/static/app.js` - `startNewRound()` 方法

#### 历史消息渲染修复
- **问题根因**：
  1. 当 assistant 消息内容为空时仍创建空的 DOM 元素
  2. 连续多条 assistant 消息没有合并显示
  3. 后端只提取第一个 text 内容，忽略后续内容
- **解决方案**：
  1. 前端：合并连续的 assistant 消息内容，在遇到下一条 user 消息或末尾时统一显示
  2. 后端：将所有 text 类型的内容合并，用换行符连接
  3. 用户内容为空时显示占位文本 "(无内容)"
- 修改文件：
  - `web/static/app.js` - `displayHistoryMessages()` 方法，新增 `_addAssistantMessageToRound()` 辅助方法
  - `app/routers/session.py` - `get_session_messages()` API

#### 测试验证
- 运行全部 23 个测试用例，全部通过
- 验证前端 JavaScript 代码无语法错误

## v0.2.8
```
- [x] 会话界面：页面的滚动条放在输出区。保持对话框部分固定在tab标签的底部。
- [x] 历史记录：点击项目进入历史记录列表，历史记录要更新。
- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。

```

### 变更详情

#### 会话界面滚动条布局优化
- 为 `.session-layout` 添加 `overflow: hidden`，防止内容溢出
- 为固定区域（header、info-bar、stats、input）添加 `flex-shrink: 0`，确保不被压缩
- 确保输出区 `.session-output` 独立滚动，输入框始终固定在底部
- 修改文件：`web/static/style.css`

#### 历史记录刷新修复
- **问题**：点击项目进入会话列表后，数据可能不是最新的
- **解决方案**：
  1. `loadProjectSessions()` 清空缓存后重新加载，确保每次都获取最新数据
  2. `showProjectsList()` 返回项目列表时重新加载项目数据，更新会话数量
  3. `switchView()` 优化历史视图切换逻辑，避免重复加载
- 修改文件：`web/static/app.js`

#### 测试验证
- 运行全部 23 个测试用例，全部通过
- 验证前端 JavaScript 代码无语法错误

## v0.2.9
```
- [x] 会话界面：页面的竖向滚动条放在输出区（会话信息和对话框的中间区域），不是在整个页面。
- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。

```

### 变更详情

#### 会话界面滚动条布局优化
- 为 `html` 和 `body` 添加 `height: 100%` 和 `overflow: hidden`，防止整个页面滚动
- 为所有 flex 容器（`.main-content`, `.view-panel`, `.session-layout`, `.tabs-content`, `.page-container`）添加 `min-height: 0`，确保 flex 布局中子元素能正确缩小
- 为 `.session-output` 添加 `min-height: 0`，确保该区域能独立滚动
- 将 `.tab-panel.active` 从 `display: block` 改为 `display: flex; flex-direction: column`
- 修改文件：
  - `web/static/style.css` - 布局优化

#### 测试验证
- 运行全部 23 个测试用例，全部通过

#### 版本记录
- 更新 `docs/更新日志.md` 添加 v0.2.9 变更记录

## v0.2.10
```
- [x] 找出claude code 的历史记录的格式，对字段的进行分析和解读，弄清楚每个字段的意思，弄清楚与字段有关系的内容。
- [x] 将分析的内容输出到 docs 文件夹下，放到合适的位置，方便后续使用。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。

```

### 变更详情

#### Claude Code 历史记录格式分析
- 分析 Claude Code 的会话历史记录存储位置和目录结构
- 解析 JSONL 文件格式，识别四种主要消息类型
- 详细记录每个字段的含义和用途

#### 文档输出
- 创建 `docs/会话格式.md` 文档
- 包含完整的字段说明、Content 类型、消息链关系
- 提供解析示例代码和注意事项

#### 版本记录
- 更新 `docs/更新日志.md` 添加 v0.2.10 变更记录


## v0.2.11
```
- [x] 分析和拆解当前任务，并更新当前任务的内容，这个任务不要重复执行，不影响整个版本的任务。
- [x] 基于 docs\会话格式.md 的内容，给出一个完整的代码实现， 给出 当前会话 功能 输出区的实现方案。方案保存到 docs 文件夹下，放到合适的位置，方便后续使用。
- [x] 检查 当前会话 功能 输出区的实现方案。是否覆盖历史消息的所有场景。
- [x] 代码实现输出的方案。
- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档，记录历史版本记录。
```

### 任务拆解

#### 问题分析
基于 `docs/会话格式.md` 文档分析，当前实现存在以下不足：

**后端 `get_session_messages()` API 问题：**
1. 只提取 `text` 类型的内容，忽略其他类型
2. 忽略 `thinking` 类型（思考过程）
3. 忽略 `tool_use` 类型（工具调用）
4. 忽略 `tool_result` 类型（工具返回）
5. 没有提取 `is_error` 标志
6. 没有提取 `usage` token 统计

**前端消息渲染问题：**
1. 历史消息只支持简单文本渲染
2. 没有区分不同消息类型（thinking、tool_use、tool_result）
3. 没有工具调用的可视化展示
4. 没有错误状态显示

#### 实现方案
1. **后端消息解析**：扩展 API 返回完整消息结构
2. **前端消息渲染**：按类型渲染不同内容块
3. **新增数据结构**：定义消息类型枚举和接口
4. **样式优化**：不同类型消息使用不同视觉样式


## v0.2.12
```
- [x] 分析和拆解当前任务，并更新当前任务的内容，这个任务不要重复执行，不影响整个版本的任务。
- [x] docs\会话格式.md 和 docs\输出实现.md 的内容，判断是否需要更新到需求文档中。
- [x] 会话界面：当前会话 功能 输出区 没有显示出历史记录。

- [x] 检查测试当前版本更新的内容。
- [x] 当前版本更新的内容，同步更新到需求文档。
- [x] 记录历史版本记录。
```

## v0.2.13
```
- [x] 将有代表性的claude code 历史记录保存到 docs 文件夹下，放到合适位置，方便后续使用。
- [x] 会话界面：当前会话 功能 输出区 ，多轮对话和分组显示，结构不对。分析历史记录的格式结构。
- [x] 分析的内容与 docs\会话格式.md 和 docs\输出实现.md  进行对比，并给出分析结果。
- [x] 完善 docs\会话格式.md 和 docs\输出实现.md 的内容。
- [x] 当前版本更新的内容，同步更新到需求文档。
```

### 变更详情

#### 文档更新
- 创建 `docs/samples/sample-session.jsonl` - 有代表性的 Claude Code 历史记录示例
- 创建 `docs/analysis/多轮对话分析.md` - 多轮对话分组问题分析
- 更新 `docs/会话格式.md` - 添加多轮对话结构分析和消息过滤问题说明（v1.1）
- 更新 `docs/输出实现.md` - 添加多轮对话分组问题修复方案（v1.1）

#### 问题分析
- 后端过滤空内容消息导致消息链断裂
- 前端分组逻辑仅基于 role 字段，未完全利用消息链关系

## v0.2.14
- [x ] 会话界面：当前会话 功能 输出区 ，多轮对话和分组显示，结构不对。根据设计文档中的内容修改多轮对话的判断。
- [x ] 历史记录的标题显ide_selection相关的内容不能做为标题，更新历史记录的标题显示的逻辑。

## v0.2.15
- [x] 将 web\static\app.js 中的代码 按功能模块、组件等拆分，先设计结构，再进行拆分。
- [x] 当前版本更新的内容，同步更新到需求文档和设计文档。
- [x] 记录历史版本记录。

### 变更详情

#### 前端代码模块化拆分 (v0.2.15+)
将 `web/static/app.js` 拆分为多个模块文件，按功能职责组织：

**拆分方案**：
```
web/static/
├── app.js           # 主入口（初始化和事件绑定）
├── constants.js    # 常量定义（工具列表、视图名称、消息类型）
├── utils.js        # 工具函数（escapeHtml、scrollToBottom 等）
├── components/     # UI 组件
│   ├── toolsMultiselect.js   # 工具多选组件
│   └── tabs.js               # 标签页组件
└── modules/        # 功能模块
    ├── navigation.js     # 导航和视图切换
    ├── workingDir.js    # 工作目录管理
    ├── session.js       # 会话管理
    ├── history.js       # 历史记录管理
    ├── task.js         # 任务执行
    └── messageRenderer.js  # 消息渲染
```

**模块职责**：
- `constants.js`: 定义工具列表、视图名称、消息类型等常量
- `utils.js`: 通用工具函数（HTML转义、时间格式化等）
- `components/toolsMultiselect.js`: 工具多选下拉框交互
- `components/tabs.js`: 标签页的创建、切换、关闭
- `modules/navigation.js`: 导航菜单和视图切换
- `modules/workingDir.js`: 工作目录加载和选择
- `modules/session.js`: 会话状态管理
- `modules/history.js`: 项目和会话历史管理
- `modules/task.js`: 任务执行、流式处理、统计显示
- `modules/messageRenderer.js`: 历史消息渲染（按轮次、按类型）
- `app.js`: 主入口，初始化各模块

**优势**：
- 代码按功能模块化，易于维护和理解
- 单一职责，每个模块只负责特定功能
- 便于团队协作和代码审查
- 便于单元测试

**引用方式**：
更新 `index.html` 中的脚本引用顺序，确保依赖关系正确：
```html
<script src="/static/constants.js"></script>
<script src="/static/utils.js"></script>
<script src="/static/components/toolsMultiselect.js"></script>
<script src="/static/components/tabs.js"></script>
<script src="/static/modules/navigation.js"></script>
<script src="/static/modules/workingDir.js"></script>
<script src="/static/modules/session.js"></script>
<script src="/static/modules/messageRenderer.js"></script>
<script src="/static/modules/history.js"></script>
<script src="/static/modules/task.js"></script>
<script src="/static/app.js"></script>
```

## v0.2.16
- [ ] 将 web 下的代码 按功能模块、组件等拆分，先设计结构，再进行拆分。
- [ ] 当前版本更新的内容，同步更新到需求文档和设计文档。
- [ ] 记录历史版本记录。