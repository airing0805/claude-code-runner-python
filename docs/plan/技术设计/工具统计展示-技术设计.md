# v0.3.2 - 工具统计展示技术设计

## 1. API 接口设计

### 1.1 获取工具使用统计

```
GET /api/claude/stats
```

**响应示例**：
```json
{
  "tools_usage": {
    "Read": 15,
    "Write": 3,
    "Edit": 8,
    "Bash": 5,
    "Glob": 12,
    "Grep": 7,
    "WebSearch": 2,
    "WebFetch": 1,
    "Task": 0
  },
  "files_changed": 11,
  "task_stats": {
    "total": 10,
    "success": 9,
    "failed": 1,
    "avg_duration_ms": 3500,
    "total_cost_usd": 0.52
  }
}
```

### 1.2 获取权限模式说明

```
GET /api/claude/permission-modes
```

**响应示例**：
```json
{
  "modes": [
    {
      "name": "default",
      "description": "默认模式，每次工具调用需要用户确认",
      "scenarios": ["安全性要求高的场景", "需要人工审核的操作"]
    },
    {
      "name": "acceptEdits",
      "description": "自动接受编辑操作（Write/Edit），其他操作仍需确认",
      "scenarios": ["日常开发", "批量修改文件"]
    },
    {
      "name": "plan",
      "description": "规划模式，先生成计划，用户批准后执行",
      "scenarios": ["复杂任务", "需要规划的操作", "重要或不可逆的操作"]
    },
    {
      "name": "bypassPermissions",
      "description": "跳过所有权限检查，完全自动化",
      "scenarios": ["CI/CD自动化", "无人值守任务"]
    }
  ]
}
```

### 1.3 获取可用工具列表（扩展现有接口）

扩展 `GET /api/tools` 返回更多信息：

```json
{
  "tools": [
    {
      "name": "Read",
      "description": "读取文件内容",
      "category": "文件操作",
      "modifies_files": false
    },
    ...
  ]
}
```

## 2. 数据结构设计

### 2.1 ToolStats

```python
from pydantic import BaseModel

class ToolUsage(BaseModel):
    Read: int
    Write: int
    Edit: int
    Bash: int
    Glob: int
    Grep: int
    WebSearch: int
    WebFetch: int
    Task: int

class TaskStats(BaseModel):
    total: int
    success: int
    failed: int
    avg_duration_ms: int
    total_cost_usd: float

class StatsInfo(BaseModel):
    tools_usage: ToolUsage
    files_changed: int
    task_stats: TaskStats
```

### 2.2 PermissionMode

```python
from pydantic import BaseModel

class PermissionMode(BaseModel):
    name: str
    description: str
    scenarios: list[str]

class PermissionModesInfo(BaseModel):
    modes: list[PermissionMode]
```

## 3. 后端实现

### 3.1 路由扩展

在 `app/routers/claude.py` 中添加：

```python
@router.get("/stats", response_model=StatsInfo)
async def get_stats():
    """获取工具使用统计"""
    ...

@router.get("/permission-modes", response_model=PermissionModesInfo)
async def get_permission_modes():
    """获取权限模式说明"""
    ...
```

### 3.2 统计存储

使用内存或数据库存储统计数据：

```python
class StatsCollector:
    """收集工具使用统计"""

    def __init__(self):
        self.tools_usage: dict[str, int] = defaultdict(int)
        self.files_changed: int = 0
        self.task_stats: list[dict] = []

    def record_tool_use(self, tool_name: str):
        self.tools_usage[tool_name] += 1

    def record_file_change(self):
        self.files_changed += 1
```

## 4. 前端设计

### 4.1 页面区块

```
┌─────────────────────────────────────────────────────────────┐
│  工具使用统计                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Read: 15  Write: 3  Edit: 8  Bash: 5  Glob: 12   │   │
│  │ Grep: 7  WebSearch: 2  WebFetch: 1  Task: 0     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  权限模式说明                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ default - 每次需要确认                               │   │
│  │ acceptEdits - 自动接受编辑                          │   │
│  │ plan - 规划模式                                    │   │
│  │ bypassPermissions - 完全自动化                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 5. 关键文件

| 文件 | 操作 |
|------|------|
| `app/routers/claude.py` | 修改 - 添加 stats 和 permission-modes 端点 |
| `web/static/modules/claudeStatus.js` | 修改 - 添加统计展示模块 |
