# v0.3.8 - 钩子配置技术设计

## 1. API 接口设计

### 1.1 获取钩子配置

```
GET /api/claude/hooks
```

**响应示例**：
```json
{
  "hooks": [
    {
      "id": "hook_abc123",
      "name": "安全检查",
      "type": "PreToolUse",
      "enabled": true,
      "config": {
        "tools": ["Bash", "Write"],
        "action": "block"
      }
    }
  ]
}
```

### 1.2 获取钩子类型说明

```
GET /api/claude/hooks/types
```

**响应示例**：
```json
{
  "hook_types": [
    {
      "name": "PreToolUse",
      "description": "工具执行前触发",
      "example": "在执行危险命令前进行检查"
    },
    {
      "name": "PostToolUse",
      "description": "工具执行后触发",
      "example": "记录工具执行结果"
    },
    {
      "name": "Stop",
      "description": "会话结束时触发",
      "example": "清理临时文件"
    },
    {
      "name": "SessionStart",
      "description": "会话开始时触发",
      "example": "加载项目配置"
    },
    {
      "name": "Notification",
      "description": "通知事件触发",
      "example": "发送任务完成通知"
    }
  ]
}
```

### 1.3 更新钩子配置

```
PUT /api/claude/hooks
```

**请求体**：
```json
{
  "hooks": [
    {
      "name": "安全检查",
      "type": "PreToolUse",
      "enabled": true,
      "config": {...}
    }
  ]
}
```

## 2. 数据结构设计

### 2.1 Hook

```python
from pydantic import BaseModel

class HookConfig(BaseModel):
    tools: list[str] = []
    action: str = "allow"  # "allow" or "block"
    notification: bool = False

class Hook(BaseModel):
    id: str
    name: str
    type: str  # PreToolUse, PostToolUse, Stop, SessionStart, Notification
    enabled: bool
    config: HookConfig
```

## 3. 后端实现

### 3.1 路由设计

在 `app/routers/claude.py` 中添加：

```python
@router.get("/hooks", response_model=HooksDoc)
async def get_hooks():
    """获取钩子配置"""
    ...

@router.get("/hooks/types", response_model=HookTypesDoc)
async def get_hook_types():
    """获取钩子类型说明"""
    ...

@router.put("/hooks")
async def update_hooks(hooks: list[Hook]):
    """更新钩子配置"""
    ...
```

### 3.2 钩子管理

```python
from pathlib import Path

class HookManager:
    """钩子管理器"""

    HOOKS_CONFIG = Path.home() / ".claude" / "settings.json"

    def get_hooks(self) -> list[Hook]:
        """获取钩子配置"""
        ...

    def save_hooks(self, hooks: list[Hook]):
        """保存钩子配置"""
        ...
```

## 4. 前端设计

### 4.1 页面结构

```
┌─────────────────────────────────────────────────────────────┐
│  钩子配置                                                    │
│                                                             │
│  钩子类型说明                                                │
│  ───────────                                                │
│  PreToolUse - 工具执行前触发                                │
│  PostToolUse - 工具执行后触发                              │
│  Stop - 会话结束时触发                                      │
│  SessionStart - 会话开始时触发                             │
│  Notification - 通知事件触发                               │
│                                                             │
│  [+ 添加钩子]                                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 名称    │ 类型        │ 状态 │ 操作                 │   │
│  ├─────────┼─────────────┼──────┼────────────────────┤   │
│  │ 安全检查 │ PreToolUse │ 启用 │ [编辑] [删除]       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 5. 关键文件

| 文件 | 操作 |
|------|------|
| `app/routers/claude.py` | 修改 - 添加钩子相关端点 |
| `app/claude/hooks_manager.py` | 新建 |
