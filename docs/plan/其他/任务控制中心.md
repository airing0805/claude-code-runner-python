# 任务控制中心

## 概述

提供任务实时监控和控制功能，用户可通过浏览器查看运行中的任务、停止任务、查看日志等。

## 需求

### 9.1 任务状态管理

| 状态 | 描述 |
|------|------|
| queued | 排队中 |
| running | 运行中 |
| paused | 暂停 |
| completed | 已完成 |
| failed | 失败 |
| stopped | 已停止 |
| cancelled | 已取消 |

### 9.2 API 设计

```json
# 获取任务列表
GET /api/tasks

Response: 200 OK
{
  "running": [
    {
      "task_id": "task_abc123",
      "status": "running",
      "progress": 45,
      "prompt": "帮我分析这个项目的结构",
      "started_at": "2026-02-19T10:30:00Z",
      "tools_used": ["Read", "Glob", "Grep"],
      "files_changed": ["/src/main.py", "/src/utils.py"],
      "current_tool": "Grep",
      "message_count": 23
    }
  ],
  "queued": [
    {
      "task_id": "task_def456",
      "status": "queued",
      "position": 1,
      "prompt": "帮我写一个单元测试",
      "queued_at": "2026-02-19T10:35:00Z"
    }
  ]
}

# 获取任务详情
GET /api/tasks/{task_id}

Response: 200 OK
{
  "task_id": "task_abc123",
  "status": "running",
  "progress": 45,
  "prompt": "帮我分析这个项目的结构",
  "started_at": "2026-02-19T10:30:00Z",
  "tools_used": ["Read", "Glob", "Grep"],
  "files_changed": ["/src/main.py", "/src/utils.py"],
  "current_tool": "Grep",
  "message_count": 23,
  "cost_usd": 0.025,
  "duration_ms": 315000,
  "error": null
}

# 停止任务
POST /api/tasks/{task_id}/stop

Response: 200 OK
{
  "success": true,
  "message": "任务 task_abc123 已停止"
}

# 取消排队任务
POST /api/tasks/{task_id}/cancel

Response: 200 OK
{
  "success": true,
  "message": "任务 task_def456 已从队列中移除"
}

# 任务日志流 (SSE)
GET /api/tasks/{task_id}/logs

data: {"type": "text", "content": "正在分析项目结构...", "timestamp": "2026-02-19T10:30:05Z"}
data: {"type": "tool_use", "tool_name": "Glob", "input": {"pattern": "**/*.py"}, "timestamp": "2026-02-19T10:30:06Z"}
```

### 9.3 UI 设计

- 任务列表展示（运行中 + 排队 + 历史）
- 实时进度条显示
- 停止/取消按钮
- 任务日志流实时显示

### 9.4 优先级

| 功能 | 优先级 |
|------|--------|
| 任务列表 API | P0 |
| 任务详情 API | P0 |
| 停止任务 API | P0 |
| 任务日志流 | P0 |
| 取消排队任务 | P1 |
| 队列管理 | P1 |
| 暂停/恢复任务 | P2 |

## 实现方案

使用内存存储管理任务状态，通过 asyncio.Task.cancel() 实现任务取消。
