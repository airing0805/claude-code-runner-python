# 会话历史管理

## 概述

提供会话历史浏览、搜索、继续等功能。Claude Code 使用 session_id 管理多轮对话上下文。

## 需求

### 10.1 会话管理功能

| 功能 | 描述 |
|------|------|
| 会话列表 | 按项目查看历史会话 |
| 会话搜索 | 搜索会话标题和消息内容 |
| 会话详情 | 查看会话消息历史、工具使用、文件变更 |
| 继续会话 | 加载历史会话继续对话 |
| 删除会话 | 删除历史会话 |

### 10.2 API 设计

```json
# 搜索会话
GET /api/sessions/search?q={keyword}&project={project_name}

Response: 200 OK
{
  "sessions": [
    {
      "id": "abc123",
      "title": "审查 auth.py 安全性",
      "timestamp": "2024-01-15T10:30:00Z",
      "message_count": 8,
      "tools": ["Read", "Edit", "Bash"],
      "project_path": "/home/user/project"
    }
  ],
  "total": 15,
  "page": 1,
  "limit": 20
}

# 会话详情（含文件变更）
GET /api/sessions/{session_id}/details

Response: 200 OK
{
  "session_id": "abc123",
  "project_path": "/home/user/project",
  "created_at": "2024-01-15T10:30:00Z",
  "duration_ms": 45000,
  "cost_usd": 0.023,
  "tools_used": [
    {"name": "Read", "count": 5, "files": ["/project/auth.py", "/project/config.py"]},
    {"name": "Edit", "count": 2, "files": ["/project/auth.py"]}
  ],
  "files_changed": ["/project/auth.py"],
  "summary": "审查了 auth.py，发现 3 个安全问题"
}

# 删除会话
DELETE /api/sessions/{session_id}

Response: 200 OK
{
  "success": true,
  "message": "会话已删除"
}

# 批量删除会话
POST /api/sessions/batch-delete

Request:
{
  "session_ids": ["abc123", "def456"]
}

Response: 200 OK
{
  "success": true,
  "deleted": 2,
  "failed": []
}

# 会话统计
GET /api/sessions/stats?project={project_name}

Response: 200 OK
{
  "total_sessions": 50,
  "total_messages": 320,
  "total_duration_ms": 1800000,
  "total_cost_usd": 12.50,
  "top_tools": [
    {"name": "Read", "count": 120},
    {"name": "Edit", "count": 80}
  ]
}
```

### 10.3 UI 设计

- 侧边栏历史记录入口
- 项目列表 + 会话列表双栏布局
- 会话卡片显示：标题、时间、消息数量、使用的工具
- 会话详情页：消息历史、文件变更、工具统计
- 继续会话按钮

### 10.4 优先级

| 功能 | 优先级 |
|------|--------|
| 搜索会话 API | P0 |
| 会话详情 API | P0 |
| 删除会话 API | P0 |
| 前端搜索 UI | P1 |
| 会话筛选功能 | P1 |
| 会话详情页 UI | P1 |
| 批量操作 | P2 |
| 统计面板 | P2 |

## 数据来源

会话数据存储在 `~/.claude/projects/{project_hash}/sessions/*.jsonl`
