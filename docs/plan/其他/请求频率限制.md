# Rate Limiting (请求频率限制)

## 概述

使用 slowapi 添加请求频率限制，防止 API 滥用。

## 需求

### 3.1 限制策略

| 用户级别 | 请求限制 | 适用场景 |
|----------|----------|----------|
| 未认证 | 5/分钟 | 匿名用户 |
| 免费用户 | 30/分钟 | 普通用户 |
| 付费用户 | 100/分钟 | 高级用户 |
| API Key | 200/分钟 | 程序化访问 |

### 3.2 实现方式

使用 slowapi 库：

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/task")
@limiter.limit("30/minute")
async def run_task(request: Request, task: TaskRequest):
    ...
```

### 3.3 响应头

```http
X-RateLimit-Limit: 30
X-RateLimit-Remaining: 25
X-RateLimit-Reset: 1640995200
```

### 3.4 超限响应

```json
HTTP 429 Too Many Requests
{
  "error": "请求频率超限",
  "retry_after": 60
}
```

## 配置

通过环境变量配置：

- `RATE_LIMIT_ENABLED`: 是否启用限流（默认 true）
- `RATE_LIMIT_DEFAULT`: 默认限制（默认 30/分钟）
- `RATE_LIMIT_ANONYMOUS`: 匿名用户限制（默认 5/分钟）

## 扩展

- 支持按 API Key 进行限流
- 支持白名单（跳过限流）
- 使用 Redis 存储计数器（分布式环境）
