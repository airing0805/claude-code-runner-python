# 文件差异对比

## 概述

查看 Claude Code 编辑操作前后的文件差异，支持确认（应用变更）或拒绝（撤销变更）操作。

## 需求

### 12.1 核心功能

| 功能 | 描述 |
|------|------|
| 差异查看 | 查看编辑前后的文件差异 |
| 确认变更 | 应用变更到工作目录 |
| 拒绝变更 | 撤销变更，恢复原文件 |
| 批量操作 | 批量确认或拒绝多个文件 |

### 12.2 API 设计

```json
# 获取文件差异
GET /api/diff/{session_id}/{file_path}

Response: 200 OK
{
  "file_path": "src/main.py",
  "original_content": "def hello():\n    print(\"Hello\")\n    return True",
  "modified_content": "def hello():\n    print(\"Hello\")\n    print(\"World\")\n    return True",
  "diff": [
    {"type": "unchanged", "content": "def hello():", "line_number": 1},
    {"type": "unchanged", "content": "    print(\"Hello\")", "line_number": 2},
    {"type": "added", "content": "    print(\"World\")", "line_number": 3},
    {"type": "unchanged", "content": "    return True", "line_number": 4}
  ],
  "stats": {"added": 1, "removed": 0, "modified": 2},
  "operation": "Edit",
  "timestamp": "2024-01-15T10:30:00Z"
}

# 确认变更（应用编辑）
POST /api/diff/{session_id}/{file_path}/confirm

Request: {"action": "confirm"}

Response: 200 OK
{
  "success": true,
  "file_path": "src/main.py",
  "status": "applied",
  "message": "文件变更已应用到工作目录"
}

# 拒绝变更（撤销编辑）
POST /api/diff/{session_id}/{file_path}/reject

Request: {"action": "reject"}

Response: 200 OK
{
  "success": true,
  "file_path": "src/main.py",
  "status": "rejected",
  "message": "文件已恢复原内容"
}

# 获取会话变更文件列表
GET /api/diff/{session_id}/files

Response: 200 OK
{
  "session_id": "abc123",
  "files": [
    {"file_path": "src/main.py", "operation": "Edit", "has_original": true},
    {"file_path": "src/utils.py", "operation": "Edit", "has_original": true},
    {"file_path": "docs/readme.md", "operation": "Write", "has_original": false}
  ]
}

# 批量确认/拒绝
POST /api/diff/batch

Request:
{
  "session_id": "abc123",
  "actions": [
    {"file_path": "src/main.py", "action": "confirm"},
    {"file_path": "src/utils.py", "action": "reject"}
  ]
}

Response: 200 OK
{
  "success": true,
  "results": [
    {"file_path": "src/main.py", "status": "applied"},
    {"file_path": "src/utils.py", "status": "rejected"}
  ],
  "total": 2,
  "applied": 1,
  "rejected": 1,
  "failed": 0
}
```

### 12.3 UI 设计

- 任务输出区域显示变更文件列表
- 每行显示：[查看差异] [确认] [拒绝] 按钮
- 差异模态框支持三种视图：
  - 统一视图 (Unified)：添加行 + 标记，删除行 - 标记
  - 分割视图 (Split)：左右对比
  - 原始/修改后切换

### 12.4 优先级

| 功能 | 优先级 |
|------|--------|
| 获取文件差异 API | P0 |
| 获取变更文件列表 API | P0 |
| Diff 渲染 UI | P0 |
| 确认变更 | P0 |
| 拒绝变更 | P1 |
| 统一/分割视图 | P1 |
| 批量确认/拒绝 | P1 |
| 语法高亮 | P2 |
| 差异统计显示 | P2 |

## 技术实现

- 使用 Python 标准库 `difflib` 计算差异
- 从会话历史 JSONL 中提取 `old_string` 原始内容
- 路径验证防止目录遍历攻击
