# 版本更新日志

本文档记录 Claude Code Runner 的版本更新历史。

## v0.2.15

### 重构
- **前端代码模块化拆分**
  - 将 `web/static/app.js` (约 1358 行) 拆分为 11 个模块文件
  - 按功能模块、组件进行拆分，提高代码可维护性
  - 更新 `index.html` 中的脚本引用顺序

### 变更详情

#### 模块拆分方案
```
web/static/
├── app.js           # 主入口（初始化和事件绑定）
├── constants.js    # 常量定义（工具列表、视图名称、消息类型）
├── utils.js        # 工具函数（escapeHtml、scrollToBottom 等）
├── components/     # UI 组件
│   ├── toolsMultiselect.js   # 工具多选组件
│   └── tabs.js               # 标签页组件
└── modules/        # 功能模块
    ├── navigation.js     # 导航和视图切换
    ├── workingDir.js    # 工作目录管理
    ├── session.js       # 会话管理
    ├── history.js       # 历史记录管理
    ├── task.js         # 任务执行
    └── messageRenderer.js  # 消息渲染
```

#### 模块职责
- `constants.js`: 定义工具列表、视图名称、消息类型等常量
- `utils.js`: 通用工具函数（HTML转义、时间格式化等）
- `components/toolsMultiselect.js`: 工具多选下拉框交互
- `components/tabs.js`: 标签页的创建、切换、关闭
- `modules/navigation.js`: 导航菜单和视图切换
- `modules/workingDir.js`: 工作目录加载和选择
- `modules/session.js`: 会话状态管理
- `modules/history.js`: 项目和会话历史管理
- `modules/task.js`: 任务执行、流式处理、统计显示
- `modules/messageRenderer.js`: 历史消息渲染（按轮次、按类型）
- `app.js`: 主入口，初始化各模块

#### 修改文件
- `web/static/constants.js` - 新增
- `web/static/utils.js` - 新增
- `web/static/components/toolsMultiselect.js` - 新增
- `web/static/components/tabs.js` - 新增
- `web/static/modules/navigation.js` - 新增
- `web/static/modules/workingDir.js` - 新增
- `web/static/modules/session.js` - 新增
- `web/static/modules/history.js` - 新增
- `web/static/modules/task.js` - 新增
- `web/static/modules/messageRenderer.js` - 新增
- `web/static/app.js` - 重构为入口文件
- `web/templates/index.html` - 更新脚本引用

#### 需求文档更新
- 更新 `docs/需求文档.md` 中的项目结构，添加前端模块拆分后的目录结构

### 新增功能
- **输出区实现方案文档**
  - 创建 `docs/输出实现.md` 文档
  - 完整定义当前会话功能输出区的实现方案
  - 包含数据结构设计、前后端实现代码、场景覆盖检查

### 功能增强
- **后端消息解析**
  - 新增 `parse_content_blocks()` 函数，支持解析所有消息类型
  - 支持内容类型：`text`、`thinking`、`tool_use`、`tool_result`
  - 扩展 `get_session_messages()` API 返回完整消息结构

- **前端消息渲染**
  - 重构 `displayHistoryMessages()` 方法，支持新的消息格式
  - 新增消息渲染辅助方法：
    - `_groupByRounds()` - 按轮次分组消息
    - `_createRoundElement()` - 创建对话轮次元素
    - `_renderUserContent()` - 渲染用户消息内容
    - `_renderAssistantMessages()` - 渲染 AI 响应消息
    - `_renderTextBlock()` - 渲染文本块
    - `_renderThinkingBlock()` - 渲染思考块（可折叠）
    - `_renderToolUseBlock()` - 渲染工具调用块
    - `_renderToolResultBlock()` - 渲染工具结果块

- **新增 CSS 样式**
  - 思考块样式（可折叠显示思考过程）
  - 工具调用样式（显示工具名和参数）
  - 工具结果样式（区分成功和错误）
  - 空内容占位样式

### 场景覆盖
- ✅ 用户文本消息
- ✅ 用户工具结果
- ✅ AI 文本响应
- ✅ AI 思考过程（可折叠）
- ✅ AI 工具调用
- ✅ 工具调用错误
- ✅ 多轮对话
- ✅ 连续 AI 消息合并
- ✅ 空消息内容占位
- ✅ 长内容截断

### 变更详情
- `app/routers/session.py` - 新增 `parse_content_blocks()` 函数，更新 `get_session_messages()` API
- `web/static/app.js` - 重构消息渲染逻辑，新增多种内容块渲染方法
- `web/static/style.css` - 新增思考块、工具调用、工具结果样式

## v0.2.12

### 任务分析
- 分析和拆解当前任务，更新任务内容，避免重复执行

### 需求文档更新
- 更新 `docs/需求文档.md` 中的消息类型部分
- 添加 `thinking`（思考过程）、`tool_result`（工具结果）类型
- 新增 3.1 节"历史消息渲染"说明
- 更新会话消息响应格式，添加内容块（content blocks）结构

### 代码分析
- 后端 API (`parse_content_blocks`, `get_session_messages`) 已实现完整的消息解析
- 前端 (`displayHistoryMessages`, `_groupByRounds`, `_createRoundElement` 等) 已实现完整的历史消息渲染
- 23 个测试用例全部通过

### 注意事项
- 如果历史记录没有显示，请检查：
  1. 浏览器控制台是否有错误信息
  2. API 请求是否返回了数据
  3. `.claude/projects/` 目录下是否有会话文件

## v0.2.10

### 新增文档
- **Claude Code 会话历史记录格式文档**
  - 创建 `docs/会话格式.md` 文档
  - 详细分析 Claude Code 的会话历史记录文件格式
  - 包含所有消息类型和字段的完整说明

### 文档内容
- **存储位置**：说明会话文件的目录结构和命名规则
- **文件格式**：JSONL 格式的详细说明
- **消息类型**：
  - `queue-operation`：队列操作
  - `file-history-snapshot`：文件历史快照
  - `user`：用户消息（初始输入和工具调用结果）
  - `assistant`：AI 响应消息
- **Content 类型**：
  - `text`：文本内容
  - `thinking`：思考过程
  - `tool_use`：工具调用
  - `tool_result`：工具结果
- **消息链关系**：通过 `uuid` 和 `parentUuid` 构建的消息链结构
- **子代理会话**：子代理的独立会话文件格式
- **解析示例**：Python 解析代码示例
- **注意事项**：编码、大文件处理、敏感信息等

## v0.2.9

### Bug 修复
- **会话界面滚动条布局优化**
  - 修复滚动条出现在整个页面的问题，确保滚动条只在输出区（会话信息和对话框的中间区域）
  - 为 `html` 和 `body` 添加 `height: 100%` 和 `overflow: hidden`
  - 为所有 flex 容器添加 `min-height: 0`，确保 flex 布局中子元素能正确缩小
  - 为 `.session-output` 添加 `min-height: 0`，确保该区域能独立滚动

### 变更详情
- `web/static/style.css` - 布局优化
  - `html, body` - 添加 `height: 100%` 和 `overflow: hidden`
  - `.app-layout` - 从 `min-height: 100vh` 改为 `height: 100%`
  - `.main-content` - 添加 `min-height: 0`
  - `.view-panel` - 添加 `min-height: 0`
  - `.session-layout` - 添加 `min-height: 0`
  - `.session-output` - 添加 `min-height: 0`
  - `.tabs-content` - 添加 `min-height: 0` 和 `overflow: hidden`
  - `.tab-panel.active` - 从 `display: block` 改为 `display: flex; flex-direction: column`
  - `.page-container` - 添加 `min-height: 0`

## v0.2.8

### Bug 修复
- **会话界面滚动条布局**
  - 修复滚动条位置问题，确保滚动条只在输出区
  - 输入框和统计信息区固定在底部，不会被压缩
  - 为所有固定区域添加 `flex-shrink: 0` 属性

- **历史记录刷新**
  - 修复点击项目进入会话列表时数据不更新的问题
  - 返回项目列表时自动刷新项目数据
  - 每次进入会话列表都重新获取最新数据

### 变更详情
- `web/static/style.css` - 布局优化，添加 `overflow: hidden` 和 `flex-shrink: 0`
- `web/static/app.js` - 历史记录刷新逻辑优化

## v0.2.7

### Bug 修复
- **标签切换修复**
  - 修复切换到新任务标签时显示其他会话内容的问题
  - 重构 `switchToTab` 函数，确保切换时正确清空和填充内容

- **用户输入显示修复**
  - 修复用户输入在会话内容区不显示的问题
  - 优化清空输入框的时机，确保消息添加到 DOM 后不被意外清空

- **历史消息渲染修复**
  - 修复历史会话中对话内容不完整显示的问题
  - 合并连续的 assistant 消息内容
  - 用户内容为空时显示占位文本 "(无内容)"

### 变更详情
- `web/static/app.js` - `switchToTab()` 方法重构
- `web/static/app.js` - `startNewRound()` 方法优化
- `web/static/app.js` - `displayHistoryMessages()` 方法优化，新增 `_addAssistantMessageToRound()` 辅助方法
- `app/routers/session.py` - `get_session_messages()` API 优化

## v0.2.6

### 新增功能
- **多轮对话支持**：会话界面支持多轮对话，每次执行后可继续输入新任务
- **对话结构优化**：重新设计对话显示结构，清晰区分各轮对话

### 变更详情

#### 多轮对话
- 每轮对话包含用户输入和 AI 响应两个区域
- 新增轮次编号显示，便于追踪对话历史
- 执行完成后会话 ID 自动填充，支持在当前会话中继续对话
- 清空按钮仅清空当前标签的对话，不影响其他标签页

#### 对话显示优化
- 用户消息使用紫色主题背景
- AI 响应使用蓝色/绿色主题
- 工具调用、错误消息、完成消息使用不同颜色边框区分
- 滚动条保持在对话输出区，自动滚动到最新消息
- 历史消息按轮次分组显示，恢复历史会话时保持对话结构

#### 修改文件
- `web/static/app.js` - 新增多轮对话管理方法
- `web/static/style.css` - 新增多轮对话样式

## v0.2.5

### 新增功能
- **版本历史独立**：将版本历史从需求文档中独立到 更新日志.md
- **工作目录手动输入**：新会话中的工作目录支持手动输入任意路径，不再限于下拉选择
- **工具权限布局优化**：工具权限下拉选项改为一行显示 2 个权限选项，提升操作效率

### 变更详情

#### 版本历史独立
- 创建 `docs/更新日志.md` 文件，独立管理版本更新历史
- 从 `docs/需求文档.md` 中移除版本历史部分，保持需求文档的清晰性
- 版本任务记录仍保留在 `docs/v0.2.md` 中

#### 工作目录手动输入
- 新会话时，工作目录从纯下拉选择改为可编辑的 combo box
- 用户可以手动输入任意路径作为工作目录
- 仍保留从项目列表加载的下拉选项供快速选择
- 历史会话的工作目录保持锁定状态

#### 工具权限布局
- 工具下拉框改为两列布局
- 每行显示 2 个工具选项，减少滚动
- 保持原有的全选/单选功能

## v0.2.4

### Bug 修复
- **路径解析修复**
  - 修复项目列表显示的路径与实际路径不一致的问题
  - 修复 `[WinError 267] 目录名称无效` 错误

### 变更详情
- **问题根因**：`decode_project_name` 函数假设所有 `-` 替换为 `\`，但路径中本身包含 `-`（如 `workspaces-2026`），导致解码错误
- **解决方案**：从会话文件的 `cwd` 字段读取真实的项目路径，而不是尝试解码目录名
- **修改文件**：`app/routers/session.py`
  - `parse_session_metadata()` - 新增提取 `cwd` 字段
  - `list_projects()` - 使用会话文件中的 `cwd` 作为项目路径
  - `list_project_sessions()` - 使用会话文件中的 `cwd` 作为项目路径
  - `get_session_messages()` - 使用会话文件中的 `cwd` 作为项目路径

## v0.2.3

### 新增功能
- **项目列表新会话按钮**
  - 在项目列表每一行添加"新会话"按钮
  - 点击按钮直接创建新会话标签页
  - 自动设置工作目录为对应项目路径
  - 自动切换到当前会话视图并聚焦任务输入框
  - 点击项目信息区域仍可进入会话列表

### 优化
- **模块结构优化**
  - 将 `src/claude_runner/` 迁移到 `app/claude_runner/`
  - 统一代码结构，所有应用代码位于 `app/` 目录下
  - 更新所有导入路径

## v0.2.2

### 新增功能
- **前端页面迁移**
  - 将 `app/templates` 和 `app/static` 迁移到项目根目录的 `web/` 目录
  - 更新 `app/main.py` 路径配置指向新的 `web/` 目录

- **工作目录下拉选择**
  - 将工作目录输入框改为下拉选择框
  - 从项目列表 API 加载可用的工作目录选项
  - 支持鼠标悬停显示完整路径

- **会话字段锁定**
  - 新会话：工作目录可选择，会话ID显示"新会话"
  - 历史会话：工作目录和会话ID自动锁定（禁用编辑）
  - 任务执行完成后自动锁定会话字段
  - 鼠标悬停显示完整内容

- **新会话按钮**
  - 信息栏右侧添加"新会话"按钮
  - 点击创建新的标签页，重置所有输入状态

- **会话状态更新**
  - 执行完成后自动显示会话ID
  - 新任务标签自动转换为会话标签（图标从 ➕ 变为 💬）
  - 标签标题根据任务描述自动生成

## v0.2.1

### 新增功能
- **布局调整**
  - 统一所有视图的页面布局结构
  - 历史记录和示例任务视图自适应窗口宽度

- **工具权限多选**
  - 替换文本输入为多选下拉框组件
  - 支持全选/取消选择工具
  - 显示已选工具数量徽章

- **会话界面修复**
  - 从历史会话继续时正确回填工作目录
  - 切换标签时正确恢复/清空会话数据
  - 增强清空按钮功能
  - 任务执行区自动滚动到最底端

- **历史会话列表**
  - 切换视图时强制刷新数据
  - 项目列表显示工具使用汇总

- **API 优化**
  - 拆分 main.py 为模块化路由结构
  - 项目列表 API 返回工具汇总
  - 会话消息 API 返回项目路径

## v0.1.0

### 初始功能
- 基础任务执行功能
- Web 界面
- SSE 流式输出
- 会话延续支持
- 历史记录管理
- 示例任务
