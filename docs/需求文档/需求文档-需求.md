# Claude Code Runner 需求文档

## 项目概述

Claude Code Runner 是 Claude Code SDK 的 Web 服务封装，通过 FastAPI 提供 REST API 和 Web 界面来调用 Claude Code 执行编程任务。

### 核心目标

- 提供 Web 界面调用 Claude Code 执行任务
- 支持会话延续和历史记录管理
- 支持 SSE 流式输出实时显示执行过程

---

## 功能需求

### 1. 任务执行

#### 1.1 基本任务执行
- 用户输入任务描述（prompt）
- 设置工作目录（working_dir）
- 配置允许的工具列表（tools）
- 执行任务并显示结果

#### 1.2 会话延续支持
- **continue_conversation**: 延续 CLI 中最近的对话历史
- **resume**: 通过会话 ID 恢复特定会话
- 会话 ID 自动提取和显示

#### 1.3 任务控制
- 停止正在执行的任务（使用 AbortController）
- 清空输出区域

#### 1.4 执行模式
- **同步模式**: POST /api/task，等待完整结果返回
- **流式模式**: POST /api/task/stream，SSE 实时推送执行过程

### 2. Web 界面

#### 2.1 整体布局
- 左侧：可收起的导航菜单（200px，可收起至 56px）
- 右侧：内容区域，根据菜单切换显示不同视图

#### 2.2 导航菜单
| 菜单项 | 图标 | 功能 |
|--------|------|------|
| 当前会话 | 💬 | 任务执行主界面 |
| 历史记录 | 📜 | 查看历史会话 |
| 示例任务 | 📋 | 快速填充任务示例 |

#### 2.3 当前会话视图（三区布局）

```
┌─────────────────────────────────────┐
│ 标题栏：菜单按钮 + 标题              │
├─────────────────────────────────────┤
│ 标签页栏：新任务 / 会话标签          │
├─────────────────────────────────────┤
│ 信息栏：工作目录(下拉)、会话ID、     │
│         工具权限(多选)、继续会话、   │
│         新会话按钮                   │
├─────────────────────────────────────┤
│                                     │
│        会话过程显示区                │
│        （消息流、工具调用等）         │
│        自动滚动到最新消息            │
│                                     │
├─────────────────────────────────────┤
│ 统计信息：状态、耗时、费用、会话ID   │
├─────────────────────────────────────┤
│ 输入区：文本框 + 执行/停止/清空按钮  │
└─────────────────────────────────────┘
```

**交互行为**：
- 会话过程显示区在有新消息时自动滚动到底部，确保用户始终看到最新内容
- 清空按钮清除当前显示的消息和统计信息，但不影响会话 ID（会话仍可继续）
- 统计信息区的会话 ID 可点击复制到剪贴板

#### 2.4 标签页系统
- 默认显示"新任务"标签
- 点击"继续此会话"时创建会话标签
- 点击"新会话"按钮创建新的任务标签
- 每个标签存储会话 ID、历史消息和工作目录
- **切换标签行为**：
  - 切换标签时自动恢复对应的会话信息（会话ID、工作目录、历史消息）
  - 切换到新任务标签时清空显示，重置输入状态
  - 从历史会话继续时正确回填工作目录
- 标签可关闭（默认的新任务标签除外）
- **会话状态更新**：执行完成后自动更新标签标题为会话描述

#### 2.5 会话字段管理
- **工作目录选择**：可编辑的组合框（combo box），支持从项目列表选择或手动输入任意路径 (v0.2.5+)
- **会话ID显示**：位于工作目录右侧，只读显示
- **字段锁定规则**：
  - 新会话：工作目录可选择或手动输入，会话ID显示"新会话"
  - 历史会话：工作目录和会话ID自动锁定（禁用编辑），确保会话上下文一致
  - 执行完成后：自动锁定工作目录和会话ID字段
- **历史会话回填**：从历史记录继续会话时，自动回填对应的工作目录路径
- **悬停提示**：鼠标悬停时显示完整内容（工作目录路径、会话ID）

#### 2.6 工具权限选择
- **多选下拉框组件**：替代原有的文本输入
- **两列布局**：一行显示 2 个工具选项，提升操作效率 (v0.2.5+)
- 显示已选工具数量徽章
- 支持全选/取消选择
- 点击外部自动关闭下拉框

#### 2.7 新会话按钮
- 位置：信息栏最右侧
- 功能：点击创建新的标签页，重置所有输入状态
- 样式：紫色边框按钮，悬停时背景变紫

#### 2.8 历史记录视图
- **统一页面布局**：与当前会话视图一致的头部样式（包含菜单按钮和标题栏）
- **自适应窗口宽度**：内容区域填充整个可用空间，无固定宽度限制
- **第一级**：项目列表
  - 显示所有有会话记录的项目
  - 显示项目路径和会话数量
  - 显示项目已使用的工具列表
  - **每行提供"新会话"按钮** (v0.2.3+)：点击直接创建新会话并设置工作目录
- **第二级**：会话列表
  - 选择项目后显示该项目的会话
  - 显示会话标题、时间、消息数量
  - 提供"继续此会话"按钮
- **数据刷新**：切换到历史视图时强制重新加载数据，确保显示最新的会话记录

#### 2.9 示例任务视图
- **统一页面布局**：与当前会话视图一致的头部样式（包含菜单按钮和标题栏）
- **自适应窗口宽度**：内容区域填充整个可用空间，无固定宽度限制
- 网格布局展示示例任务卡片
- 点击卡片自动跳转到当前会话并填充任务描述
- 示例任务包括：
  - 列出 Python 文件
  - 总结代码功能
  - 查找 TODO
  - 生成 README
  - 安全检查
  - 性能优化

### 3. 消息类型

| 类型 | 说明 | 样式 |
|------|------|------|
| text | 文本内容 | 蓝色边框 |
| thinking | 思考过程 (v0.2.11+) | 黄色背景，可折叠 |
| tool_use | 工具调用 | 绿色边框 |
| tool_result | 工具结果 | 蓝色边框 |
| error | 错误信息 | 红色边框 |
| complete | 任务完成 | 蓝色边框 |
| info | 提示信息 | 天蓝色边框 |

#### 3.1 历史消息渲染 (v0.2.11+)

- 支持多轮对话显示，每轮包含用户输入和 AI 响应
- 按轮次分组显示，每轮显示轮次编号
- 工具调用显示工具名称和参数
- 工具结果可区分成功/错误状态
- 思考过程默认折叠，点击可展开

### 4. 统计信息

任务完成后显示：
- **状态**: 成功/失败
- **耗时**: 秒
- **费用**: 美元
- **会话ID**: 可点击复制

### 5. 快捷键

- `Ctrl + Enter`: 执行任务

---

## API 接口

### REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | / | Web 界面主页 |
| POST | /api/task | 同步执行任务 |
| POST | /api/task/stream | SSE 流式执行任务 |
| GET | /api/status | 服务状态 |
| GET | /api/tools | 可用工具列表 |
| GET | /api/projects | 获取所有项目列表（含工具汇总） |
| GET | /api/projects/{name}/sessions | 获取项目会话列表 |
| GET | /api/sessions/{id}/messages | 获取会话消息历史（含项目路径） |

### API 拆分架构 (v0.2.1+)

```
app/
├── main.py              # 应用入口
└── routers/
    ├── task.py          # 任务执行 API
    ├── session.py       # 会话历史 API
    └── status.py        # 状态和工具 API
```

### 请求参数 (TaskRequest)

```json
{
  "prompt": "任务描述",
  "working_dir": "工作目录（可选）",
  "tools": ["Read", "Write", "Edit", "Bash", "Glob", "Grep"],
  "continue_conversation": false,
  "resume": "会话ID（可选）"
}
```

### 响应格式 (TaskResponse)

```json
{
  "success": true,
  "message": "响应消息",
  "session_id": "会话ID",
  "cost_usd": 0.01,
  "duration_ms": 5000,
  "files_changed": ["file1.py", "file2.py"],
  "tools_used": ["Read", "Write"]
}
```

### 项目列表响应 (v0.2.1+)

```json
{
  "projects": [
    {
      "encoded_name": "E--workspaces-2026-python",
      "path": "E:\\workspaces_2026_python\\project",
      "session_count": 5,
      "tools": ["Read", "Write", "Edit", "Bash"]
    }
  ]
}
```

### 会话消息响应 (v0.2.1+, v0.2.11+ 内容块扩展)

```json
{
  "session_id": "abc123...",
  "project_path": "E:\\workspaces_2026_python\\project",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "任务描述"
        },
        {
          "type": "tool_result",
          "tool_use_id": "call_xxx",
          "content": "工具返回结果",
          "is_error": false
        }
      ],
      "timestamp": "2024-01-01T00:00:00Z",
      "uuid": "消息UUID"
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "thinking",
          "thinking": "思考过程内容..."
        },
        {
          "type": "text",
          "text": "AI 响应文本"
        },
        {
          "type": "tool_use",
          "tool_name": "Read",
          "tool_input": {"file_path": "xxx"},
          "tool_use_id": "call_yyy"
        }
      ],
      "timestamp": "2024-01-01T00:00:01Z",
      "uuid": "消息UUID",
      "stop_reason": "tool_use",
      "usage": {
        "input_tokens": 1500,
        "output_tokens": 300
      }
    }
  ]
}
```

---

## 技术架构

### 项目结构 (v0.2.3+, v0.2.15+)

```
claude-code-runner/
├── app/
│   ├── main.py              # FastAPI 应用入口
│   ├── claude_runner/       # Claude Code SDK 封装 (v0.2.3+)
│   │   ├── __init__.py
│   │   └── client.py
│   └── routers/
│       ├── task.py          # 任务执行 API
│       ├── session.py       # 会话历史 API
│       └── status.py        # 状态和工具 API
├── web/                     # 前端资源 (v0.2.2+)
│   ├── templates/
│   │   └── index.html       # 主页面模板
│   └── static/
│       ├── app.js           # 前端交互逻辑主入口 (v0.2.15+)
│       ├── constants.js     # 常量定义 (v0.2.15+)
│       ├── utils.js         # 工具函数 (v0.2.15+)
│       ├── components/      # UI 组件 (v0.2.15+)
│       │   ├── toolsMultiselect.js  # 工具多选组件
│       │   └── tabs.js              # 标签页组件
│       └── modules/         # 功能模块 (v0.2.15+)
│           ├── navigation.js        # 导航和视图切换
│           ├── workingDir.js       # 工作目录管理
│           ├── session.js          # 会话管理
│           ├── history.js          # 历史记录管理
│           ├── task.js             # 任务执行
│           └── messageRenderer.js  # 消息渲染
│       └── style.css        # 样式表
└── tests/
    └── test_runner.py       # 测试用例
```

### 后端

- **框架**: FastAPI + Uvicorn
- **SDK**: claude-code-sdk
- **模板**: Jinja2

### 前端

- **纯 JavaScript** (无框架)
- **CSS**: 自定义 CSS 变量主题
- **通信**: Fetch API + SSE

### 数据存储

- 会话记录存储在 `~/.claude/projects/<encoded-path>/*.jsonl`
- 项目目录名使用编码后的路径（如 `E--workspaces-2026-python`）

---

## 配置项

| 环境变量 | 说明 | 默认值 |
|----------|------|--------|
| ANTHROPIC_API_KEY | Claude API 密钥 | - |
| WORKING_DIR | 默认工作目录 | . |
| HOST | 服务器地址 | 127.0.0.1 |
| PORT | 服务器端口 | 8000 |

---

## 响应式设计

### 桌面端
- 左侧固定导航菜单
- 信息栏完整显示

### 移动端 (≤768px)
- 导航菜单隐藏，点击按钮展开
- 信息栏标签隐藏，只显示输入框
- 输入区和按钮垂直排列

---

## 版本历史

版本更新历史请参阅 [更新日志](./更新日志.md)。
