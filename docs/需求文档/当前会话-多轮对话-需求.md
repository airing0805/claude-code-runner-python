# 当前会话 - 多轮对话需求

## 1. 概述

本文档定义当前会话中多轮对话功能的通用业务规则和交互规范，为具体的多轮对话实现场景（如AskUserQuestion）提供统一的架构指导。

## 2. 多轮对话通用概念

### 2.1 定义
多轮对话是指在单次用户请求的执行过程中，AI代理需要与用户进行多次交互以获取必要信息或确认操作的对话模式。

### 2.2 核心特征
- **上下文保持**：在整个对话过程中保持任务上下文
- **状态管理**：每个对话轮次都有明确的状态标识
- **实时交互**：支持流式响应和即时用户反馈
- **并发控制**：限制同时进行的对话数量，防止资源耗尽

## 3. 多轮对话通用业务场景

### 3.1 信息收集场景
- 用户需要提供多个参数或配置选项
- 分步骤收集复杂输入信息
- 验证用户意图和权限

### 3.2 决策确认场景  
- 执行高风险操作前的多重确认
- 条件分支选择
- 权限级别验证

### 3.3 功能探索场景
- 向用户展示可用的交互选项
- 教学演示和引导
- 功能发现和使用指导

## 4. 多轮对话通用规则

### 4.1 对话生命周期
```
初始化 → 等待用户输入 → 接收用户响应 → 处理响应 → [继续对话 | 结束对话]
```

### 4.2 状态管理规则
- 每个对话实例必须有唯一标识符
- 必须支持完整的状态转换：PENDING → SHOWING → ANSWERED → PROCESSING → COMPLETED/ERROR/TIMEOUT
- 超时机制：每个对话轮次必须有超时时间限制
- 错误处理：必须提供明确的错误状态和恢复机制

### 4.3 并发控制规则
- 默认最大并发对话数：5个
- 支持队列机制处理超出并发限制的对话请求
- 必须提供并发状态监控和管理接口

### 4.4 安全规则
- 所有用户输入必须经过安全验证和清理
- 必须防止恶意输入和注入攻击
- 对话数据必须进行适当的日志记录和审计

## 5. 多轮对话通用接口规范

### 5.1 前端接口
- SSE流式消息格式标准化
- 对话框组件接口规范
- 状态更新通知机制

### 5.2 后端接口  
- REST API接口规范
- 会话管理接口
- 答案提交接口

### 5.3 数据结构规范
- 统一的问答数据模型
- 标准化的选项定义格式
- 一致的消息传输格式

## 6. 具体实现场景

多轮对话的具体实现应遵循本通用规范，并可扩展特定场景的功能：

- **AskUserQuestion场景**：基于工具调用的问答交互
- **PermissionConfirmation场景**：权限确认对话
- **ParameterCollection场景**：参数收集对话
- **其他自定义场景**：根据具体需求实现的对话模式

## 7. 相关文档

- `当前会话-多轮对话-技术设计.md`：技术实现规范
- `当前会话-多轮对话-AskUserQuestion-需求.md`：AskUserQuestion具体实现需求
- `当前会话-多轮对话-AskUserQuestion-技术设计.md`：AskUserQuestion具体实现技术设计