# 任务调度

## 概述

任务调度功能提供 24/7 自动化任务执行能力，支持立即执行任务队列和基于 Cron 表达式的定时任务调度，适用于自动化代码检查、文档更新、测试运行等重复性任务。

> **来源**: 基于 `claude-code-24h-integration` 项目功能迁移

---

## 1. 功能概述

### 1.1 系统架构

调度器 (Scheduler)
  - 定时轮询 (默认 10 秒)
  - 检查定时任务是否到期
  - 从队列中获取任务执行
  - 管理任务状态

任务存储 (JSON 文件)
  - queue.json         # 待执行任务队列
  - scheduled.json     # 定时任务配置
  - running.json      # 当前运行任务
  - completed.json    # 已完成任务历史
  - failed.json       # 失败任务记录

任务执行器 (Executor)
  - 调用 ClaudeCodeClient 执行任务
  - 支持超时控制
  - 自动重试 (最多 2 次)

---

## 2. API 端点

### 2.1 任务队列管理

POST   /api/tasks           # 添加任务
GET    /api/tasks           # 获取队列列表
DELETE /api/tasks/{id}      # 删除任务
DELETE /api/tasks/clear     # 清空队列

### 2.2 定时任务管理

POST   /api/scheduled-tasks           # 创建定时任务
GET    /api/scheduled-tasks           # 获取任务列表
PATCH  /api/scheduled-tasks/{id}     # 更新任务
DELETE /api/scheduled-tasks/{id}     # 删除任务
POST   /api/scheduled-tasks/{id}/toggle   # 启用/禁用
POST   /api/scheduled-tasks/{id}/run      # 立即执行

### 2.3 任务状态查询

GET /api/tasks/running      # 获取运行中任务
GET /api/tasks/completed    # 获取已完成任务（分页）
GET /api/tasks/failed       # 获取失败任务（分页）

### 2.4 调度器控制

GET  /api/scheduler/status   # 获取调度器状态
POST /api/scheduler/start    # 启动调度器
POST /api/scheduler/stop     # 停止调度器

---

## 3. Cron 表达式说明

支持格式: 5位标准 `分 时 日 月 周` 或 6位扩展 `秒 分 时 日 月 周`

示例:
0 9 * * *        # 每天 9:00
*/30 * * * *     # 每 30 分钟
0 9 * * 1-5     # 周一到周五 9:00
0 0,12 * * *    # 每天 0:00 和 12:00
1 */1 * * *      # 每小时的第 1 秒
*/25 * * * *     # 每 25 分钟

---

## 4. 数据模型

class Task:
    id: str                          # 任务唯一标识
    prompt: str                       # 任务描述
    workspace: str = "."              # 工作目录
    timeout: int = 600000            # 超时时间（毫秒）
    auto_approve: bool = False         # 是否自动批准
    allowed_tools: list[str] | None = None  # 允许使用的工具
    created_at: str                  # 创建时间
    retries: int = 0                 # 重试次数
    status: TaskStatus = TaskStatus.PENDING
    scheduled: bool = False            # 是否来自定时任务
    scheduled_id: str | None = None    # 定时任务ID

class ScheduledTask:
    id: str                          # 任务唯一标识
    name: str                         # 任务名称
    prompt: str                       # 任务描述
    workspace: str = "."              # 工作目录
    cron: str                        # Cron 表达式
    timeout: int = 600000            # 超时时间（毫秒）
    auto_approve: bool = False         # 是否自动批准
    allowed_tools: list[str] | None = None
    enabled: bool = True              # 是否启用
    last_run: str | None = None      # 上次执行时间
    next_run: str                    # 下次执行时间
    created_at: str                  # 创建时间

class TaskStatus(Enum):
    PENDING = "pending"      # 待执行
    RUNNING = "running"      # 运行中
    COMPLETED = "completed"  # 已完成
    FAILED = "failed"        # 失败
    CANCELLED = "cancelled"  # 已取消

---

## 5. 后端目录结构

app/scheduler/
    __init__.py
    models.py               # Task, ScheduledTask 数据模型
    storage.py              # JSON 文件存储
    cron.py                # Cron 表达式解析器
    executor.py            # 任务执行器
    scheduler.py           # 主调度器
    config.py              # 配置常量

app/routers/
    scheduler.py           # 调度相关 API 路由

data/
    queue.json                 # 待执行任务队列
    scheduled.json             # 定时任务配置
    running.json              # 当前运行任务
    completed.json            # 已完成任务历史
    failed.json               # 失败任务记录

---

## 6. 验收标准

### 6.1 功能验收
- [ ] 添加任务到队列
- [ ] 获取任务队列列表
- [ ] 删除队列中的任务
- [ ] 清空任务队列
- [ ] 创建定时任务
- [ ] Cron 表达式正确解析
- [ ] 更新定时任务
- [ ] 启用/禁用定时任务
- [ ] 立即执行定时任务
- [ ] 删除定时任务
- [ ] 获取运行中任务
- [ ] 获取已完成任务（分页）
- [ ] 获取失败任务（分页）
- [ ] 任务执行超时控制
- [ ] 任务失败重试（最多 2 次）
- [ ] 获取调度器状态
- [ ] 启动/停止调度器
- [ ] 定时任务到期自动加入队列

### 6.2 UI 验收
- [ ] 左侧导航显示「任务调度」入口
- [ ] 标签页切换流畅
- [ ] 任务列表正确显示
- [ ] 定时任务列表显示下次运行时间
- [ ] 添加任务对话框功能完整
- [ ] Cron 表达式验证实时反馈
- [ ] 调度器状态实时更新
- [ ] 响应式布局适配移动端

### 6.3 API 验收
- [ ] POST /api/tasks 返回 201
- [ ] GET /api/tasks 返回队列列表
- [ ] DELETE /api/tasks/{id} 返回 204
- [ ] POST /api/scheduled-tasks 返回 201
- [ ] GET /api/scheduled-tasks 返回任务列表
- [ ] PATCH /api/scheduled-tasks/{id} 返回 200
- [ ] GET /api/scheduler/status 返回状态
- [ ] POST /api/scheduler/start 返回 200
- [ ] POST /api/scheduler/stop 返回 200

### 6.4 测试验收
- [ ] Cron 解析器单元测试
- [ ] 任务队列管理单元测试
- [ ] 任务执行器集成测试
- [ ] 调度器功能测试
- [ ] API 端点测试
- [ ] 前端交互测试
