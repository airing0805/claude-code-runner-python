# 当前会话 - AskUserQuestion 多轮对话业务规则

## 1. 概述

本文档定义当前会话中 AskUserQuestion 工具在多轮对话场景下的业务规则和交互规范，基于实际会话记录分析制定。

## 2. 多轮对话业务场景

### 2.1 典型使用场景
- **功能探索**：用户想了解工具的使用方式和效果
- **逐步确认**：复杂的决策需要分步骤进行
- **教学演示**：向用户展示交互式问答的工作流程
- **权限验证**：多层权限确认机制

### 2.2 对话模式分类

#### 2.2.1 递进式选择模式
```
用户意图：通过重复相同的选择来体验多轮对话过程
示例场景：用户选择"再给一个多选框还是这些选项"来观察对话行为
业务规则：
- 允许在同一会话中连续发起多个相同的AskUserQuestion
- 每次对话保持独立的状态管理
- 支持无限递归（受系统资源限制）
```

#### 2.2.2 条件分支模式
```
用户意图：根据前一次选择决定后续问题
示例场景：选择不同选项触发不同的后续问题
业务规则：
- 支持基于用户答案的条件性后续问题
- follow_up_questions 机制实现分支逻辑
- 保持对话上下文的连贯性
```

#### 2.2.3 最终执行模式
```
用户意图：完成选择后执行具体操作
示例场景：选择"背唐诗"后实际执行背诵功能
业务规则：
- 最终选择触发具体的业务逻辑执行
- 支持从问答状态平滑过渡到执行状态
- 提供完整的操作反馈
```

## 3. 会话管理规则

### 3.1 会话生命周期

#### 3.1.1 会话创建
```
触发条件：
- 用户首次发起AskUserQuestion请求
- 系统生成唯一sessionId (UUID格式)
- 初始化会话状态为pending

状态转换：
created → pending → answered/cancelled
```

#### 3.1.2 多轮对话状态管理
```
每轮对话独立状态：
- 每个tool_use_id对应一个独立的问答实例
- 支持并行多个未完成的问答
- 通过parentUuid维护对话顺序关系
```

### 3.2 消息链结构

#### 3.2.1 基本消息链
```
[user] → [assistant:tool_use] → [user:tool_result] → [assistant:text/response]
```

#### 3.2.2 多轮对话消息链
```
[user:init] 
→ [assistant:tool_use_1] 
→ [user:tool_result_1] 
→ [assistant:tool_use_2] 
→ [user:tool_result_2] 
→ ... 
→ [assistant:final_action]
```

### 3.3 时间戳管理
```
格式要求：ISO 8601标准 (YYYY-MM-DDTHH:mm:ss.sssZ)
精度要求：毫秒级
时区要求：UTC时间
```

## 4. 工具调用规范

### 4.1 工具标识规则

#### 4.1.1 调用ID生成
```
格式：call_function_{random_string}_{sequence_number}
示例：call_function_8kherxj202p7_1
规则：
- random_string：8-12位随机字符串
- sequence_number：从1开始的序号
- 同一会话内保持唯一性
```

#### 4.1.2 会话关联
```
关联字段：
- sessionId：会话唯一标识
- parentUuid：父消息关联
- sourceToolAssistantUUID：源工具调用关联
```

### 4.2 问题结构规范

#### 4.2.1 基础问题格式
```json
{
  "header": "选择功能",
  "question": "请选择一个功能",
  "multiSelect": true,
  "options": [
    {
      "label": "背唐诗",
      "description": "背诵一首经典唐诗"
    },
    {
      "label": "讲笑话",
      "description": "讲一个有趣的笑话"
    },
    {
      "label": "输出笑脸图标",
      "description": "输出一个笑脸表情"
    }
  ]
}
```

#### 4.2.2 选项设计原则
```
label要求：
- 简洁明了，建议不超过10个字符
- 直接表达选项含义
- 避免歧义

description要求：
- 提供详细说明和上下文
- 解释选项的具体作用
- 帮助用户做出明智选择
```

## 5. 用户交互规则

### 5.1 选择行为规范

#### 5.1.1 多选支持
```
multiSelect = true时：
- 用户可以选择零个、一个或多个选项
- UI显示为复选框形式
- 返回数组格式的答案

multiSelect = false时：
- 用户只能选择一个选项
- UI显示为单选按钮形式
- 返回字符串格式的答案
```

#### 5.1.2 特殊选项处理
```
"再给一个多选框还是这些选项"选项：
- 作为元选项存在，用于体验多轮对话
- 系统应识别此类选项并正确处理
- 不应视为错误或异常情况
```

### 5.2 响应处理规则

#### 5.2.1 答案格式
```json
// 单选答案
{
  "请选择一个功能": "背唐诗"
}

// 多选答案
{
  "请选择一个功能": ["背唐诗", "讲笑话"]
}
```

#### 5.2.2 答案验证
```
验证规则：
- 答案必须在可选项范围内
- 多选时验证每个选项的有效性
- 空答案处理（根据required字段）
```

## 6. 错误处理机制

### 6.1 异常场景处理

#### 6.1.1 重复选择场景
```
场景：用户连续选择相同的行为选项
处理规则：
- 允许正常执行，不视为错误
- 系统应能正确处理递归对话
- 保持良好的用户体验
```

#### 6.1.2 会话超时处理
```
超时设置：
- 单个问答超时：300秒（5分钟）
- 会话总超时：3600秒（1小时）
- 超时后自动清理资源
```

### 6.2 错误恢复机制
```
恢复策略：
- 支持会话恢复（通过sessionId）
- 提供错误上下文信息
- 允许用户重新发起问答
```

## 7. 性能优化要求

### 7.1 资源管理
```
内存控制：
- 限制同时进行的问答数量
- 及时清理已完成的对话状态
- 防止内存泄漏

并发控制：
- 同一会话内限制并发问答数
- 队列管理等待中的请求
- 合理分配系统资源
```

### 7.2 响应时间要求
```
响应指标：
- 问答弹出延迟：< 100ms
- 答案提交响应：< 200ms
- 状态同步延迟：< 50ms
```

## 8. 日志记录规范

### 8.1 必要日志信息
```
记录内容：
- 会话开始/结束时间
- 每轮问答的详细信息
- 用户选择和系统响应
- 异常情况和错误信息
- 性能指标数据
```

### 8.2 日志格式要求
```
JSONL格式：
- 每行一个独立的JSON对象
- 包含timestamp、type、sessionId等基本信息
- 结构化存储便于分析和查询
```

## 9. 安全考虑

### 9.1 输入验证
```
验证要点：
- 选项内容的安全性检查
- 防止恶意脚本注入
- 限制输入长度和复杂度
```

### 9.2 权限控制
```
权限级别：
- 会话级别的访问控制
- 工具调用权限验证
- 敏感操作的额外确认
```

## 10. 测试验证要求

### 10.1 功能测试场景
```
必须测试的场景：
- 单轮问答的基本功能
- 多轮连续问答
- 递归对话处理
- 异常情况恢复
- 边界条件处理
```

### 10.2 性能测试指标
```
关键指标：
- 并发处理能力
- 内存使用情况
- 响应时间稳定性
- 长时间运行稳定性
```

---
*文档版本：1.0*
*最后更新：2026-02-22*
*基于实际会话记录分析制定*