# 任务执行

## 1. 页面布局

### 1.1 整体布局结构

```
┌─────────────────────────────────────────────────────────────────┐
│                      左侧菜单栏 (可收起)                          │
│  ┌──────┐  ┌─────────────────────────────────────────────────┐  │
│  │ Logo │  │              右侧内容区                          │  │
│  ├──────┤  │  ┌─────────────────────────────────────────┐  │  │
│  │当前会话│  │  │  顶部：标题栏 + 标签页                    │  │  │
│  ├──────┤  │  ├─────────────────────────────────────────┤  │  │
│  │历史记录│  │  │  信息栏：工作目录 | 会话ID | 工具 | 继续会话│  │  │
│  ├──────┤  │  ├─────────────────────────────────────────┤  │  │
│  │示例任务│  │  │                                         │  │  │
│  ├──────┤  │  │  中间：输出显示区                          │  │  │
│  │Claude│  │  │  (任务执行过程和结果)                       │  │  │
│  │状态  │  │  │                                         │  │  │
│  ├──────┤  │  ├─────────────────────────────────────────┤  │  │
│  │...   │  │  │  底部：输入区 + 工具栏                    │  │  │
│  └──────┘  │  └─────────────────────────────────────────┘  │  │
│             └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 菜单栏 (左侧导航)

| 菜单项 | 图标 | 功能说明 |
|--------|------|----------|
| 当前会话 | 💬 | 任务执行主界面 |
| 历史记录 | 📜 | 查看历史会话 |
| 示例任务 | 📋 | 快速填充任务模板 |
| Claude 状态 | ⚙️ | 查看 Claude Code 运行状态 |
| Claude 文档 | 📚 | 工具详解、代理类型等文档 |
| Agent 监控 | 🤖 | 监控子代理运行状态 |
| 技能管理 | 🧩 | 管理 Claude Code 技能 |
| MCP 服务器 | 🔌 | 管理 MCP 服务器连接 |
| 插件管理 | 🧩 | 管理 Claude Code 插件 |
| 钩子配置 | ⚓ | 管理钩子配置 |

### 1.3 当前会话视图布局

#### 1.3.1 顶部标题栏
- 菜单切换按钮 (☰)
- 页面标题 "💬 当前会话"

#### 1.3.2 标签页栏
- "新任务" 标签页 (默认激活)
- 可通过历史记录打开历史会话标签

#### 1.3.3 信息栏 (配置区域)

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 工作目录 | 下拉输入框 | 选择或输入工作目录，带自动补全 |
| 会话ID | 文本输入框(只读) | 显示当前会话ID，可用于恢复会话 |
| 工具权限 | 多选下拉框 | 选择允许使用的工具 |
| 继续会话 | 复选框 | 延续最近会话的对话历史 |
| 新会话按钮 | 按钮 | 创建全新的会话 |

#### 1.3.4 输出显示区 (中间区域)

- **占位提示**: "执行任务后，输出将显示在这里..."
- **内容类型**: 根据 [当前会话-消息类型-需求.md](当前会话-消息类型-需求.md) 定义的消息类型进行渲染
  - 文本输出 (text)
  - 思考过程 (thinking)
  - 工具调用 (tool_use)
  - 工具结果 (tool_result)
  - 错误信息 (error)
  - 完成信息 (complete)
  - 用户问答 (ask_user_question) - 交互式问答，需要用户响应后继续执行

**消息渲染规则：**

| 消息类型 | 显示样式 | 对应需求 |
|----------|----------|----------|
| text | 普通文本，代码块使用等宽字体和语法高亮 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| thinking | 浅灰色背景，带思考图标 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| tool_use | 蓝色边框卡片，显示工具名称和参数 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| tool_result | 绿色边框卡片，显示执行结果 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| error | 红色边框和文字，带错误图标 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| complete | 绿色成功提示，显示统计摘要 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| ask_user_question | 紫色边框卡片，交互式选项 | [当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question](当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question) |

#### 1.3.5 任务统计栏

任务执行完成后显示统计摘要：

| 统计项 | 说明 |
|--------|------|
| 状态 | running / completed / failed |
| 耗时 | 毫秒 (如: 12,345 ms) |
| 费用 | 美元 (如: $0.023) |
| 会话ID | 点击可复制 |

#### 1.3.6 底部输入区

```
┌─────────────────────────────────────────────────────────────────┐
│ 输入框 (多行文本区域)                                            │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────┐    ┌────────────────────────┐  │
│ │ 权限模式                    │    │                        │  │
│ │ [default ▼]                │    │ [➤ 发送] 或 [⏹ 停止] │  │
│ └──────────────────────────────┘    └────────────────────────┘  │
│  左：权限模式下拉单选                    右：发送/停止按钮        │
└─────────────────────────────────────────────────────────────────┘
```

- **输入框**: 多行文本区域，支持 Enter 发送、Ctrl+Enter 换行
- **工具栏** (分两列):
  - **左侧**: 权限模式下拉单选框 (default / acceptEdits / plan / bypassPermissions)
  - **右侧**: 发送按钮 / 停止按钮 (根据执行状态切换)

**权限模式说明：**

| 模式 | 说明 |
|------|------|
| default | 默认模式，允许使用 Claude Code 的标准工具集 |
| acceptEdits | 接受编辑模式，允许 Claude Code 修改文件 |
| plan | 计划模式，仅规划操作而不执行 |
| bypassPermissions | 绕过权限模式，允许所有操作（需谨慎使用） |

## 2. 交互设计

### 2.1 任务执行流程

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  用户输入任务描述  │────▶│  点击发送按钮     │────▶│  后端处理请求    │
└──────────────────┘     └──────────────────┘     └──────────────────┘
                                                            │
                                                            ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  显示执行结果     │◀────│  实时流式推送    │◀────│  SSE 连接建立    │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

#### 执行模式

| 模式 | API 端点 | 说明 |
|------|----------|------|
| 同步模式 | POST /api/task | 等待完整结果返回 |
| 流式模式 | POST /api/task/stream | SSE 实时推送执行过程 |

> **业务说明**: 流式模式下，任务执行过程中可能发送 `ask_user_question` 类型消息（见 [当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question](当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question)），此时任务暂停执行，前端需要展示交互式问答组件，用户回答后调用 `POST /api/task/answer` API 继续执行。

### 2.2 用户操作

#### 2.2.1 发送任务

| 操作 | 触发方式 | 响应 |
|------|----------|------|
| 发送任务 | 按 Enter 或点击"发送"按钮 | 输入框禁用，按钮切换为"停止"，显示"处理中..." |
| 发送任务 | 按 Ctrl+Enter | 在输入框内换行，不发送 |
| 输入框为空 | 按 Enter 或点击发送 | 输入框边框变红，提示"请输入任务描述" |
| 任务执行中 | 输出区有内容输出 | 右侧按钮显示为"⏹ 停止" |
| 任务空闲 | 无任务执行 | 右侧按钮显示为"➤ 发送" |
| 停止任务 | 点击"停止"按钮 | 发送 AbortController 请求，任务中断 |

#### 2.2.2 任务控制

| 操作 | 触发方式 | 响应 |
|------|----------|------|
| 清空输出 | 点击工具栏右侧的"清空"按钮 | 清空输出显示区，重置统计信息，会话ID重置为"新会话" |

#### 2.2.3 用户问答交互

当任务执行过程中遇到需要用户确认或选择的问题时，显示交互式问答组件：

| 操作 | 触发方式 | 响应 |
|------|----------|------|
| 显示问答 | 收到 ask_user_question 类型 SSE 消息 | 输出区显示紫色边框的问答卡片，输入框和发送按钮禁用 |
| 选择选项 | 点击选项 | 高亮选中，可多选（checkbox 类型） |
| 提交回答 | 点击"确认"按钮 | 发送回答给后端 API，任务继续执行 |
| 取消问答 | 点击"取消"按钮 | 发送空回答或取消信号，任务可能终止 |
| 任务继续 | 后端收到回答 | 恢复任务执行，继续显示后续输出 |

**问答交互流程：**

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  收到问答消息     │────▶│  显示问答组件     │────▶│  用户选择选项    │
└──────────────────┘     └──────────────────┘     └──────────────────┘
                                                            │
                                                            ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  显示后续输出     │◀────│  任务继续执行     │◀────│  点击确认按钮    │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

**问答组件状态：**

| 状态 | 输入区状态 | 按钮显示 |
|------|------------|----------|
| 等待回答 | 禁用 | 显示"确认"/"取消"按钮 |
| 已回答 | 禁用 | 显示"处理中..." |
| 任务继续 | 恢复 | 恢复发送/停止按钮 |

### 2.2.4 会话管理

| 操作 | 触发方式 | 响应 |
|------|----------|------|
| 新建会话 | 点击"新会话"按钮 | 清空输入框，会话ID设为"新会话"，取消"继续会话"勾选 |
| 继续会话 | 勾选"继续会话" | 自动使用最近会话ID填充 resume 字段 |
| 恢复历史会话 | 从历史记录点击会话 | 在标签页打开历史会话，可查看但无法继续执行 |

### 2.3 状态反馈

#### 2.3.1 执行状态

| 状态 | 按钮显示 | 输出区显示 |
|------|----------|------------|
| 空闲 | "➤ 发送" | 占位提示 |
| 执行中 | "⏹ 停止" (显示) | 实时流式输出 + 思考动画 |
| 已完成 | "➤ 发送" | 最终结果 + 统计信息 |
| 失败 | "➤ 发送" | 错误信息 + 统计信息 |

#### 2.3.2 输入框状态

| 状态 | 样式 |
|------|------|
| 正常 | 默认边框 |
| 禁用 (执行中) | 灰色背景，不可编辑 |
| 错误 | 红色边框 + 错误提示 |

#### 2.3.3 加载状态

| 区域 | 加载显示 |
|------|----------|
| 输出区 | 显示加载动画或 "处理中..." |
| 历史记录 | 显示 "加载中..." |
| 下拉选项 | 显示加载动画 |

### 2.5 快捷键

| 快捷键 | 功能 |
|--------|------|
| Enter | 发送任务 |
| Ctrl+Enter | 换行 |
| Ctrl+L | 清空输出 |

### 2.6 错误提示

| 场景 | 提示方式 |
|------|----------|
| 输入为空 | 输入框下方红色文字提示 |
| 网络错误 | 输出区显示错误消息，带重试按钮 |
| 限流触发 | 弹窗提示 "请求过于频繁，请稍后再试" |
| API 认证失败 | 跳转登录页面或显示认证错误 |

## 3. 功能需求

### 3.1 基本任务执行

- 用户输入任务描述（prompt）
- 设置工作目录（working_dir）
- 配置允许的工具列表（tools）
- 执行任务并显示结果
- **交互式问答响应**: 任务执行过程中可接收用户问答消息（ask_user_question），需用户选择后继续执行，详见 [当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question](当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question)

### 3.2 会话与任务管理

#### 3.2.1 会话延续支持

> **业务关联**: 会话的延续和恢复功能依赖于 [会话格式-需求.md](会话格式-需求.md) 中定义的会话文件格式和消息链结构。

- **continue_conversation**: 延续 CLI 中最近的对话历史
- **resume**: 通过会话 ID 恢复特定会话
- 会话 ID 自动提取和显示

**会话恢复的数据来源**（详见 [会话格式-需求.md#JSONL-格式](会话格式-需求.md#JSONL-格式)）：
- 系统通过解析 `~/.claude/projects/{encoded-path}/{sessionId}.jsonl` 文件获取完整会话消息
- 每行 JSON 对应一条消息，按时间顺序存储
- 恢复时按 `parentUuid` 链式关系重新构建对话历史

**历史记录页面结构：**

> **业务关联**: 历史记录的展示基于 [会话格式-需求.md](会话格式-需求.md) 中定义的会话文件格式进行解析。项目列表按 `~/.claude/projects/` 目录结构展示，会话列表从 `{project}/{sessionId}.jsonl` 文件中提取元数据。

```
┌─────────────────────────────────────────────────────────────┐
│  📜 历史记录                                                │
│  ┌──────────────────────┐  ┌────────────────────────────┐ │
│  │   📁 项目列表        │  │   📋 会话列表              │ │
│  │   ├─ 项目A (5会话)  │  │   ├─ 会话1 - 10条消息      │ │
│  │   ├─ 项目B (3会话)  │  │   │   [继续此会话]          │ │
│  │   └─ 项目C (1会话)  │  │   ├─ 会话2 - 3条消息       │ │
│  └──────────────────────┘  │   │   [继续此会话]          │ │
│                             └────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**数据提取规则**（详见 [会话格式-需求.md#会话文件格式](会话格式-需求.md#会话文件格式)）：
- 会话ID: 从文件名 `{sessionId}.jsonl` 提取
- 会话标题: 从首条 `user` 类型消息的 `message.content[0].text` 提取（前50字符）
- 项目路径: 从 `cwd` 字段提取并解码
- 消息数量: 统计文件中 `user` 和 `assistant` 类型消息行数
- 工具列表: 从 `assistant` 消息的 `content` 数组中提取 `tool_use.name`
- 文件变更: 从 `file-history-snapshot` 消息中提取 `trackedFileBackups` 键

#### 3.2.2 会话数据回填规则

当用户从历史记录继续会话时，系统自动回填以下数据：

> **业务关联**: 数据回填规则基于 [会话格式-需求.md](会话格式-需求.md) 中定义的会话消息结构进行数据提取。

| 数据项 | 来源 | 回填行为 |
|--------|------|----------|
| 会话ID (resume) | 选择的会话文件 `{sessionId}.jsonl` | 填充到会话ID输入框，设为只读 |
| 工作目录 (working_dir) | 会话创建时的项目路径 (首条 user 消息的 `cwd` 字段) | 填充并锁定，不可修改 |
| 历史消息 | 完整会话消息历史 (解析 jsonl 文件中所有 user/assistant 消息) | 显示在输出区域 |
| 会话标题 | 首条用户消息内容 (首条 user 消息的 `message.content[0].text`) | 显示在标签页标题 |

#### 3.2.3 历史会话交互限制

恢复历史会话后，以下操作被禁用：

| 操作 | 限制说明 |
|------|----------|
| 继续会话复选框 | 禁用（因为已通过 resume 指定会话） |
| 工作目录 | 锁定，不可修改 |
| 工具权限 | 可调整 |
| 新建会话按钮 | 正常可用 |

#### 3.2.4 继续会话 vs 恢复会话

> **业务关联**: 两种会话延续方式的差异体现在数据获取方式上，详见 [会话格式-需求.md#多轮对话结构分析](会话格式-需求.md#多轮对话结构分析)。

| 特性 | continue_conversation | resume |
|------|----------------------|--------|
| 数据来源 | 最近一次会话 | 用户选择的指定会话 |
| 输入方式 | 勾选复选框 | 从历史记录选择 |
| 会话ID显示 | 可选显示 | 必须显示 |
| 工作目录 | 可修改 | 锁定为原会话目录 (来自 cwd 字段) |
| 消息历史 | 自动续接最近会话 | 显示所选会话历史 |

#### 3.2.5 会话历史数据格式

> **业务关联**: 本节定义的数据格式基于 [会话格式-需求.md](会话格式-需求.md) 中描述的 Claude Code 会话文件格式。系统通过解析 `~/.claude/projects/{project}/{sessionId}.jsonl` 文件获取会话数据。

```
Session {
  id: string (UUID)           // 会话唯一标识 (对应会话文件名的 sessionId)
  title: string               // 会话标题（首条用户消息摘要）
  project_path: string        // 关联的项目路径 (对应会话消息的 cwd 字段)
  timestamp: string           // 创建时间 ISO 格式 (对应首条 user 消息的 timestamp)
  message_count: number       // 消息总数
  tools_used: string[]       // 使用的工具列表 (从 assistant 消息的 tool_use 提取)
  files_changed: string[]    // 变更的文件列表 (从 file-history-snapshot 跟踪)
}

Message {
  role: "user" | "assistant"
  content: string | ContentBlock[]  // 消息内容
  timestamp: string           // 发送时间
  uuid: string               // 消息唯一标识 (用于构建消息链)
  parentUuid: string | null  // 父消息 UUID (用于会话消息链关系)
}
```

**消息链关系说明**（详见 [会话格式-需求.md#消息链关系](会话格式-需求.md#消息链关系)）：
- 每条消息通过 `uuid` 和 `parentUuid` 构成链式结构
- `user` 消息的 `parentUuid` 为 `null` 表示新会话开始
- `permissionMode` 字段存在时表示新任务发起（最可靠的会话边界判断依据）

**多轮对话判断**（详见 [会话格式-需求.md#多轮对话结构分析](会话格式-需求.md#多轮对话结构分析)）：
- `permissionMode` 字段存在 → 新会话开始
- `parentUuid` 为 `null` → 首条用户消息
- 内容包含 `tool_result` → 继续当前对话（工具结果返回）

**用户输入类型区分**（详见 [会话格式-需求.md#用户输入类型区分](会话格式-需求.md#用户输入类型区分)）：

| 类型 | 识别特征 | 业务含义 |
|------|---------|----------|
| ide_selection | 包含 `<ide_selection>` 标签 | 用户选中代码后提问 |
| ide_opened_file | 包含 `<ide_opened_file>` 标签 | 用户打开文件后操作 |
| tool_result | content 包含 `tool_result` 类型 | 工具执行结果返回 |
| 普通文本 | content 只包含 `text` 类型 | 直接输入的任务描述 |

#### 3.2.6 历史会话消息解析规则

> **业务关联**: 当用户从历史记录继续会话时，需要从 Claude Code 的 jsonl 文件中解析消息历史。此规则定义了消息内容的解析逻辑。

**消息 content 字段类型**：

| 消息类型 | content 字段类型 | 说明 |
|----------|-----------------|------|
| 第一条用户消息 | `string` | 简单文本消息，直接作为 text 类型 |
| 后续用户消息 | `array` | 复杂消息格式，包含多种内容块 |
| Assistant 消息 | `array` | 包含 thinking、text、tool_use 等内容块 |

**解析逻辑**：

1. 如果 content 是字符串类型，直接转换为 `{"type": "text", "text": "..."}`
2. 如果 content 是数组类型，遍历内容块数组解析各类型：
   - `text` → 文本内容
   - `thinking` → 思考过程
   - `tool_use` → 工具调用（提取 name、input、id）
   - `tool_result` → 工具结果（通过 tool_use_id 关联 tool_use 的名称）

**过滤规则**：

- 解析会话标题时，过滤包含 `<ide_selection>` 或 `<ide_opened_file>` 标签的内容块
- 仅返回有实际内容的消息（空 content 或空字符串不返回）

#### 3.2.7 任务控制

- 停止正在执行的任务（使用 AbortController）
- 清空输出区域

## 4. 业务规则

### 4.1 输入验证规则

| 字段 | 必填 | 长度/格式限制 | 验证规则 |
|------|------|---------------|----------|
| prompt | 是 | 1-10000 字符 | 不能为空或仅包含空白字符 |
| working_dir | 否 | 有效路径 | 必须是存在的目录路径 |
| tools | 否 | 数组 | 必须是有效的工具名称列表 |
| continue_conversation | 否 | 布尔值 | 默认 false |
| resume | 否 | 会话 ID 格式 | 必须是有效的会话 UUID |

**补充验证规则：**
- prompt 首尾空白字符自动去除
- working_dir 如果未指定，默认使用系统配置的工作目录
- tools 如果未指定，默认使用 Claude Code 的默认工具集
- continue_conversation 和 resume 互斥，不能同时为 true

### 4.2 权限与安全规则

| 规则项 | 说明 |
|--------|------|
| API 密钥认证 | 所有任务执行 API 需要有效的 API Key |
| 工作目录限制 | 只能在配置允许的目录范围内执行任务 |
| 目录遍历防护 | 禁止通过 working_dir 访问配置目录外的路径 |
| 敏感路径过滤 | 禁止访问系统敏感路径（如 /etc、/root 等） |
| 工具权限控制 | 可配置允许使用的工具列表 |
| 请求大小限制 | prompt 最大 10000 字符 |

### 4.3 限流规则

| 端点 | 限流策略 | 说明 |
|------|----------|------|
| POST /api/task | 10 次/分钟/IP | 同步任务限流 |
| POST /api/task/stream | 10 次/分钟/IP | 流式任务限流 |

**说明：**
- 超过限流阈值返回 429 状态码
- 限流按客户端 IP 地址统计

### 4.4 会话管理规则

> **业务关联**: 会话存储规则基于 [会话格式-需求.md](会话格式-需求.md#存储位置) 中定义的目录结构。

| 规则 | 说明 |
|------|------|
| 会话 ID 生成 | 每个任务自动生成唯一会话 ID（UUID 格式） |
| 会话存储 | 任务会话数据存储在 `~/.claude/projects/{encoded-project-path}/{sessionId}.jsonl` |
| 会话延续 | continue_conversation 使用最近会话的上下文 (从 jsonl 文件末尾追加) |
| 会话恢复 | resume 通过指定会话 ID 读取对应 jsonl 文件恢复历史会话 |
| 会话保留 | 保留最近 30 天的会话数据 |

### 4.5 响应规则

**TaskResponse 字段说明：**

| 字段 | 类型 | 说明 |
|------|------|------|
| success | bool | 任务是否成功执行 |
| message | string | 执行结果或错误信息 |
| session_id | string? | 任务会话 ID |
| cost_usd | float? | 任务消耗费用（美元） |
| duration_ms | int? | 任务执行时长（毫秒） |
| files_changed | string[] | 变更的文件列表 |
| tools_used | string[] | 使用的工具列表 |

**SSE 消息类型：**

| 类型 | 说明 | 对应需求 |
|------|------|----------|
| text | 文本输出 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| thinking | 思考过程 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| tool_use | 工具调用开始 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| tool_result | 工具执行结果 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| error | 错误信息 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| complete | 任务完成 | [当前会话-消息类型-需求.md#1-消息类型定义](当前会话-消息类型-需求.md#1-消息类型定义) |
| ask_user_question | 用户问答，交互式问答 | [当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question](当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question) |

#### 4.5.1 用户问答 API

当收到 `ask_user_question` 类型消息时，前端需要调用以下 API 提交用户答案：

**API 端点：** `POST /api/task/answer`

**请求格式：**
```json
{
  "session_id": "session_xxx",
  "question_id": "auth_strategy_01",
  "answer": "oauth2"
}
```

**多选答案格式：**
```json
{
  "session_id": "session_xxx",
  "question_id": "oauth_providers",
  "answer": ["google", "github"]
}
```

**文本输入答案格式：**
```json
{
  "session_id": "session_xxx",
  "question_id": "custom_port",
  "answer": "8080"
}
```

**响应格式：**
```json
{
  "success": true,
  "message": "答案已提交，任务继续执行"
}
```

**错误响应：**

| 错误类型 | HTTP 状态码 | 说明 |
|----------|-------------|------|
| session_not_found | 404 | 会话不存在 |
| question_not_found | 404 | 问题不存在（已超时或已回答） |
| invalid_answer | 400 | 答案格式无效 |
| task_interrupted | 400 | 任务已被中断 |

> **业务说明**: SSE 流式输出过程中，任务执行可能在任意时刻暂停并发送 `ask_user_question` 类型消息，此时需要前端展示交互式问答组件，等待用户选择后继续执行。具体数据结构和交互流程见 [当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question](当前会话-消息类型-需求.md#2-用户问答消息-ask_user_question)。

### 4.6 错误处理规则

| 错误类型 | HTTP 状态码 | 用户提示 |
|----------|-------------|----------|
| prompt 为空 | 422 | "任务描述不能为空" |
| prompt 过长 | 422 | "任务描述超过最大长度限制" |
| working_dir 无效 | 400 | "工作目录不存在或无权限访问" |
| 会话不存在 | 404 | "指定的会话不存在" |
| API 认证失败 | 401 | "API 密钥无效" |
| 超过限流 | 429 | "请求过于频繁，请稍后再试" |
| 服务内部错误 | 500 | "服务内部错误，请稍后重试" |

### 4.7 任务控制规则

| 操作 | 实现方式 | 说明 |
|------|----------|------|
| 停止任务 | AbortController | 用户可中断正在执行的任务 |
| 任务超时 | 可配置超时时间 | 防止任务无限期运行 |
| 自动清理 | 定时任务 | 清理过期会话和临时文件 |

### 4.8 历史会话消息解析规则

> **业务关联**: 本规则定义了从 Claude Code jsonl 文件中解析会话消息的逻辑，用于"继续历史会话"功能。

| 规则 | 说明 |
|------|------|
| content 类型判断 | 判断 content 是字符串还是数组类型 |
| 字符串转换 | content 为字符串时，转换为 `{"type": "text", "text": "..."}` |
| 空内容过滤 | 空字符串或空数组不返回消息 |
| 工具名称关联 | tool_result 通过 tool_use_id 关联 tool_use 的名称 |

## 5. 验收标准

### 5.1 功能验收

- [ ] 同步模式正确返回任务执行结果
- [ ] 流式模式实时推送执行过程
- [ ] 会话延续功能正常工作
- [ ] 会话恢复功能正常工作
- [ ] 任务停止功能正常工作
- [ ] 历史会话消息解析正确（支持字符串和数组类型的 content）
- [ ] 第一条用户消息正常显示（content 为字符串类型）

### 5.2 验证规则验收

- [ ] 空 prompt 被正确拒绝
- [ ] 超长 prompt 被正确拒绝
- [ ] 无效 working_dir 被正确拒绝
- [ ] 限流规则正确生效

### 5.3 安全规则验收

- [ ] 未授权请求被正确拒绝
- [ ] 目录遍历攻击被阻止
- [ ] 敏感路径访问被阻止

### 5.4 错误处理验收

- [ ] 各类型错误返回正确的 HTTP 状态码
- [ ] 错误信息对用户友好
- [ ] 敏感信息不在错误响应中泄露
