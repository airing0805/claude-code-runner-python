# 技能系统管理 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证技能管理 API 的功能完整性和用户配置。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 技能列表 | 获取、筛选 |
| 技能详情 | 查看详细信息 |
| 启用/禁用 | 状态切换 |
| 用户配置 | 参数配置保存 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_skills.py

from app.skills.schemas import Skill, SkillParameter, SkillConfig

class TestSkillParameter:
    """技能参数模型测试"""

    def test_parameter_creation(self):
        """测试参数创建"""
        param = SkillParameter(
            name="output_format",
            type="string",
            default="pdf",
            description="输出格式"
        )
        assert param.name == "output_format"
        assert param.default == "pdf"


class TestSkill:
    """技能模型测试"""

    def test_skill_creation(self):
        """测试技能创建"""
        skill = Skill(
            skill_id="skill-pdf",
            name="PDF 处理",
            description="读取、创建和编辑 PDF 文件",
            category="文件处理",
            version="1.2.0",
            author="Claude Team",
            tags=["pdf", "document"],
            is_enabled=True,
            is_builtin=True,
            parameters=[],
            examples=[],
            permissions=[]
        )
        assert skill.skill_id == "skill-pdf"
        assert skill.is_enabled is True

    def test_skill_defaults(self):
        """测试默认值"""
        skill = Skill(
            skill_id="test",
            name="Test",
            description="Test",
            category="测试",
            version="1.0.0",
            author="Test",
            tags=[],
            is_enabled=False,
            is_builtin=False,
            parameters=[],
            examples=[],
            permissions=[]
        )
        assert skill.is_builtin is False


class TestSkillConfig:
    """技能配置模型测试"""

    def test_config_creation(self):
        """测试配置创建"""
        config = SkillConfig(
            skill_id="skill-pdf",
            parameters={"output_format": "pdf"},
            enabled=True
        )
        assert config.skill_id == "skill-pdf"
        assert config.parameters["output_format"] == "pdf"
```

---

## 3. 集成测试

### 3.1 技能列表 API 测试

```python
class TestSkillsEndpoint:
    """技能 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    @pytest.fixture
    def mock_skill_manager(self):
        """Mock 技能管理器"""
        with patch("app.routers.skills.SkillManager") as mock:
            mock_instance = MagicMock()
            mock_instance.get_skills.return_value = [
                Skill(
                    skill_id="skill-pdf",
                    name="PDF 处理",
                    description="PDF 操作",
                    category="文件处理",
                    version="1.0.0",
                    author="Test",
                    tags=[],
                    is_enabled=True,
                    is_builtin=True,
                    parameters=[],
                    examples=[],
                    permissions=[]
                )
            ]
            mock.return_value = mock_instance
            yield mock_instance

    def test_get_skills_success(self, client, mock_skill_manager):
        """测试获取技能列表成功"""
        response = client.get("/api/skills")

        assert response.status_code == 200
        data = response.json()

        assert "skills" in data

    def test_get_skills_by_category(self, client, mock_skill_manager):
        """测试按类别筛选"""
        response = client.get("/api/skills?category=文件处理")

        assert response.status_code == 200

    def test_get_skills_enabled_only(self, client, mock_skill_manager):
        """测试只获取启用的技能"""
        response = client.get("/api/skills?enabled_only=true")

        assert response.status_code == 200
```

### 3.2 技能详情 API 测试

```python
class TestSkillDetail:
    """技能详情测试"""

    def test_get_skill_detail(self, client, mock_skill_manager):
        """测试获取技能详情"""
        response = client.get("/api/skills/skill-pdf")

        assert response.status_code in [200, 404]

    def test_get_nonexistent_skill(self, client, mock_skill_manager):
        """测试获取不存在的技能"""
        mock_skill_manager.get_skill.return_value = None

        response = client.get("/api/skills/nonexistent")

        assert response.status_code == 404
```

### 3.3 启用/禁用技能测试

```python
class TestSkillEnableDisable:
    """启用/禁用技能测试"""

    def test_enable_skill(self, client, mock_skill_manager):
        """测试启用技能"""
        response = client.post("/api/skills/skill-pdf/enable")

        assert response.status_code in [200, 404]
        mock_skill_manager.enable_skill.assert_called_once()

    def test_disable_skill(self, client, mock_skill_manager):
        """测试禁用技能"""
        response = client.post("/api/skills/skill-pdf/disable")

        assert response.status_code in [200, 404]
        mock_skill_manager.disable_skill.assert_called_once()

    def test_enable_nonexistent_skill(self, client, mock_skill_manager):
        """测试启用不存在的技能"""
        mock_skill_manager.enable_skill.side_effect = ValueError("Skill not found")

        response = client.post("/api/skills/nonexistent/enable")

        assert response.status_code == 404
```

### 3.4 用户配置测试

```python
class TestSkillConfig:
    """技能配置测试"""

    def test_get_skill_config(self, client, mock_skill_manager):
        """测试获取技能配置"""
        response = client.get("/api/skills/config")

        assert response.status_code in [200, 404]

    def test_update_skill_config(self, client, mock_skill_manager):
        """测试更新技能配置"""
        response = client.put("/api/skills/config", json={
            "skill_id": "skill-pdf",
            "parameters": {"output_format": "pdf"}
        })

        assert response.status_code in [200, 404]
```

---

## 4. 技能管理器测试

```python
class TestSkillManager:
    """技能管理器测试"""

    def test_load_skills(self, tmp_path):
        """测试加载技能"""
        from app.skills.manager import SkillManager

        skills_dir = tmp_path / "skills"
        skills_dir.mkdir()

        # 创建技能文件
        skill_file = skills_dir / "skill-pdf.json"
        skill_file.write_text(json.dumps({
            "skill_id": "skill-pdf",
            "name": "PDF 处理",
            "category": "文件处理"
        }))

        manager = SkillManager(skills_dir=skills_dir)
        skills = manager.get_skills()

        assert len(skills) >= 0

    def test_enable_skill(self, tmp_path):
        """测试启用技能"""
        from app.skills.manager import SkillManager

        skills_dir = tmp_path / "skills"
        skills_dir.mkdir()

        manager = SkillManager(skills_dir=skills_dir)
        # 测试启用逻辑
        # ...
```

---

## 5. E2E 测试

```python
# tests/e2e/test_skills.py

class TestSkillsPageE2E:
    """技能管理页面 E2E 测试"""

    def test_skills_page_loads(self, page: Page):
        """测试技能页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=技能管理")

        expect(page.locator("h1")).to_contain_text("技能")

    def test_category_filter(self, page: Page):
        """测试类别筛选"""
        page.goto("http://127.0.0.1:8000/skills")

        page.click("text=文件处理")
        # 验证筛选结果
        expect(page.locator(".skill-item")).to_be_visible()

    def test_enable_skill(self, page: Page):
        """测试启用技能"""
        page.goto("http://127.0.0.1:8000/skills")

        page.click("text=启用")
        # 验证状态变化
```

---

## 6. 运行测试

```bash
# 运行技能相关测试
uv run pytest tests/ -k "skill" -v
```

---

## 7. 验收标准

- [ ] 技能列表 API 正常工作
- [ ] 支持按类别筛选
- [ ] 支持只获取启用的技能
- [ ] 技能详情 API 正常工作
- [ ] 启用技能 API 正常工作
- [ ] 禁用技能 API 正常工作
- [ ] 用户配置 API 正常工作
- [ ] UI 正确显示所有功能
