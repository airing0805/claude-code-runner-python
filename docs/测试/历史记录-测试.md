# 会话管理 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证会话管理 API 的功能完整性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 项目列表 | 获取所有项目 |
| 会话列表 | 获取项目会话 |
| 消息历史 | 获取会话消息 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_session.py

from app.session.schemas import Project, Session, Message, ContentBlock
from datetime import datetime

class TestProject:
    """项目模型测试"""

    def test_project_creation(self):
        """测试项目创建"""
        project = Project(
            encoded_name="E--test-project",
            path="E:\\test\\project",
            session_count=5,
            tools=["Read", "Write"]
        )
        assert project.encoded_name == "E--test-project"
        assert project.session_count == 5


class TestSession:
    """会话模型测试"""

    def test_session_creation(self):
        """测试会话创建"""
        session = Session(
            id="abc123def456",
            title="测试任务",
            timestamp=datetime.now(),
            message_count=10,
            size=5000
        )
        assert session.id == "abc123def456"
        assert session.title == "测试任务"


class TestContentBlock:
    """内容块模型测试"""

    def test_text_block(self):
        """测试文本内容块"""
        block = ContentBlock(
            type="text",
            text="Hello World"
        )
        assert block.type == "text"
        assert block.text == "Hello World"

    def test_tool_use_block(self):
        """测试工具调用块"""
        block = ContentBlock(
            type="tool_use",
            tool_name="Read",
            tool_input={"file_path": "/test.py"}
        )
        assert block.type == "tool_use"
        assert block.tool_name == "Read"

    def test_tool_result_block(self):
        """测试工具结果块"""
        block = ContentBlock(
            type="tool_result",
            tool_use_id="call_xxx",
            content="文件内容",
            is_error=False
        )
        assert block.type == "tool_result"
        assert block.is_error is False


class TestMessage:
    """消息模型测试"""

    def test_message_creation(self):
        """测试消息创建"""
        message = Message(
            role="user",
            content=[ContentBlock(type="text", text="Test")],
            timestamp=datetime.now(),
            uuid="msg-uuid-123"
        )
        assert message.role == "user"
        assert len(message.content) == 1
```

---

## 3. 集成测试

### 3.1 项目列表 API 测试

```python
class TestProjectsEndpoint:
    """项目 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    @pytest.fixture
    def mock_session_manager(self):
        """Mock 会话管理器"""
        with patch("app.routers.session.SessionManager") as mock:
            mock_instance = MagicMock()
            mock_instance.get_projects.return_value = [
                Project(
                    encoded_name="E--test",
                    path="E:\\test",
                    session_count=3,
                    tools=["Read"]
                )
            ]
            mock.return_value = mock_instance
            yield mock_instance

    def test_get_projects_success(self, client, mock_session_manager):
        """测试获取项目列表成功"""
        response = client.get("/api/projects")

        assert response.status_code == 200
        data = response.json()
        assert "projects" in data

    def test_projects_structure(self, client, mock_session_manager):
        """测试项目列表结构"""
        response = client.get("/api/projects")
        data = response.json()

        project = data["projects"][0]
        required_fields = ["encoded_name", "path", "session_count", "tools"]

        for field in required_fields:
            assert field in project
```

### 3.2 会话列表 API 测试

```python
class TestSessionsEndpoint:
    """会话 API 测试"""

    def test_get_sessions_success(self, client, mock_session_manager):
        """测试获取会话列表成功"""
        response = client.get("/api/projects/E--test/sessions")

        assert response.status_code == 200
        data = response.json()
        assert "sessions" in data

    def test_sessions_structure(self, client, mock_session_manager):
        """测试会话列表结构"""
        response = client.get("/api/projects/E--test/sessions")
        data = response.json()

        session = data["sessions"][0]
        required_fields = ["id", "title", "timestamp", "message_count", "size"]

        for field in required_fields:
            assert field in session

    def test_invalid_project(self, client, mock_session_manager):
        """测试无效项目"""
        response = client.get("/api/projects/nonexistent/sessions")

        # 返回空列表或 404
        assert response.status_code in [200, 404]
```

### 3.3 消息历史 API 测试

```python
class TestMessagesEndpoint:
    """消息 API 测试"""

    def test_get_messages_success(self, client, mock_session_manager):
        """测试获取消息历史成功"""
        response = client.get("/api/sessions/abc123/messages")

        assert response.status_code in [200, 404]

    def test_messages_structure(self, client, mock_session_manager):
        """测试消息历史结构"""
        response = client.get("/api/sessions/abc123/messages")

        if response.status_code == 200:
            data = response.json()
            assert "session_id" in data
            assert "messages" in data

    def test_content_blocks(self, client, mock_session_manager):
        """测试内容块结构"""
        response = client.get("/api/sessions/abc123/messages")

        if response.status_code == 200:
            data = response.json()
            if len(data["messages"]) > 0:
                message = data["messages"][0]
                assert "role" in message
                assert "content" in message
                assert isinstance(message["content"], list)
```

---

## 4. parse_content_blocks 函数测试

```python
class TestParseContentBlocks:
    """内容块解析函数测试"""

    def test_parse_string_content(self):
        """测试字符串类型的 content（第一条用户消息）"""
        from app.routers.session import parse_content_blocks

        # 模拟第一条用户消息的 content 是字符串
        result = parse_content_blocks("在一个空的目录下面执行claude命令会自动生成文件吗")

        assert len(result) == 1
        assert result[0]["type"] == "text"
        assert result[0]["text"] == "在一个空的目录下面执行claude命令会自动生成文件吗"

    def test_parse_empty_string_content(self):
        """测试空字符串 content"""
        from app.routers.session import parse_content_blocks

        result = parse_content_blocks("")
        assert result == []

    def test_parse_whitespace_string_content(self):
        """测试空白字符串 content"""
        from app.routers.session import parse_content_blocks

        result = parse_content_blocks("   ")
        assert result == []

    def test_parse_array_content_with_text(self):
        """测试数组类型的 content（复杂消息）"""
        from app.routers.session import parse_content_blocks

        content = [
            {"type": "text", "text": "Hello World"},
            {"type": "thinking", "thinking": "思考过程"},
        ]
        result = parse_content_blocks(content)

        assert len(result) == 2
        assert result[0]["type"] == "text"
        assert result[1]["type"] == "thinking"

    def test_parse_array_content_with_tool_use(self):
        """测试包含工具调用的 content"""
        from app.routers.session import parse_content_blocks

        content = [
            {"type": "tool_use", "id": "call_123", "name": "Read", "input": {"file_path": "/test.py"}},
            {"type": "tool_result", "tool_use_id": "call_123", "content": "file content"},
        ]
        result = parse_content_blocks(content)

        assert len(result) == 2
        assert result[0]["type"] == "tool_use"
        assert result[0]["tool_name"] == "Read"
        assert result[1]["type"] == "tool_result"
        assert result[1]["tool_name"] == "Read"  # 自动关联工具名称

    def test_parse_invalid_content_type(self):
        """测试无效的 content 类型"""
        from app.routers.session import parse_content_blocks

        result = parse_content_blocks(123)
        assert result == []

        result = parse_content_blocks(None)
        assert result == []
```

---

## 5. 会话管理器测试

```python
class TestSessionManager:
    """会话管理器测试"""

    def test_get_projects(self):
        """测试获取项目列表"""
        from app.session.manager import SessionManager

        manager = SessionManager()
        projects = manager.get_projects()

        assert isinstance(projects, list)

    def test_get_sessions(self):
        """测试获取会话列表"""
        manager = SessionManager()
        sessions = manager.get_sessions("E--test")

        assert isinstance(sessions, list)

    def test_get_messages(self):
        """测试获取消息历史"""
        manager = SessionManager()
        messages = manager.get_messages("session-123")

        assert isinstance(messages, list)

    def test_encode_project_name(self):
        """测试项目名称编码"""
        from app.session.manager import encode_project_name

        assert encode_project_name("E:\\test\\project") == "E--test--project"
        assert encode_project_name("normal-name") == "normal-name"
```

---

## 5. E2E 测试

```python
# tests/e2e/test_session.py

class TestSessionPageE2E:
    """会话管理页面 E2E 测试"""

    def test_projects_page_loads(self, page: Page):
        """测试项目页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=项目")

        expect(page.locator("h1")).to_contain_text("项目")

    def test_session_list(self, page: Page):
        """测试会话列表"""
        page.goto("http://127.0.0.1:8000/projects")

        expect(page.locator(".project-list")).to_be_visible()

    def test_message_history(self, page: Page):
        """测试消息历史"""
        page.goto("http://127.0.0.1:8000/sessions/abc123")

        expect(page.locator(".message-list")).to_be_visible()
```

---

## 6. 运行测试

```bash
# 运行会话相关测试
uv run pytest tests/ -k "session or project" -v
```

---

## 7. 验收标准

- [ ] 项目列表 API 正常工作
- [ ] 会话列表 API 正常工作
- [ ] 消息历史 API 正常工作
- [ ] 内容块类型完整
- [ ] 项目名称编码正确
- [ ] UI 正确显示所有功能
