# 状态查询 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证状态查询 API 的功能完整性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 服务状态 | 运行状态、工作目录、活跃任务 |
| 工具列表 | 可用工具列表 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_status.py

from app.status.schemas import StatusResponse, ToolInfo

class TestStatusResponse:
    """状态响应模型测试"""

    def test_status_response_creation(self):
        """测试状态响应创建"""
        response = StatusResponse(
            status="running",
            working_dir="/test/path",
            active_tasks=2
        )
        assert response.status == "running"
        assert response.working_dir == "/test/path"
        assert response.active_tasks == 2

    def test_status_stopped(self):
        """测试停止状态"""
        response = StatusResponse(
            status="stopped",
            working_dir="/test/path",
            active_tasks=0
        )
        assert response.status == "stopped"
        assert response.active_tasks == 0


class TestToolInfo:
    """工具信息模型测试"""

    def test_tool_info_creation(self):
        """测试工具信息创建"""
        tool = ToolInfo(
            name="Read",
            description="读取文件内容"
        )
        assert tool.name == "Read"
        assert tool.description == "读取文件内容"


class TestToolsResponse:
    """工具列表响应测试"""

    def test_tools_response(self):
        """测试工具列表响应"""
        data = {
            "tools": [
                {"name": "Read", "description": "读取文件"},
                {"name": "Write", "description": "写入文件"}
            ]
        }
        assert len(data["tools"]) == 2
```

---

## 3. 集成测试

### 3.1 服务状态 API 测试

```python
class TestStatusEndpoint:
    """状态 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    def test_get_status_success(self, client):
        """测试获取服务状态成功"""
        response = client.get("/api/status")

        assert response.status_code == 200
        data = response.json()

        # 验证必要字段
        assert "status" in data
        assert "working_dir" in data
        assert "active_tasks" in data

    def test_status_running(self, client):
        """测试运行状态"""
        response = client.get("/api/status")
        data = response.json()

        # status 应该是 running 或 stopped
        assert data["status"] in ["running", "stopped"]

    def test_active_tasks_type(self, client):
        """测试活跃任务数为整数"""
        response = client.get("/api/status")
        data = response.json()

        assert isinstance(data["active_tasks"], int)
        assert data["active_tasks"] >= 0
```

### 3.2 工具列表 API 测试

```python
class TestToolsEndpoint:
    """工具列表 API 测试"""

    def test_get_tools_success(self, client):
        """测试获取工具列表成功"""
        response = client.get("/api/tools")

        assert response.status_code == 200
        data = response.json()

        assert "tools" in data

    def test_all_9_tools_present(self, client):
        """测试所有9个工具都存在"""
        response = client.get("/api/tools")
        data = response.json()

        expected_tools = ["Read", "Write", "Edit", "Bash", "Glob", "Grep", "WebSearch", "WebFetch", "Task"]
        actual_tools = [t["name"] for t in data["tools"]]

        for tool in expected_tools:
            assert tool in actual_tools, f"缺少工具: {tool}"

    def test_tool_structure(self, client):
        """测试工具信息结构"""
        response = client.get("/api/tools")
        data = response.json()

        tool = data["tools"][0]
        required_fields = ["name", "description"]

        for field in required_fields:
            assert field in tool

    def test_tool_descriptions_not_empty(self, client):
        """测试工具描述不为空"""
        response = client.get("/api/tools")
        data = response.json()

        for tool in data["tools"]:
            assert len(tool["description"]) > 0
```

---

## 4. 错误处理测试

### 4.1 错误响应格式测试

```python
class TestErrorResponses:
    """错误响应测试"""

    def test_404_error(self, client):
        """测试 404 错误"""
        response = client.get("/api/nonexistent")

        assert response.status_code == 404

    def test_error_format(self, client):
        """测试错误响应格式"""
        response = client.get("/api/nonexistent")

        assert response.status_code >= 400
        # 应该包含错误信息
        assert "detail" in response.json() or "error" in response.json()
```

---

## 5. 性能测试

```python
class TestStatusPerformance:
    """状态查询性能测试"""

    def test_status_response_time(self, client):
        """测试状态查询响应时间"""
        import time

        start = time.time()
        response = client.get("/api/status")
        duration = time.time() - start

        assert response.status_code == 200
        assert duration < 0.1  # 100ms

    def test_tools_response_time(self, client):
        """测试工具列表响应时间"""
        import time

        start = time.time()
        response = client.get("/api/tools")
        duration = time.time() - start

        assert response.status_code == 200
        assert duration < 0.1  # 100ms
```

---

## 6. E2E 测试

```python
# tests/e2e/test_status.py

class TestStatusPageE2E:
    """状态页面 E2E 测试"""

    def test_home_page_loads(self, page: Page):
        """测试主页加载"""
        page.goto("http://127.0.0.1:8000/")

        expect(page.locator("body")).to_be_visible()

    def test_status_api_accessible(self, page: Page):
        """测试状态 API 可访问"""
        # 通过 fetch 测试
        page.goto("http://127.0.0.1:8000/")
        status = page.evaluate("fetch('/api/status').then(r => r.json())")

        assert "status" in status
```

---

## 7. 运行测试

```bash
# 运行状态相关测试
uv run pytest tests/ -k "status or tools" -v
```

---

## 8. 验收标准

- [ ] 服务状态 API 正常工作
- [ ] 工具列表 API 正常工作
- [ ] 返回所有9个工具
- [ ] 错误响应格式正确
- [ ] 性能测试通过 (响应时间 < 100ms)
- [ ] UI 正确显示状态信息
