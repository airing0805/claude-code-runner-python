# 工具统计展示 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证工具统计、权限模式说明和可用工具列表 API 的功能完整性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 工具使用统计 | 数据格式、统计准确性 |
| 权限模式说明 | 四种模式描述完整 |
| 可用工具列表 | 工具信息完整性 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_stats.py

from app.claude.schemas import (
    ToolUsage, TaskStats, StatsInfo,
    PermissionMode, PermissionModesInfo
)

class TestToolUsage:
    """工具使用统计模型测试"""

    def test_tool_usage_creation(self):
        """测试工具使用统计创建"""
        usage = ToolUsage(
            Read=15,
            Write=3,
            Edit=8,
            Bash=5,
            Glob=12,
            Grep=7,
            WebSearch=2,
            WebFetch=1,
            Task=0
        )
        assert usage.Read == 15
        assert usage.Write == 3
        assert usage.Task == 0

    def test_tool_usage_default_zero(self):
        """测试默认值"""
        usage = ToolUsage()
        assert usage.Read == 0
        assert usage.Write == 0


class TestTaskStats:
    """任务统计模型测试"""

    def test_task_stats_creation(self):
        """测试任务统计创建"""
        stats = TaskStats(
            total=10,
            success=9,
            failed=1,
            avg_duration_ms=3500,
            total_cost_usd=0.52
        )
        assert stats.total == 10
        assert stats.success == 9
        assert stats.failed == 1

    def test_task_stats_validation(self):
        """测试统计一致性验证"""
        # success + failed 应该等于 total
        stats = TaskStats(
            total=10,
            success=9,
            failed=2,  # 不一致
            avg_duration_ms=3500,
            total_cost_usd=0.52
        )
        # 应该验证失败或自动修正
        # 具体取决于实现


class TestStatsInfo:
    """完整统计信息模型测试"""

    def test_stats_info_creation(self):
        """测试完整统计信息"""
        info = StatsInfo(
            tools_usage=ToolUsage(Read=10, Write=5),
            files_changed=3,
            task_stats=TaskStats(
                total=5,
                success=4,
                failed=1,
                avg_duration_ms=2000,
                total_cost_usd=0.1
            )
        )
        assert info.tools_usage.Read == 10
        assert info.files_changed == 3
        assert info.task_stats.total == 5


class TestPermissionMode:
    """权限模式模型测试"""

    def test_permission_mode_creation(self):
        """测试权限模式创建"""
        mode = PermissionMode(
            name="default",
            description="默认模式，每次工具调用需要用户确认",
            scenarios=["安全性要求高的场景"]
        )
        assert mode.name == "default"
        assert len(mode.scenarios) == 1

    def test_all_permission_modes(self):
        """测试所有权限模式"""
        modes_info = PermissionModesInfo(modes=[
            PermissionMode(
                name="default",
                description="默认模式",
                scenarios=["场景1"]
            ),
            PermissionMode(
                name="acceptEdits",
                description="自动接受编辑",
                scenarios=["场景2"]
            ),
            PermissionMode(
                name="plan",
                description="规划模式",
                scenarios=["场景3"]
            ),
            PermissionMode(
                name="bypassPermissions",
                description="跳过权限",
                scenarios=["场景4"]
            ),
        ])
        assert len(modes_info.modes) == 4
```

### 2.2 统计收集器测试

```python
class TestStatsCollector:
    """统计收集器测试"""

    def test_record_tool_use(self):
        """测试记录工具使用"""
        from app.claude.stats import StatsCollector

        collector = StatsCollector()
        collector.record_tool_use("Read")
        collector.record_tool_use("Read")
        collector.record_tool_use("Write")

        assert collector.tools_usage["Read"] == 2
        assert collector.tools_usage["Write"] == 1

    def test_record_file_change(self):
        """测试记录文件变更"""
        collector = StatsCollector()
        collector.record_file_change()
        collector.record_file_change()

        assert collector.files_changed == 2

    def test_get_stats(self):
        """测试获取统计"""
        collector = StatsCollector()
        collector.record_tool_use("Read")
        collector.record_tool_use("Edit")
        collector.record_file_change()
        collector.record_task(1, 1, 1000, 0.05)

        stats = collector.get_stats()

        assert "tools_usage" in stats
        assert "files_changed" in stats
        assert "task_stats" in stats

    def test_reset_stats(self):
        """测试重置统计"""
        collector = StatsCollector()
        collector.record_tool_use("Read")
        collector.reset()

        assert collector.tools_usage["Read"] == 0
```

---

## 3. 集成测试

### 3.1 工具统计 API 测试

```python
class TestStatsEndpoint:
    """工具统计 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    def test_get_stats_success(self, client):
        """测试获取统计成功"""
        response = client.get("/api/claude/stats")

        assert response.status_code == 200
        data = response.json()

        # 验证结构
        assert "tools_usage" in data
        assert "files_changed" in data
        assert "task_stats" in data

    def test_tools_usage_structure(self, client):
        """测试工具使用统计结构"""
        response = client.get("/api/claude/stats")
        data = response.json()

        tools = data["tools_usage"]
        expected_tools = ["Read", "Write", "Edit", "Bash", "Glob", "Grep", "WebSearch", "WebFetch", "Task"]

        for tool in expected_tools:
            assert tool in tools, f"缺少工具: {tool}"
            assert isinstance(tools[tool], int), f"{tool} 应该是整数"

    def test_task_stats_structure(self, client):
        """测试任务统计结构"""
        response = client.get("/api/claude/stats")
        data = response.json()

        task_stats = data["task_stats"]
        required_fields = ["total", "success", "failed", "avg_duration_ms", "total_cost_usd"]

        for field in required_fields:
            assert field in task_stats, f"缺少字段: {field}"
```

### 3.2 权限模式 API 测试

```python
class TestPermissionModesEndpoint:
    """权限模式 API 测试"""

    def test_get_permission_modes_success(self, client):
        """测试获取权限模式成功"""
        response = client.get("/api/claude/permission-modes")

        assert response.status_code == 200
        data = response.json()

        assert "modes" in data
        assert len(data["modes"]) == 4

    def test_all_modes_present(self, client):
        """测试所有模式都存在"""
        response = client.get("/api/claude/permission-modes")
        data = response.json()

        mode_names = [mode["name"] for mode in data["modes"]]
        expected_names = ["default", "acceptEdits", "plan", "bypassPermissions"]

        for name in expected_names:
            assert name in mode_names, f"缺少模式: {name}"

    def test_mode_descriptions(self, client):
        """测试模式描述"""
        response = client.get("/api/claude/permission-modes")
        data = response.json()

        for mode in data["modes"]:
            assert "name" in mode
            assert "description" in mode
            assert "scenarios" in mode
            assert isinstance(mode["scenarios"], list)
            assert len(mode["scenarios"]) > 0
```

### 3.3 可用工具列表 API 测试

```python
class TestToolsEndpoint:
    """可用工具列表 API 测试"""

    def test_get_tools_success(self, client):
        """测试获取工具列表成功"""
        response = client.get("/api/tools")

        assert response.status_code == 200
        data = response.json()

        assert "tools" in data

    def test_all_core_tools_present(self, client):
        """测试所有核心工具都存在"""
        response = client.get("/api/tools")
        data = response.json()

        tool_names = [tool["name"] for tool in data["tools"]]
        expected_tools = ["Read", "Write", "Edit", "Bash", "Glob", "Grep", "WebSearch", "WebFetch", "Task"]

        for tool in expected_tools:
            assert tool in tool_names, f"缺少工具: {tool}"

    def test_tool_info_structure(self, client):
        """测试工具信息结构"""
        response = client.get("/api/tools")
        data = response.json()

        for tool in data["tools"]:
            assert "name" in tool
            assert "description" in tool or "category" in tool
```

---

## 4. 统计准确性测试

### 4.1 工具使用统计准确性

```python
class TestStatsAccuracy:
    """统计准确性测试"""

    @pytest.mark.asyncio
    async def test_tool_use_recorded(self):
        """测试工具使用被正确记录"""
        from app.claude_runner import ClaudeCodeClient
        from app.claude.stats import StatsCollector

        # 重置统计
        stats_collector = StatsCollector()
        stats_collector.reset()

        # 执行任务
        client = ClaudeCodeClient()
        await client._track_tool_use("Read", {"file_path": "/test.py"})
        await client._track_tool_use("Edit", {"file_path": "/test.py"})

        # 验证统计
        assert stats_collector.tools_usage["Read"] >= 1

    def test_file_change_count(self):
        """测试文件变更计数"""
        stats_collector = StatsCollector()
        stats_collector.record_file_change()
        stats_collector.record_file_change()
        stats_collector.record_file_change()

        assert stats_collector.files_changed == 3
```

---

## 5. E2E 测试

```python
# tests/e2e/test_tools_stats.py

class TestToolsStatsPageE2E:
    """工具统计页面 E2E 测试"""

    def test_stats_page_loads(self, page: Page):
        """测试统计页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=工具统计")

        expect(page.locator("h1")).to_contain_text("工具统计")

    def test_tools_usage_displayed(self, page: Page):
        """测试工具使用统计显示"""
        page.goto("http://127.0.0.1:8000/claude/stats")

        # 验证工具使用显示
        expect(page.locator(".tools-usage")).to_be_visible()

    def test_permission_modes_displayed(self, page: Page):
        """测试权限模式显示"""
        page.goto("http://127.0.0.1:8000/claude/stats")

        # 验证四种模式都显示
        expect(page.locator("text=default")).to_be_visible()
        expect(page.locator("text=acceptEdits")).to_be_visible()
        expect(page.locator("text=plan")).to_be_visible()
        expect(page.locator("text=bypassPermissions")).to_be_visible()
```

---

## 6. 运行测试

```bash
# 运行工具统计相关测试
uv run pytest tests/ -k "stats or tools or permission" -v

# 运行统计收集器测试
uv run pytest tests/test_stats.py -v
```

---

## 7. 验收标准

- [ ] 工具使用统计 API 返回正确格式
- [ ] 任务统计包含所有必要字段
- [ ] 权限模式说明包含四种模式
- [ ] 权限模式描述和适用场景完整
- [ ] 可用工具列表包含9个核心工具
- [ ] UI 正确显示所有统计信息
- [ ] 统计准确性验证通过
