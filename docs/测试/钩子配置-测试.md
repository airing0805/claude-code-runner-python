# 钩子配置 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证钩子配置 API 的功能完整性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 钩子列表 | 获取所有钩子 |
| 钩子类型说明 | 5种类型 |
| 钩子配置 | 添加/编辑/删除 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_hooks.py

from app.hooks.schemas import Hook, HookConfig

class TestHookConfig:
    """钩子配置模型测试"""

    def test_hook_config_creation(self):
        """测试钩子配置创建"""
        config = HookConfig(
            tools=["Bash", "Write"],
            action="block",
            notification=False
        )
        assert config.tools == ["Bash", "Write"]
        assert config.action == "block"

    def test_default_values(self):
        """测试默认值"""
        config = HookConfig()
        assert config.tools == []
        assert config.action == "allow"
        assert config.notification is False


class TestHook:
    """钩子模型测试"""

    def test_hook_creation(self):
        """测试钩子创建"""
        hook = Hook(
            id="hook_abc123",
            name="安全检查",
            type="PreToolUse",
            enabled=True,
            config=HookConfig(
                tools=["Bash", "Write"],
                action="block"
            )
        )
        assert hook.id == "hook_abc123"
        assert hook.name == "安全检查"
        assert hook.type == "PreToolUse"

    def test_all_hook_types(self):
        """测试所有钩子类型"""
        valid_types = ["PreToolUse", "PostToolUse", "Stop", "SessionStart", "Notification"]

        for hook_type in valid_types:
            hook = Hook(
                id=f"hook_{hook_type}",
                name=f"Test {hook_type}",
                type=hook_type,
                enabled=True,
                config=HookConfig()
            )
            assert hook.type == hook_type


class TestHookTypes:
    """钩子类型说明测试"""

    def test_hook_types_response(self):
        """测试类型说明响应"""
        data = {
            "hook_types": [
                {"name": "PreToolUse", "description": "工具执行前触发"},
                {"name": "PostToolUse", "description": "工具执行后触发"},
                {"name": "Stop", "description": "会话结束时触发"},
                {"name": "SessionStart", "description": "会话开始时触发"},
                {"name": "Notification", "description": "通知事件触发"}
            ]
        }
        assert len(data["hook_types"]) == 5
```

---

## 3. 集成测试

### 3.1 钩子列表 API 测试

```python
class TestHooksEndpoint:
    """钩子 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    @pytest.fixture
    def mock_hook_manager(self):
        """Mock 钩子管理器"""
        with patch("app.routers.claude.HookManager") as mock:
            mock_instance = MagicMock()
            mock_instance.get_hooks.return_value = [
                Hook(
                    id="hook_1",
                    name="安全检查",
                    type="PreToolUse",
                    enabled=True,
                    config=HookConfig(tools=["Bash"], action="block")
                )
            ]
            mock.return_value = mock_instance
            yield mock_instance

    def test_get_hooks_success(self, client, mock_hook_manager):
        """测试获取钩子列表成功"""
        response = client.get("/api/claude/hooks")

        assert response.status_code == 200
        data = response.json()
        assert "hooks" in data

    def test_hooks_structure(self, client, mock_hook_manager):
        """测试钩子列表结构"""
        response = client.get("/api/claude/hooks")
        data = response.json()

        hook = data["hooks"][0]
        required_fields = ["id", "name", "type", "enabled", "config"]

        for field in required_fields:
            assert field in hook
```

### 3.2 钩子类型说明 API 测试

```python
class TestHookTypesEndpoint:
    """钩子类型说明 API 测试"""

    def test_get_hook_types_success(self, client):
        """测试获取钩子类型说明成功"""
        response = client.get("/api/claude/hooks/types")

        assert response.status_code == 200
        data = response.json()
        assert "hook_types" in data

    def test_all_hook_types_present(self, client):
        """测试所有钩子类型都存在"""
        response = client.get("/api/claude/hooks/types")
        data = response.json()

        type_names = [t["name"] for t in data["hook_types"]]
        expected = ["PreToolUse", "PostToolUse", "Stop", "SessionStart", "Notification"]

        for hook_type in expected:
            assert hook_type in type_names, f"缺少类型: {hook_type}"

    def test_hook_type_descriptions(self, client):
        """测试类型描述不为空"""
        response = client.get("/api/claude/hooks/types")
        data = response.json()

        for hook_type in data["hook_types"]:
            assert "description" in hook_type
            assert len(hook_type["description"]) > 0
```

### 3.3 钩子配置更新测试

```python
class TestUpdateHooks:
    """钩子配置更新测试"""

    def test_update_hooks(self, client, mock_hook_manager):
        """测试更新钩子配置"""
        response = client.put("/api/claude/hooks", json={
            "hooks": [
                {
                    "name": "新钩子",
                    "type": "PreToolUse",
                    "enabled": True,
                    "config": {"tools": ["Bash"], "action": "allow"}
                }
            ]
        })

        assert response.status_code in [200, 404]

    def test_add_new_hook(self, client, mock_hook_manager):
        """测试添加新钩子"""
        response = client.put("/api/claude/hooks", json={
            "hooks": [
                {
                    "name": "测试钩子",
                    "type": "PostToolUse",
                    "enabled": True,
                    "config": {}
                }
            ]
        })

        assert response.status_code in [200, 404]

    def test_remove_hook(self, client, mock_hook_manager):
        """测试删除钩子"""
        # 发送空列表
        response = client.put("/api/claude/hooks", json={
            "hooks": []
        })

        assert response.status_code in [200, 404]
```

---

## 4. 钩子管理器测试

```python
class TestHookManager:
    """钩子管理器测试"""

    def test_load_hooks(self, tmp_path):
        """测试加载钩子"""
        from app.hooks.manager import HookManager

        config_file = tmp_path / "settings.json"
        config_file.write_text(json.dumps({
            "hooks": [
                {"name": "test", "type": "PreToolUse", "enabled": True}
            ]
        }))

        manager = HookManager(config_path=config_file)
        hooks = manager.get_hooks()

        assert isinstance(hooks, list)

    def test_save_hooks(self, tmp_path):
        """测试保存钩子"""
        from app.hooks.manager import HookManager

        config_file = tmp_path / "settings.json"
        manager = HookManager(config_path=config_file)

        hooks = [
            Hook(
                id="hook_1",
                name="Test",
                type="PreToolUse",
                enabled=True,
                config=HookConfig()
            )
        ]

        manager.save_hooks(hooks)
        assert config_file.exists()
```

---

## 5. E2E 测试

```python
# tests/e2e/test_hooks.py

class TestHooksPageE2E:
    """钩子配置页面 E2E 测试"""

    def test_hooks_page_loads(self, page: Page):
        """测试页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=钩子配置")

        expect(page.locator("h1")).to_contain_text("钩子")

    def test_hook_types_displayed(self, page: Page):
        """测试钩子类型说明显示"""
        page.goto("http://127.0.0.1:8000/hooks")

        expect(page.locator("text=PreToolUse")).to_be_visible()
        expect(page.locator("text=PostToolUse")).to_be_visible()

    def test_add_hook(self, page: Page):
        """测试添加钩子"""
        page.goto("http://127.0.0.1:8000/hooks")

        page.click("text=添加钩子")
        # 验证表单
```

---

## 6. 运行测试

```bash
# 运行钩子相关测试
uv run pytest tests/ -k "hook" -v
```

---

## 7. 验收标准

- [ ] 钩子列表 API 正常工作
- [ ] 钩子类型说明 API 正常工作
- [ ] 钩子配置更新 API 正常工作
- [ ] 支持添加新钩子
- [ ] 支持编辑钩子
- [ ] 支持删除钩子
- [ ] UI 正确显示所有功能
