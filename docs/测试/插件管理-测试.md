# 插件管理 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证插件管理 API 的功能完整性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 插件列表 | 获取所有插件 |
| 插件详情 | 查看详细信息 |
| 启用/禁用 | 状态切换 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_plugins.py

from app.plugins.schemas import Plugin

class TestPlugin:
    """插件模型测试"""

    def test_plugin_creation(self):
        """测试插件创建"""
        plugin = Plugin(
            id="plugin-code-review",
            name="Code Review",
            description="自动代码审查插件",
            version="1.0.0",
            author="Claude Team",
            is_enabled=True,
            is_builtin=True
        )
        assert plugin.id == "plugin-code-review"
        assert plugin.name == "Code Review"
        assert plugin.is_enabled is True

    def test_plugin_defaults(self):
        """测试默认值"""
        plugin = Plugin(
            id="test",
            name="Test",
            description="Test",
            version="1.0.0",
            author="Test",
            is_enabled=False,
            is_builtin=False
        )
        assert plugin.is_builtin is False


class TestPluginsDoc:
    """插件列表文档测试"""

    def test_plugins_list(self):
        """测试插件列表结构"""
        data = {
            "plugins": [
                {
                    "id": "plugin-1",
                    "name": "Plugin 1",
                    "description": "Test"
                }
            ]
        }
        assert "plugins" in data
        assert len(data["plugins"]) == 1
```

---

## 3. 集成测试

### 3.1 插件列表 API 测试

```python
class TestPluginsEndpoint:
    """插件 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    @pytest.fixture
    def mock_plugin_manager(self):
        """Mock 插件管理器"""
        with patch("app.routers.claude.PluginManager") as mock:
            mock_instance = MagicMock()
            mock_instance.get_plugins.return_value = [
                Plugin(
                    id="plugin-code-review",
                    name="Code Review",
                    description="自动代码审查",
                    version="1.0.0",
                    author="Claude Team",
                    is_enabled=True,
                    is_builtin=True
                )
            ]
            mock.return_value = mock_instance
            yield mock_instance

    def test_get_plugins_success(self, client, mock_plugin_manager):
        """测试获取插件列表成功"""
        response = client.get("/api/claude/plugins")

        assert response.status_code == 200
        data = response.json()
        assert "plugins" in data

    def test_plugins_structure(self, client, mock_plugin_manager):
        """测试插件列表结构"""
        response = client.get("/api/claude/plugins")
        data = response.json()

        plugin = data["plugins"][0]
        required_fields = ["id", "name", "description", "version", "author", "is_enabled", "is_builtin"]

        for field in required_fields:
            assert field in plugin, f"缺少字段: {field}"
```

### 3.2 插件详情 API 测试

```python
class TestPluginDetail:
    """插件详情测试"""

    def test_get_plugin_detail(self, client, mock_plugin_manager):
        """测试获取详情"""
        response = client.get("/api/claude/plugins/plugin-code-review")

        assert response.status_code in [200, 404]

    def test_get_nonexistent_plugin(self, client, mock_plugin_manager):
        """测试获取不存在的插件"""
        mock_plugin_manager.get_plugin.return_value = None

        response = client.get("/api/claude/plugins/nonexistent")

        assert response.status_code == 404
```

### 3.3 启用/禁用插件测试

```python
class TestPluginEnableDisable:
    """启用/禁用插件测试"""

    def test_enable_plugin(self, client, mock_plugin_manager):
        """测试启用插件"""
        response = client.post("/api/claude/plugins/plugin-code-review/enable")

        assert response.status_code in [200, 404]
        mock_plugin_manager.enable_plugin.assert_called_once()

    def test_disable_plugin(self, client, mock_plugin_manager):
        """测试禁用插件"""
        response = client.post("/api/claude/plugins/plugin-code-review/disable")

        assert response.status_code in [200, 404]
        mock_plugin_manager.disable_plugin.assert_called_once()

    def test_enable_nonexistent_plugin(self, client, mock_plugin_manager):
        """测试启用不存在的插件"""
        mock_plugin_manager.enable_plugin.side_effect = ValueError("Plugin not found")

        response = client.post("/api/claude/plugins/nonexistent/enable")

        assert response.status_code == 404
```

---

## 4. 插件管理器测试

```python
class TestPluginManager:
    """插件管理器测试"""

    def test_load_plugins(self, tmp_path):
        """测试加载插件"""
        from app.plugins.manager import PluginManager

        plugins_dir = tmp_path / "plugins"
        plugins_dir.mkdir()

        # 创建插件文件
        plugin_file = plugins_dir / "test-plugin.json"
        plugin_file.write_text(json.dumps({
            "id": "test-plugin",
            "name": "Test Plugin"
        }))

        manager = PluginManager(plugins_dir=plugins_dir)
        plugins = manager.get_plugins()

        assert len(plugins) >= 0

    def test_enable_plugin(self):
        """测试启用插件"""
        from app.plugins.manager import PluginManager

        manager = PluginManager()
        # 测试启用逻辑
        # ...

    def test_disable_plugin(self):
        """测试禁用插件"""
        manager = PluginManager()
        # 测试禁用逻辑
        # ...
```

---

## 5. E2E 测试

```python
# tests/e2e/test_plugins.py

class TestPluginsPageE2E:
    """插件管理页面 E2E 测试"""

    def test_plugins_page_loads(self, page: Page):
        """测试页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=插件管理")

        expect(page.locator("h1")).to_contain_text("插件")

    def test_plugin_list_displayed(self, page: Page):
        """测试插件列表显示"""
        page.goto("http://127.0.0.1:8000/plugins")

        expect(page.locator(".plugin-list")).to_be_visible()

    def test_disable_plugin(self, page: Page):
        """测试禁用插件"""
        page.goto("http://127.0.0.1:8000/plugins")

        page.click("text=禁用")
        # 验证状态变化
```

---

## 6. 运行测试

```bash
# 运行插件相关测试
uv run pytest tests/ -k "plugin" -v
```

---

## 7. 验收标准

- [ ] 插件列表 API 正常工作
- [ ] 插件详情 API 正常工作
- [ ] 启用插件 API 正常工作
- [ ] 禁用插件 API 正常工作
- [ ] UI 正确显示所有功能
