# 项目管理 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证项目管理 API 的功能完整性和数据准确性。

> **注意**: 项目列表 API 测试与会话管理 API 完全共享，详见 [会话管理-测试.md](./会话管理-测试.md)。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 项目列表 | 获取所有项目、统计信息（与会话管理共享） |
| 项目编码 | 路径编码规则 |
| 项目信息 | 详细信息查询 |

---

## 2. 单元测试

### 2.1 数据模型测试

```python
# tests/test_project.py

from app.project.schemas import Project, ProjectInfo

class TestProject:
    """项目模型测试"""

    def test_project_creation(self):
        """测试项目创建"""
        project = Project(
            encoded_name="E--workspaces-2026_python-project",
            path="E:\\workspaces\\2026_python\\project",
            session_count=5,
            tools=["Read", "Write", "Edit"]
        )
        assert project.encoded_name == "E--workspaces-2026_python-project"
        assert project.session_count == 5
        assert len(project.tools) == 3

    def test_project_default_values(self):
        """测试默认值"""
        project = Project(
            encoded_name="test",
            path="/test",
            session_count=0,
            tools=[]
        )
        assert project.session_count == 0
        assert project.tools == []


class TestProjectInfo:
    """项目详细信息测试"""

    def test_project_info_creation(self):
        """测试项目信息创建"""
        info = ProjectInfo(
            encoded_name="E--test",
            path="E:\\test",
            session_count=10,
            tools=["Read", "Write"],
            last_session_time="2026-02-19T10:00:00Z"
        )
        assert info.session_count == 10
        assert info.last_session_time is not None
```

### 2.2 项目编码测试

```python
class TestProjectEncoding:
    """项目编码测试"""

    def test_encode_backslash(self):
        """测试反斜杠编码"""
        from app.project.utils import encode_project_name

        assert encode_project_name("E:\\test") == "E--test"

    def test_encode_forward_slash(self):
        """测试正斜杠编码"""
        from app.project.utils import encode_project_name

        assert encode_project_name("E:/test") == "E--test"

    def test_encode_mixed_path(self):
        """测试混合路径编码"""
        from app.project.utils import encode_project_name

        result = encode_project_name("E:\\workspaces\\2026_python\\project")
        assert "\\\\" not in result
        assert result.count("-") >= 2

    def test_encode_space(self):
        """测试空格编码"""
        from app.project.utils import encode_project_name

        assert encode_project_name("E:\\my project") == "E--my-project"

    def test_encode_windows_path(self):
        """测试 Windows 路径编码"""
        from app.project.utils import encode_project_name

        result = encode_project_name("E:\\workspaces\\2026_python\\project")
        # 应该将 \ 转换为 -
        assert result == "E--workspaces--2026_python--project"

    def test_decode_project_name(self):
        """测试项目名称解码"""
        from app.project.utils import decode_project_name

        assert decode_project_name("E--test") == "E:\\test"
```

---

## 3. 集成测试

### 3.1 项目列表 API 测试

> 项目列表 API 测试与会话管理完全共享，详见 [会话管理-测试.md](./会话管理-测试.md) 第 3.1 节。
                    session_count=5,
                    tools=["Read", "Write", "Edit"]
                )
            ]
            mock.return_value = mock_instance
            yield mock_instance

    def test_get_projects_success(self, client, mock_project_manager):
        """测试获取项目列表成功"""
        response = client.get("/api/projects")

        assert response.status_code == 200
        data = response.json()
        assert "projects" in data

    def test_projects_structure(self, client, mock_project_manager):
        """测试项目列表结构"""
        response = client.get("/api/projects")
        data = response.json()

        project = data["projects"][0]
        required_fields = ["encoded_name", "path", "session_count", "tools"]

        for field in required_fields:
            assert field in project, f"缺少字段: {field}"

    def test_session_count_type(self, client, mock_project_manager):
        """测试会话数量为整数"""
        response = client.get("/api/projects")
        data = response.json()

        project = data["projects"][0]
        assert isinstance(project["session_count"], int)
        assert project["session_count"] >= 0

    def test_tools_is_list(self, client, mock_project_manager):
        """测试工具列表为数组"""
        response = client.get("/api/projects")
        data = response.json()

        project = data["projects"][0]
        assert isinstance(project["tools"], list)

    def test_empty_projects(self, client, mock_project_manager):
        """测试空项目列表"""
        mock_project_manager.get_projects.return_value = []

        response = client.get("/api/projects")

        assert response.status_code == 200
        data = response.json()
        assert data["projects"] == []
```

### 3.2 项目详情 API 测试

```python
class TestProjectDetailEndpoint:
    """项目详情 API 测试"""

    def test_get_project_detail(self, client, mock_project_manager):
        """测试获取项目详情"""
        response = client.get("/api/projects/E--test")

        assert response.status_code in [200, 404]

    def test_get_nonexistent_project(self, client, mock_project_manager):
        """测试获取不存在的项目"""
        mock_project_manager.get_project.return_value = None

        response = client.get("/api/projects/nonexistent")

        assert response.status_code == 404
```

### 3.3 项目会话 API 测试

```python
class TestProjectSessionsEndpoint:
    """项目会话 API 测试"""

    def test_get_project_sessions(self, client, mock_project_manager):
        """测试获取项目会话"""
        response = client.get("/api/projects/E--test/sessions")

        assert response.status_code in [200, 404]

    def test_sessions_structure(self, client, mock_project_manager):
        """测试会话列表结构"""
        response = client.get("/api/projects/E--test/sessions")

        if response.status_code == 200:
            data = response.json()
            assert "sessions" in data
```

---

## 4. 项目管理器测试

```python
class TestProjectManager:
    """项目管理器测试"""

    def test_get_projects(self):
        """测试获取项目列表"""
        from app.project.manager import ProjectManager

        manager = ProjectManager()
        projects = manager.get_projects()

        assert isinstance(projects, list)

    def test_get_project_by_name(self):
        """测试按名称获取项目"""
        from app.project.manager import ProjectManager

        manager = ProjectManager()
        project = manager.get_project("E--test")

        # 可能返回 None 或 Project 对象
        assert project is None or isinstance(project, Project)

    def test_add_project(self):
        """测试添加项目"""
        from app.project.manager import ProjectManager

        manager = ProjectManager()
        # 测试添加逻辑
        # ...

    def test_remove_project(self):
        """测试移除项目"""
        from app.project.manager import ProjectManager

        manager = ProjectManager()
        # 测试移除逻辑
        # ...
```

---

## 5. 编码规则测试

```python
class TestEncodingRules:
    """编码规则测试"""

    def test_windows_drive_letter_preserved(self):
        """测试 Windows 盘符保留"""
        from app.project.utils import encode_project_name

        result = encode_project_name("E:\\project")
        # E: 应该保留
        assert result.startswith("E:")

    def test_multiple_backslashes(self):
        """测试多个反斜杠"""
        from app.project.utils import encode_project_name

        result = encode_project_name("E:\\a\\b\\c")
        # 所有 \ 都应该转换为 -
        assert "\\\\" not in result
        assert result.count("-") == 3

    def test_underscore_preserved(self):
        """测试下划线保留"""
        from app.project.utils import encode_project_name

        result = encode_project_name("E:\\my_project\\test")
        # 下划线应该保留
        assert "my_project" in result

    def test_special_chars_handled(self):
        """测试特殊字符处理"""
        from app.project.utils import encode_project_name

        # 测试各种特殊字符
        result = encode_project_name("E:\\project-v1.0\\test")
        assert isinstance(result, str)
```

---

## 6. E2E 测试

```python
# tests/e2e/test_project.py

class TestProjectPageE2E:
    """项目管理页面 E2E 测试"""

    def test_projects_page_loads(self, page: Page):
        """测试项目页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=项目管理")

        expect(page.locator("h1")).to_contain_text("项目")

    def test_project_list_displayed(self, page: Page):
        """测试项目列表显示"""
        page.goto("http://127.0.0.1:8000/projects")

        expect(page.locator(".project-list")).to_be_visible()

    def test_project_info(self, page: Page):
        """测试项目信息显示"""
        page.goto("http://127.0.0.1:8000/projects")

        # 验证显示项目路径、会话数量、工具列表
        expect(page.locator(".project-path")).to_be_visible()

    def test_click_project_navigation(self, page: Page):
        """测试点击项目跳转"""
        page.goto("http://127.0.0.1:8000/projects")

        # 点击项目进入详情
        page.click(".project-item:first-child")

        expect(page.locator(".session-list")).to_be_visible()
```

---

## 7. 运行测试

```bash
# 运行项目相关测试
uv run pytest tests/ -k "project" -v

# 运行编码测试
uv run pytest tests/test_project.py::TestProjectEncoding -v

# 运行项目 API 测试
uv run pytest tests/test_project.py::TestProjectsEndpoint -v
```

---

## 8. 验收标准

- [ ] 项目列表 API 正常工作
- [ ] 项目详情 API 正常工作
- [ ] 项目会话 API 正常工作
- [ ] 路径编码规则正确实施
- [ ] Windows 盘符正确保留
- [ ] 会话数量统计准确
- [ ] 工具列表汇总正确
- [ ] 错误响应格式统一
- [ ] UI 正确显示项目列表
- [ ] UI 支持项目点击跳转
