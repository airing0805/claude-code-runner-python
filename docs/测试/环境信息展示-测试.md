# 环境信息展示 - 测试文档

## 1. 测试策略

### 1.1 测试目标

验证环境信息展示 API 的功能完整性和安全性。

### 1.2 测试范围

| 模块 | 测试内容 |
|------|---------|
| 版本信息 API | 返回正确的版本数据格式 |
| 环境变量 API | 敏感信息隐藏、仅返回相关变量 |
| 配置信息 API | 返回正确的配置数据 |

---

## 2. 单元测试

### 2.1 敏感信息隐藏函数测试

```python
# tests/test_claude_env.py

from app.claude.utils import mask_sensitive_value, SENSITIVE_KEYS

class TestSensitiveValueMasking:
    """敏感信息隐藏测试"""

    def test_mask_api_key(self):
        """测试 API Key 隐藏"""
        assert mask_sensitive_value("ANTHROPIC_API_KEY", "sk-xxx") == "***"
        assert mask_sensitive_value("api_key", "secret") == "***"
        assert mask_sensitive_value("APIKEY", "token") == "***"

    def test_mask_token(self):
        """测试 Token 隐藏"""
        assert mask_sensitive_value("TOKEN", "abc123") == "***"
        assert mask_sensitive_value("GITHUB_TOKEN", "ghp_xxx") == "***"

    def test_mask_password(self):
        """测试密码隐藏"""
        assert mask_sensitive_value("PASSWORD", "mypassword") == "***"
        assert mask_sensitive_value("DB_PASSWORD", "dbpass") == "***"

    def test_mask_secret(self):
        """测试 Secret 隐藏"""
        assert mask_sensitive_value("SECRET_KEY", "secret") == "***"
        assert mask_sensitive_value("PRIVATE_KEY", "key") == "***"

    def test_no_mask_regular_values(self):
        """测试普通变量不隐藏"""
        assert mask_sensitive_value("WORKING_DIR", "/home/user") == "/home/user"
        assert mask_sensitive_value("PORT", "8000") == "8000"
        assert mask_sensitive_value("DEBUG", "true") == "true"

    def test_case_insensitive(self):
        """测试大小写不敏感"""
        assert mask_sensitive_value("anthropic_api_key", "key") == "***"
        assert mask_sensitive_value("Api_Key", "key") == "***"
```

### 2.2 数据模型测试

```python
from app.claude.schemas import VersionInfo, EnvInfo, ConfigInfo, RuntimeInfo

class TestVersionInfo:
    """版本信息模型测试"""

    def test_valid_version_info(self):
        """测试有效版本信息"""
        info = VersionInfo(
            cli_version="1.0.12",
            sdk_version="0.0.25",
            runtime=RuntimeInfo(
                os="Windows",
                os_version="11",
                python_version="3.12.0"
            )
        )
        assert info.cli_version == "1.0.12"
        assert info.sdk_version == "0.0.25"

    def test_version_info_from_dict(self):
        """测试从字典创建"""
        data = {
            "cli_version": "1.0.12",
            "sdk_version": "0.0.25",
            "runtime": {
                "os": "Windows",
                "os_version": "11",
                "python_version": "3.12.0"
            }
        }
        info = VersionInfo(**data)
        assert info.runtime.os == "Windows"


class TestEnvInfo:
    """环境变量模型测试"""

    def test_env_info_with_masked_values(self):
        """测试包含隐藏值的环境变量"""
        info = EnvInfo(
            variables={
                "ANTHROPIC_API_KEY": "***",
                "WORKING_DIR": "/test",
                "PORT": "8000"
            }
        )
        assert info.variables["ANTHROPIC_API_KEY"] == "***"
        assert info.variables["WORKING_DIR"] == "/test"


class TestConfigInfo:
    """配置信息模型测试"""

    def test_config_info(self):
        """测试配置信息"""
        info = ConfigInfo(
            working_dir="/test/path",
            default_permission_mode="acceptEdits",
            allowed_tools=["Read", "Write", "Edit"]
        )
        assert info.working_dir == "/test/path"
        assert len(info.allowed_tools) == 3
```

---

## 3. 集成测试

### 3.1 版本信息 API 测试

```python
class TestVersionEndpoint:
    """版本信息 API 测试"""

    @pytest.fixture
    def client(self):
        from fastapi.testclient import TestClient
        from app.main import app
        return TestClient(app)

    def test_get_version_success(self, client):
        """测试获取版本成功"""
        response = client.get("/api/claude/version")

        assert response.status_code == 200
        data = response.json()

        # 验证必要字段
        assert "cli_version" in data
        assert "sdk_version" in data
        assert "runtime" in data

        # 验证 runtime 字段
        assert "os" in data["runtime"]
        assert "os_version" in data["runtime"]
        assert "python_version" in data["runtime"]

    def test_version_response_format(self, client):
        """测试版本响应格式"""
        response = client.get("/api/claude/version")
        data = response.json()

        # 验证字段类型
        assert isinstance(data["cli_version"], str)
        assert isinstance(data["sdk_version"], str)
        assert isinstance(data["runtime"], dict)
```

### 3.2 环境变量 API 测试

```python
class TestEnvEndpoint:
    """环境变量 API 测试"""

    def test_get_env_success(self, client):
        """测试获取环境变量成功"""
        response = client.get("/api/claude/env")

        assert response.status_code == 200
        data = response.json()
        assert "variables" in data

    def test_api_key_is_masked(self, client):
        """测试 API Key 被隐藏"""
        response = client.get("/api/claude/env")
        data = response.json()

        # 验证 API Key 被隐藏
        if "ANTHROPIC_API_KEY" in data["variables"]:
            assert data["variables"]["ANTHROPIC_API_KEY"] == "***"

    def test_no_sensitive_data_exposed(self, client):
        """测试没有敏感数据泄露"""
        response = client.get("/api/claude/env")
        data = response.json()

        # 验证不包含明文敏感信息
        variables = data.get("variables", {})
        for key, value in variables.items():
            if "KEY" in key.upper() or "TOKEN" in key.upper():
                assert value == "***", f"敏感变量 {key} 未被隐藏"
            if "PASSWORD" in key.upper() or "SECRET" in key.upper():
                assert value == "***", f"敏感变量 {key} 未被隐藏"

    def test_only_relevant_variables(self, client):
        """测试只返回相关变量"""
        response = client.get("/api/claude/env")
        data = response.json()

        variables = data.get("variables", {})
        # 验证包含 Claude Code 相关变量
        relevant_keys = ["WORKING_DIR", "CLAUDECODE", "PORT"]
        # 应该包含至少一个相关变量，或者返回空
        assert isinstance(variables, dict)
```

### 3.3 配置信息 API 测试

```python
class TestConfigEndpoint:
    """配置信息 API 测试"""

    def test_get_config_success(self, client):
        """测试获取配置成功"""
        response = client.get("/api/claude/config")

        assert response.status_code == 200
        data = response.json()

        # 验证必要字段
        assert "working_dir" in data
        assert "default_permission_mode" in data
        assert "allowed_tools" in data

    def test_allowed_tools_is_list(self, client):
        """测试 allowed_tools 是列表"""
        response = client.get("/api/claude/config")
        data = response.json()

        assert isinstance(data["allowed_tools"], list)
        # 验证包含常用工具
        expected_tools = ["Read", "Write", "Edit", "Bash"]
        for tool in expected_tools:
            assert tool in data["allowed_tools"]

    def test_permission_mode_valid(self, client):
        """测试权限模式有效"""
        response = client.get("/api/claude/config")
        data = response.json()

        valid_modes = ["default", "acceptEdits", "plan", "bypassPermissions"]
        assert data["default_permission_mode"] in valid_modes
```

---

## 4. E2E 测试

```python
# tests/e2e/test_claude_status.py

class TestClaudeStatusPageE2E:
    """Claude 状态页面 E2E 测试"""

    def test_status_page_loads(self, page: Page):
        """测试状态页面加载"""
        page.goto("http://127.0.0.1:8000/")
        page.click("text=Claude 状态")

        expect(page.locator("h1")).to_contain_text("Claude 状态")

    def test_version_info_displayed(self, page: Page):
        """测试版本信息显示"""
        page.goto("http://127.0.0.1:8000/claude/status")

        # 验证版本信息显示
        expect(page.locator(".version-info")).to_be_visible()
        expect(page.locator(".cli-version")).to_be_visible()

    def test_env_variables_displayed(self, page: Page):
        """测试环境变量显示"""
        page.goto("http://127.0.0.1:8000/claude/status")

        # 验证环境变量显示
        expect(page.locator(".env-variables")).to_be_visible()

    def test_sensitive_data_masked_in_ui(self, page: Page):
        """测试 UI 中敏感数据被隐藏"""
        page.goto("http://127.0.0.1:8000/claude/status")

        # 验证 API Key 显示为 ***
        api_key_element = page.locator(".env-variables")
        if api_key_element:
            assert "***" in api_key_element.text_content()
```

---

## 5. 安全测试

### 5.1 敏感信息泄露测试

```python
class TestSecurity:
    """安全测试"""

    def test_no_plain_text_credentials(self, client):
        """测试没有明文凭证"""
        response = client.get("/api/claude/env")
        data = response.json()

        variables = json.dumps(data)

        # 验证不包含常见 API Key 模式
        import re
        patterns = [
            r"sk-ant-api[03]-\w+",  # Anthropic API Key
            r"ghp_\w+",             # GitHub Token
            r"sk-\w+",              # OpenAI Key
        ]

        for pattern in patterns:
            matches = re.findall(pattern, variables, re.IGNORECASE)
            assert len(matches) == 0, f"发现可能的 API Key: {matches}"

    def test_unauthorized_access_denied(self, client):
        """测试未授权访问被拒绝"""
        # 如果实现了认证，测试未登录访问
        pass
```

---

## 6. 性能测试

```python
class TestPerformance:
    """性能测试"""

    def test_response_time(self, client):
        """测试响应时间 < 100ms"""
        import time

        start = time.time()
        response = client.get("/api/claude/version")
        duration = time.time() - start

        assert response.status_code == 200
        assert duration < 0.1  # 100ms
```

---

## 7. 运行测试

```bash
# 运行环境信息展示相关测试
uv run pytest tests/ -k "claude" -v

# 运行敏感信息隐藏测试
uv run pytest tests/test_claude_env.py -v

# 运行 API 测试
uv run pytest tests/ -k "env or version or config" -v
```

---

## 8. 验收标准

- [ ] 版本信息 API 返回正确格式
- [ ] 环境变量 API 正确隐藏敏感信息
- [ ] 配置信息 API 返回完整配置
- [ ] UI 正确显示所有信息
- [ ] 安全测试通过 - 无明文敏感数据
- [ ] 性能测试通过 - 响应时间 < 100ms
